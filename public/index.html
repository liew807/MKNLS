<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç«™æºç æŸ¥çœ‹å™¨ - å®Œæ•´ç‰ˆ</title>
    <style>
        /* åŸºç¡€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* å¤´éƒ¨ */
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            padding: 30px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        /* è¾“å…¥åŒºåŸŸ */
        .input-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        #urlInput {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1rem;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            transition: all 0.3s;
        }
        
        #urlInput:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }
        
        .btn-primary {
            padding: 15px 30px;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary:hover {
            background: #1d4ed8;
            transform: translateY(-2px);
        }
        
        .example-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .example-btn {
            padding: 8px 16px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .example-btn:hover {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }
        
        /* çŠ¶æ€æ˜¾ç¤º */
        #status {
            margin-top: 15px;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
        }
        
        .status.idle {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .status.loading {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        
        /* ä¿¡æ¯æ  */
        .info-bar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .info-item {
            display: flex;
            flex-direction: column;
        }
        
        .info-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        /* æ ‡ç­¾é¡µ */
        .tabs {
            display: flex;
            background: white;
            border-radius: 12px 12px 0 0;
            overflow: hidden;
        }
        
        .tab-btn {
            flex: 1;
            padding: 20px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            color: #4b5563;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab-btn:hover {
            background: #f9fafb;
        }
        
        .tab-btn.active {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            background: linear-gradient(to bottom, rgba(37, 99, 235, 0.05), transparent);
        }
        
        /* å†…å®¹åŒºåŸŸ */
        .tab-content {
            display: none;
            background: white;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
            margin-bottom: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* HTMLä»£ç åŒºåŸŸ */
        #htmlTab {
            padding: 0;
        }
        
        .code-header {
            background: #1e1e1e;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .code-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 16px;
            background: #333;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .btn-small:hover {
            background: #444;
        }
        
        #htmlCode {
            width: 100%;
            min-height: 600px;
            padding: 25px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: #1e1e1e;
            color: #d4d4d4;
            border: none;
            outline: none;
            resize: vertical;
            white-space: pre;
            overflow-x: auto;
        }
        
        /* èµ„æºåˆ—è¡¨ */
        #resourcesTab {
            padding: 25px;
        }
        
        .resource-section {
            margin-bottom: 30px;
        }
        
        .resource-section h3 {
            margin-bottom: 15px;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .resource-list {
            list-style: none;
        }
        
        .resource-item {
            padding: 15px;
            margin-bottom: 10px;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #2563eb;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .resource-type {
            font-size: 1.5rem;
        }
        
        .resource-info {
            flex: 1;
        }
        
        .resource-url {
            font-family: monospace;
            font-size: 0.9rem;
            color: #2563eb;
            word-break: break-all;
            margin-bottom: 5px;
        }
        
        .resource-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-view, .btn-download {
            padding: 6px 12px;
            font-size: 0.85rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-view {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .btn-view:hover {
            background: #bfdbfe;
        }
        
        .btn-download {
            background: #dcfce7;
            color: #166534;
        }
        
        .btn-download:hover {
            background: #bbf7d0;
        }
        
        /* é¢„è§ˆåŒºåŸŸ */
        #previewFrame {
            width: 100%;
            height: 700px;
            border: none;
            background: white;
        }
        
        /* é”™è¯¯å®¹å™¨ */
        .error-container {
            padding: 30px;
            background: #fef2f2;
            border: 1px solid #fecaca;
            border-radius: 12px;
            color: #991b1b;
        }
        
        .error-container h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .btn-test {
            margin-top: 20px;
            padding: 10px 20px;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            width: 90%;
            max-width: 1200px;
            height: 80vh;
            border-radius: 12px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            background: #1e1e1e;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #modalContent {
            flex: 1;
            padding: 25px;
            overflow: auto;
            background: #f8f9fa;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .input-group {
                flex-direction: column;
            }
            
            .info-bar {
                flex-direction: column;
                gap: 15px;
            }
            
            .tab-btn {
                padding: 15px 10px;
                font-size: 0.9rem;
            }
            
            #htmlCode {
                padding: 15px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å¤´éƒ¨ -->
        <header class="header">
            <h1>ğŸŒ ç½‘ç«™æºç æŸ¥çœ‹å™¨</h1>
            <p class="subtitle">æŸ¥çœ‹ä»»ä½•ç½‘ç«™çš„HTMLã€CSSã€JavaScriptæºä»£ç </p>
        </header>
        
        <!-- è¾“å…¥åŒºåŸŸ -->
        <div class="input-section">
            <div class="input-group">
                <input 
                    type="url" 
                    id="urlInput" 
                    placeholder="è¾“å…¥ç½‘ç«™URLï¼Œä¾‹å¦‚ï¼šhttps://jbc518.onrender.com"
                    value="https://jbc518.onrender.com"
                >
                <button id="fetchBtn" class="btn-primary">è·å–æºç </button>
            </div>
            <div class="example-buttons">
                <small>ç¤ºä¾‹ç½‘ç«™ï¼š</small>
                <button class="example-btn" data-url="https://jbc518.onrender.com">jbc518.onrender.com</button>
                <button class="example-btn" data-url="https://google.com">Google</button>
                <button class="example-btn" data-url="https://github.com">GitHub</button>
            </div>
            <div id="status" class="status idle">å°±ç»ªï¼Œè¾“å…¥URLå¹¶ç‚¹å‡»"è·å–æºç "</div>
        </div>
        
        <!-- ä¿¡æ¯æ  -->
        <div class="info-bar" id="infoBar" style="display: none;">
            <div class="info-item">
                <div class="info-label">ç›®æ ‡ç½‘ç«™</div>
                <div class="info-value" id="currentUrl">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">çŠ¶æ€ç </div>
                <div class="info-value" id="statusCode">-</div>
            </div>
            <div class="info-item">
                <div class="info-label">æ–‡ä»¶å¤§å°</div>
                <div class="info-value" id="contentSize">-</div>
            </div>
        </div>
        
        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="html">HTMLæºç </button>
            <button class="tab-btn" data-tab="resources">èµ„æºæ–‡ä»¶</button>
            <button class="tab-btn" data-tab="preview">é¡µé¢é¢„è§ˆ</button>
        </div>
        
        <!-- HTMLæºç æ ‡ç­¾é¡µ -->
        <div id="htmlTab" class="tab-content active">
            <div class="code-header">
                <h3>HTML æºä»£ç </h3>
                <div class="code-actions">
                    <button id="copyBtn" class="btn-small">å¤åˆ¶ä»£ç </button>
                    <button id="formatBtn" class="btn-small">æ ¼å¼åŒ–</button>
                </div>
            </div>
            <pre><code id="htmlCode">// ç‚¹å‡»"è·å–æºç "æŒ‰é’®æŸ¥çœ‹HTMLä»£ç </code></pre>
        </div>
        
        <!-- èµ„æºæ–‡ä»¶æ ‡ç­¾é¡µ -->
        <div id="resourcesTab" class="tab-content">
            <div class="resource-section">
                <h3><span>ğŸ“œ</span> JavaScript æ–‡ä»¶</h3>
                <ul id="scriptsList" class="resource-list"></ul>
            </div>
            <div class="resource-section">
                <h3><span>ğŸ¨</span> CSS æ ·å¼è¡¨</h3>
                <ul id="stylesList" class="resource-list"></ul>
            </div>
            <div class="resource-section">
                <h3><span>ğŸ–¼ï¸</span> å›¾ç‰‡èµ„æº</h3>
                <ul id="imagesList" class="resource-list"></ul>
            </div>
        </div>
        
        <!-- é¡µé¢é¢„è§ˆæ ‡ç­¾é¡µ -->
        <div id="previewTab" class="tab-content">
            <iframe 
                id="previewFrame" 
                sandbox="allow-same-origin allow-scripts"
                title="ç½‘ç«™é¢„è§ˆ"
            ></iframe>
        </div>
    </div>
    
    <!-- èµ„æºæŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">èµ„æºå†…å®¹</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>
    
    <script>
        class WebsiteViewer {
            constructor() {
                this.currentUrl = '';
                this.currentData = null;
                this.baseUrl = '';
                this.init();
            }
            
            init() {
                this.bindEvents();
            }
            
            bindEvents() {
                // è·å–æºç æŒ‰é’®
                document.getElementById('fetchBtn').addEventListener('click', () => this.fetchSource());
                
                // URLè¾“å…¥æ¡†å›è½¦äº‹ä»¶
                document.getElementById('urlInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.fetchSource();
                });
                
                // ç¤ºä¾‹æŒ‰é’®
                document.querySelectorAll('.example-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const url = e.target.dataset.url || e.target.textContent;
                        document.getElementById('urlInput').value = url;
                        this.fetchSource();
                    });
                });
                
                // æ ‡ç­¾é¡µåˆ‡æ¢
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const tabName = e.target.dataset.tab;
                        this.switchTab(tabName);
                    });
                });
                
                // ä»£ç æ“ä½œæŒ‰é’®
                document.getElementById('copyBtn')?.addEventListener('click', () => this.copyCode());
                document.getElementById('formatBtn')?.addEventListener('click', () => this.formatCode());
                
                // å…³é—­æ¨¡æ€æ¡†
                document.querySelector('.close-modal')?.addEventListener('click', () => {
                    document.getElementById('resourceModal').style.display = 'none';
                });
                
                // ç‚¹å‡»æ¨¡æ€æ¡†èƒŒæ™¯å…³é—­
                document.getElementById('resourceModal')?.addEventListener('click', (e) => {
                    if (e.target === document.getElementById('resourceModal')) {
                        e.target.style.display = 'none';
                    }
                });
            }
            
            async fetchSource() {
                const input = document.getElementById('urlInput');
                let url = input.value.trim();
                
                if (!url) {
                    this.showError('è¯·è¾“å…¥URLåœ°å€');
                    return;
                }
                
                // æ¸…ç†URL
                url = this.cleanUrl(url);
                this.currentUrl = url;
                this.baseUrl = url;
                
                this.showLoading(`æ­£åœ¨è·å–: ${url}`);
                
                try {
                    const response = await fetch(`/api/fetch-source?url=${encodeURIComponent(url)}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.currentData = data;
                    this.displayResults(data);
                    this.showSuccess(`è·å–æˆåŠŸ (${data.statusCode})`);
                    
                } catch (error) {
                    console.error('è·å–å¤±è´¥:', error);
                    this.showError(`è·å–å¤±è´¥: ${error.message}`);
                    this.displayError(url, error);
                }
            }
            
            cleanUrl(url) {
                // ç§»é™¤æœ«å°¾çš„æ–œæ 
                url = url.replace(/\/$/, '');
                
                // å¦‚æœæ²¡æœ‰åè®®ï¼Œæ·»åŠ https://
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }
                
                return url;
            }
            
            displayResults(data) {
                // æ˜¾ç¤ºä¿¡æ¯æ 
                document.getElementById('infoBar').style.display = 'flex';
                
                // æ›´æ–°URLæ˜¾ç¤º
                document.getElementById('currentUrl').textContent = data.url;
                document.getElementById('statusCode').textContent = data.statusCode;
                document.getElementById('contentSize').textContent = this.formatSize(data.contentLength || data.html?.length || 0);
                
                // æ˜¾ç¤ºHTML
                this.displayHtml(data.html);
                
                // æ˜¾ç¤ºèµ„æº
                if (data.resources) {
                    this.displayResources(data.resources);
                }
                
                // æ˜¾ç¤ºé¢„è§ˆ
                this.displayPreview(data.html, data.url);
            }
            
            displayHtml(html) {
                const htmlCode = document.getElementById('htmlCode');
                
                if (!html) {
                    htmlCode.textContent = '// æ²¡æœ‰è·å–åˆ°HTMLå†…å®¹';
                    return;
                }
                
                // ç®€å•çš„HTMLè½¬ä¹‰å’Œæ ¼å¼åŒ–
                const escapedHtml = html
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                // åº”ç”¨è¯­æ³•é«˜äº®
                htmlCode.innerHTML = this.syntaxHighlight(escapedHtml);
            }
            
            syntaxHighlight(html) {
                // ç®€å•çš„è¯­æ³•é«˜äº®
                return html
                    .replace(/(&lt;\/?[a-z][a-z0-9]*)/gi, '<span class="tag">$1</span>')
                    .replace(/([a-z-]+)=/gi, '<span class="attr">$1</span>=')
                    .replace(/&quot;(.*?)&quot;/gi, '<span class="string">&quot;$1&quot;</span>')
                    .replace(/&lt;!--(.*?)--&gt;/gi, '<span class="comment">&lt;!--$1--&gt;</span>');
            }
            
            displayResources(resources) {
                const scriptsList = document.getElementById('scriptsList');
                const stylesList = document.getElementById('stylesList');
                const imagesList = document.getElementById('imagesList');
                
                // æ¸…ç©ºåˆ—è¡¨
                scriptsList.innerHTML = '';
                stylesList.innerHTML = '';
                imagesList.innerHTML = '';
                
                // æ˜¾ç¤ºè„šæœ¬
                if (resources.scripts && resources.scripts.length > 0) {
                    resources.scripts.forEach(script => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="resource-item">
                                <span class="resource-type">ğŸ“œ</span>
                                <div class="resource-info">
                                    <div class="resource-url" title="${script.src}">${this.truncateUrl(script.src)}</div>
                                    <div class="resource-actions">
                                        <button onclick="viewer.viewResource('${this.escapeHtml(script.src)}', '${this.escapeHtml(this.baseUrl)}', 'js')" 
                                                class="btn-view">
                                            æŸ¥çœ‹
                                        </button>
                                        <button onclick="viewer.downloadResource('${this.escapeHtml(script.src)}', '${this.escapeHtml(this.baseUrl)}')" 
                                                class="btn-download">
                                            ä¸‹è½½
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        scriptsList.appendChild(li);
                    });
                } else {
                    scriptsList.innerHTML = '<li class="resource-item">æ²¡æœ‰æ‰¾åˆ°JavaScriptæ–‡ä»¶</li>';
                }
                
                // æ˜¾ç¤ºæ ·å¼è¡¨
                if (resources.stylesheets && resources.stylesheets.length > 0) {
                    resources.stylesheets.forEach(style => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="resource-item">
                                <span class="resource-type">ğŸ¨</span>
                                <div class="resource-info">
                                    <div class="resource-url" title="${style.href}">${this.truncateUrl(style.href)}</div>
                                    <div class="resource-actions">
                                        <button onclick="viewer.viewResource('${this.escapeHtml(style.href)}', '${this.escapeHtml(this.baseUrl)}', 'css')" 
                                                class="btn-view">
                                            æŸ¥çœ‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        stylesList.appendChild(li);
                    });
                } else {
                    stylesList.innerHTML = '<li class="resource-item">æ²¡æœ‰æ‰¾åˆ°CSSæ–‡ä»¶</li>';
                }
                
                // æ˜¾ç¤ºå›¾ç‰‡
                if (resources.images && resources.images.length > 0) {
                    resources.images.forEach(img => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div class="resource-item">
                                <span class="resource-type">ğŸ–¼ï¸</span>
                                <div class="resource-info">
                                    <div class="resource-url" title="${img.src}">${this.truncateUrl(img.src)}</div>
                                    ${img.alt ? `<div class="resource-alt">${img.alt}</div>` : ''}
                                    <div class="resource-actions">
                                        <button onclick="viewer.viewImage('${this.escapeHtml(img.src)}', '${this.escapeHtml(this.baseUrl)}')" 
                                                class="btn-view">
                                            æŸ¥çœ‹
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                        imagesList.appendChild(li);
                    });
                } else {
                    imagesList.innerHTML = '<li class="resource-item">æ²¡æœ‰æ‰¾åˆ°å›¾ç‰‡æ–‡ä»¶</li>';
                }
            }
            
            async viewResource(url, baseUrl, type = 'js') {
                try {
                    this.showLoading(`æ­£åœ¨è·å–èµ„æº: ${this.truncateUrl(url)}`);
                    
                    const response = await fetch(`/api/get-resource-text?url=${encodeURIComponent(url)}&baseUrl=${encodeURIComponent(baseUrl)}`);
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    this.showResourceModal(url, data.content, type);
                    this.showSuccess('èµ„æºè·å–æˆåŠŸ');
                    
                } catch (error) {
                    console.error('è·å–èµ„æºå¤±è´¥:', error);
                    this.showError(`æ— æ³•è·å–èµ„æº: ${error.message}`);
                    
                    // å°è¯•ç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€
                    window.open(url, '_blank');
                }
            }
            
            viewImage(url, baseUrl) {
                // å›¾ç‰‡ç›´æ¥åœ¨æ–°çª—å£æ‰“å¼€
                window.open(url, '_blank');
            }
            
            async downloadResource(url, baseUrl) {
                try {
                    // åˆ›å»ºä¸‹è½½é“¾æ¥
                    const downloadUrl = `/api/get-resource?url=${encodeURIComponent(url)}&baseUrl=${encodeURIComponent(baseUrl)}`;
                    
                    // è·å–æ–‡ä»¶å
                    const filename = url.split('/').pop() || 'download';
                    
                    // åˆ›å»ºä¸´æ—¶é“¾æ¥å¹¶ç‚¹å‡»
                    const a = document.createElement('a');
                    a.href = downloadUrl;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    
                    this.showSuccess('å¼€å§‹ä¸‹è½½');
                    
                } catch (error) {
                    this.showError('ä¸‹è½½å¤±è´¥: ' + error.message);
                }
            }
            
            showResourceModal(url, content, type) {
                const modal = document.getElementById('resourceModal');
                const title = document.getElementById('modalTitle');
                const contentEl = document.getElementById('modalContent');
                
                title.textContent = `èµ„æºå†…å®¹: ${this.truncateUrl(url, 50)}`;
                
                // æ ¹æ®ç±»å‹æ ¼å¼åŒ–å†…å®¹
                let formattedContent;
                if (type === 'js') {
                    formattedContent = `<pre><code class="language-javascript">${this.escapeHtml(content)}</code></pre>`;
                } else if (type === 'css') {
                    formattedContent = `<pre><code class="language-css">${this.escapeHtml(content)}</code></pre>`;
                } else {
                    formattedContent = `<pre>${this.escapeHtml(content)}</pre>`;
                }
                
                contentEl.innerHTML = formattedContent;
                modal.style.display = 'flex';
            }
            
            displayPreview(html, baseUrl) {
                const previewFrame = document.getElementById('previewFrame');
                
                if (!html || !baseUrl) {
                    previewFrame.srcdoc = '<h3 style="padding: 20px; color: #666;">æ— æ³•ç”Ÿæˆé¢„è§ˆ</h3>';
                    return;
                }
                
                // åˆ›å»ºåŒ…å«åŸºç¡€URLçš„å®Œæ•´HTML
                const fullHtml = `
                    <!DOCTYPE html>
                    <html>
                        <head>
                            <base href="${baseUrl}">
                            <meta charset="UTF-8">
                            <meta name="viewport" content="width=device-width, initial-scale=1.0">
                            <style>
                                body { 
                                    margin: 20px; 
                                    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                                    line-height: 1.6;
                                }
                                img { max-width: 100%; height: auto; }
                                * { max-width: 100%; }
                            </style>
                        </head>
                        <body>${html}</body>
                    </html>
                `;
                
                previewFrame.srcdoc = fullHtml;
            }
            
            displayError(url, error) {
                const htmlCode = document.getElementById('htmlCode');
                const errorHtml = `
                    <div class="error-container">
                        <h3>âŒ è·å–ç½‘ç«™æºç å¤±è´¥</h3>
                        <p><strong>URL:</strong> ${this.escapeHtml(url)}</p>
                        <p><strong>é”™è¯¯ä¿¡æ¯:</strong> ${this.escapeHtml(error.message)}</p>
                        <hr>
                        <h4>å¯èƒ½çš„åŸå› ï¼š</h4>
                        <ul>
                            <li>ç½‘ç«™URLå¯èƒ½ä¸æ­£ç¡®</li>
                            <li>ç½‘ç«™å¯èƒ½æš‚æ—¶ä¸å¯è®¿é—®</li>
                            <li>ç½‘ç«™å¯èƒ½å±è”½äº†æˆ‘ä»¬çš„è¯·æ±‚</li>
                            <li>æ‚¨çš„ç½‘ç»œè¿æ¥å¯èƒ½æœ‰é—®é¢˜</li>
                        </ul>
                        <h4>å°è¯•ä»¥ä¸‹æ–¹æ³•ï¼š</h4>
                        <ul>
                            <li>æ£€æŸ¥URLæ˜¯å¦æ­£ç¡®</li>
                            <li>å°è¯•è®¿é—®å…¶ä»–ç½‘ç«™</li>
                            <li>ç­‰å¾…ä¸€ä¼šå„¿å†è¯•</li>
                            <li>æ£€æŸ¥æ§åˆ¶å°è·å–æ›´å¤šä¿¡æ¯</li>
                        </ul>
                    </div>
                `;
                htmlCode.innerHTML = errorHtml;
            }
            
            switchTab(tabName) {
                // æ›´æ–°æ ‡ç­¾é¡µæŒ‰é’®
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.tab === tabName) {
                        btn.classList.add('active');
                    }
                });
                
                // æ˜¾ç¤ºå¯¹åº”å†…å®¹
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `${tabName}Tab`) {
                        content.classList.add('active');
                    }
                });
            }
            
            copyCode() {
                const code = document.getElementById('htmlCode').textContent;
                navigator.clipboard.writeText(code)
                    .then(() => this.showSuccess('ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'))
                    .catch(() => this.showError('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶'));
            }
            
            formatCode() {
                // ç®€å•çš„æ ¼å¼åŒ–ï¼šæ·»åŠ æ¢è¡Œå’Œç¼©è¿›
                const codeElement = document.getElementById('htmlCode');
                let code = codeElement.textContent;
                
                // åŸºæœ¬çš„HTMLæ ¼å¼åŒ–
                code = code
                    .replace(/></g, '>\n<')
                    .replace(/\n\s*\n/g, '\n')
                    .replace(/^\s*/gm, '');
                
                codeElement.textContent = code;
                this.showSuccess('ä»£ç å·²æ ¼å¼åŒ–');
            }
            
            // å·¥å…·å‡½æ•°
            truncateUrl(url, maxLength = 60) {
                if (!url) return '';
                if (url.length <= maxLength) return url;
                return url.substring(0, maxLength) + '...';
            }
            
            escapeHtml(text) {
                if (!text) return '';
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
            
            formatSize(bytes) {
                if (!bytes) return '0 B';
                if (bytes < 1024) return bytes + ' B';
                if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
            }
            
            showLoading(message) {
                const statusEl = document.getElementById('status');
                statusEl.className = 'status loading';
                statusEl.innerHTML = `â³ ${message}`;
            }
            
            showSuccess(message) {
                const statusEl = document.getElementById('status');
                statusEl.className = 'status success';
                statusEl.innerHTML = `âœ… ${message}`;
            }
            
            showError(message) {
                const statusEl = document.getElementById('status');
                statusEl.className = 'status error';
                statusEl.innerHTML = `âŒ ${message}`;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            window.viewer = new WebsiteViewer();
            
            // æµ‹è¯•æœåŠ¡å™¨è¿æ¥
            fetch('/api/health')
                .then(response => response.json())
                .then(data => {
                    console.log('æœåŠ¡å™¨çŠ¶æ€:', data);
                })
                .catch(error => {
                    console.error('æœåŠ¡å™¨è¿æ¥å¤±è´¥:', error);
                    window.viewer.showError('æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨');
                });
        });
    </script>
</body>
</html>
