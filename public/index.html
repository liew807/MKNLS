<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MKNLSå¼ºæ”»å·¥å…·3.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
    }

    :root {
        --ios-blue: #007AFF;
        --ios-gray-1: #8E8E93;
        --ios-gray-2: #AEAEB2;
        --ios-gray-3: #C7C7CC;
        --ios-gray-4: #D1D1D6;
        --ios-gray-5: #E5E5EA;
        --ios-gray-6: #F2F2F7;
        --ios-red: #FF3B30;
        --ios-orange: #FF9500;
        --ios-green: #34C759;
        --ios-teal: #5AC8FA;
        --ios-purple: #AF52DE;
        --ios-pink: #FF2D55;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 50%, #0c0c0c 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 16px;
        color: #FFFFFF;
    }

    .ios-glass-card {
        width: 100%;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.08);
        backdrop-filter: blur(20px) saturate(180%);
        -webkit-backdrop-filter: blur(20px) saturate(180%);
        border-radius: 24px;
        border: 1px solid rgba(255, 255, 255, 0.15);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        padding: 24px 20px;
        margin-bottom: 20px;
    }

    .ios-title {
        text-align: center;
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 24px;
        letter-spacing: -0.5px;
        background: linear-gradient(45deg, #FF9500, #FF2D55, #AF52DE, #007AFF);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 300% 300%;
        animation: gradientShift 5s ease infinite;
    }

    @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    .language-selector {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .language-dropdown {
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 8px 12px;
        color: #1D1D1F;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        backdrop-filter: blur(10px);
        min-width: 120px;
    }

    .tg-channel-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        width: 100%;
        padding: 14px;
        margin-bottom: 16px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, #0088cc, #34AADF);
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
    }

    .tg-channel-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 136, 204, 0.4);
    }

    .test-card-badge {
        background: linear-gradient(135deg, #FF9500, #FF2D55);
        color: white;
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        display: inline-block;
        margin-left: 8px;
    }

    .blinking-expiry {
        animation: blink 2s infinite;
        font-weight: bold;
        text-align: center;
        padding: 8px;
        border-radius: 8px;
        margin: 10px 0;
        background: linear-gradient(45deg, #FF0000, #FF9500, #FFFF00, #34C759, #007AFF, #AF52DE);
        background-size: 400% 400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }

    .ios-status {
        text-align: center;
        padding: 12px 16px;
        border-radius: 12px;
        margin-bottom: 16px;
        font-weight: 500;
        font-size: 15px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    .ios-status.error {
        background: rgba(255, 59, 48, 0.2);
        color: #FF3B30;
        border: 1px solid rgba(255, 59, 48, 0.3);
    }

    .ios-status.success {
        background: rgba(52, 199, 89, 0.2);
        color: #34C759;
        border: 1px solid rgba(52, 199, 89, 0.3);
    }

    .ios-status.admin {
        background: rgba(255, 149, 0, 0.2);
        color: #FF9500;
        border: 1px solid rgba(255, 149, 0, 0.3);
    }

    .ios-status.super-admin {
        background: rgba(175, 82, 222, 0.2);
        color: #AF52DE;
        border: 1px solid rgba(175, 82, 222, 0.3);
    }

    .ios-status.test-card {
        background: rgba(255, 45, 85, 0.2);
        color: #FF2D55;
        border: 1px solid rgba(255, 45, 85, 0.3);
    }

    .ios-input {
        width: 100%;
        padding: 16px;
        margin-bottom: 12px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.1);
        font-size: 17px;
        transition: all 0.3s ease;
        outline: none;
        color: #FFFFFF;
    }

    .ios-input:focus {
        border-color: var(--ios-blue);
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
    }

    .ios-input::placeholder {
        color: rgba(255, 255, 255, 0.6);
    }

    .ios-button {
        width: 100%;
        padding: 16px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, var(--ios-blue), #5AC8FA);
        color: white;
        font-size: 17px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 8px;
        position: relative;
    }

    .ios-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 122, 255, 0.4);
    }

    .ios-button:active {
        transform: translateY(0);
    }

    .ios-button.secondary {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
    }

    .ios-button.destructive {
        background: linear-gradient(135deg, var(--ios-red), #FF7A70);
    }

    .ios-button.success {
        background: linear-gradient(135deg, var(--ios-green), #6FCF97);
    }

    .ios-button.test-card {
        background: linear-gradient(135deg, #FF9500, #FF2D55);
    }

    .ios-button:disabled {
        background: var(--ios-gray-4);
        color: var(--ios-gray-2);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    .ios-nav-buttons {
        display: flex;
        gap: 8px;
        margin: 16px 0;
    }

    .ios-nav-buttons button {
        flex: 1;
        padding: 12px;
        font-size: 15px;
    }

    .ios-expiry {
        text-align: center;
        margin: 16px 0;
        color: white;
        font-size: 15px;
        line-height: 1.4;
        background: rgba(255, 255, 255, 0.1);
        padding: 12px;
        border-radius: 12px;
    }

    .ios-bind-info {
        text-align: center;
        margin: 12px 0;
        color: white;
        font-size: 15px;
        font-weight: 500;
        background: rgba(255, 149, 0, 0.3);
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(255, 149, 0, 0.5);
    }

    .ios-admin-panel {
        border-top: 1px solid rgba(255, 255, 255, 0.3);
        padding-top: 20px;
        margin-top: 20px;
    }

    .ios-admin-title {
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        color: white;
        margin-bottom: 16px;
        background: linear-gradient(45deg, #FF9500, #AF52DE);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .admin-level-badge {
        background: linear-gradient(135deg, #AF52DE, #007AFF);
        color: white;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 8px;
    }

    .test-card-option {
        display: flex;
        align-items: center;
        margin-bottom: 12px;
        padding: 12px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .test-card-option input[type="checkbox"] {
        margin-right: 12px;
        transform: scale(1.2);
    }

    .test-card-option label {
        color: white;
        font-weight: 500;
        flex: 1;
    }

    .test-card-info {
        font-size: 13px;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 4px;
    }

    .key-category {
        margin-bottom: 12px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 12px;
        overflow: hidden;
    }

    .category-summary {
        padding: 16px;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
        cursor: pointer;
        font-weight: 600;
        font-size: 16px;
        color: #FFFFFF;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
    }

    .category-summary:hover {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
    }

    .key-count {
        background: var(--ios-blue);
        padding: 4px 8px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 500;
    }

    .ios-table-container {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 12px;
        overflow: hidden;
        margin-top: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .ios-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
        color: white;
    }

    .ios-table th {
        background: rgba(255, 255, 255, 0.1);
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        color: white;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .ios-table td {
        padding: 12px 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        word-break: break-all;
    }

    .ios-table tbody tr:last-child td {
        border-bottom: none;
    }

    .ios-action-group {
        display: flex;
        gap: 4px;
    }

    .ios-action-btn {
        padding: 6px 8px;
        border: none;
        border-radius: 6px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .ios-action-btn.copy {
        background: var(--ios-blue);
        color: white;
    }

    .ios-action-btn.delete {
        background: var(--ios-red);
        color: white;
    }

    .ios-action-btn.view {
        background: var(--ios-green);
        color: white;
    }

    .ios-log-container {
        width: 100%;
        max-width: 400px;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        padding: 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        max-height: 200px;
        overflow-y: auto;
    }

    .ios-log-title {
        color: white;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 12px;
        text-align: center;
        background: linear-gradient(45deg, #34C759, #5AC8FA);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .ios-log-item {
        font-size: 13px;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        line-height: 1.4;
        color: white;
    }

    .ios-log-item:last-child {
        border-bottom: none;
    }

    .log-success { color: #90EE90; }
    .log-error { color: #FFB6C1; }
    .log-info { color: #E6E6FA; }
    .log-warning { color: #FFA500; }

    .ios-hint {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 14px;
        margin-bottom: 16px;
        line-height: 1.4;
    }

    .ios-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
        z-index: 1000;
        align-items: center;
        justify-content: center;
    }

    .ios-modal-content {
        background: rgba(30, 30, 30, 0.95);
        border-radius: 20px;
        padding: 24px;
        max-width: 90%;
        max-height: 80%;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        color: #FFFFFF;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .ios-modal-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 16px;
        color: #FFFFFF;
        background: linear-gradient(45deg, #FF9500, #FF2D55);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .account-detail-item {
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
    }

    .account-detail-item:last-child {
        border-bottom: none;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #007AFF;
        animation: spin 1s ease-in-out infinite;
        margin-right: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
        body {
            padding: 12px 10px;
        }
        .ios-glass-card {
            padding: 14px 12px;
            max-width: 380px;
            border-radius: 16px;
            margin-bottom: 12px;
        }
        .ios-title {
            font-size: 20px;
            margin-bottom: 12px;
        }
        .ios-input {
            padding: 12px;
            font-size: 15px;
            margin-bottom: 10px;
        }
        .ios-button {
            padding: 12px;
            font-size: 15px;
        }
        .ios-nav-buttons {
            gap: 6px;
            margin: 10px 0;
        }
        .ios-log-container {
            max-width: 380px;
            padding: 12px;
        }
        .language-selector {
            position: relative;
            top: 0;
            right: 0;
            margin: 8px 0 6px 0;
            display: flex;
            justify-content: flex-end;
        }
        .language-dropdown {
            padding: 6px 8px;
            font-size: 13px;
            min-width: 100px;
            border-radius: 10px;
        }
        .ios-modal-content {
            padding: 16px;
        }
        .ios-table th, .ios-table td {
            padding: 8px 6px;
            font-size: 13px;
        }
    }
</style>
</head>
<body>

<div class="language-selector">
    <select id="languageSelect" class="language-dropdown" onchange="changeLanguage(this.value)">
        <option value="zh-CN">ä¸­æ–‡ç®€ä½“</option>
        <option value="zh-TW">ä¸­æ–‡ç¹é«”</option>
        <option value="en">English</option>
    </select>
</div>

<div class="ios-glass-card">
    <h1 class="ios-title" id="pageTitle">MKNLSå¼ºæ”»å·¥å…·3.0</h1>

    <a href="https://t.me/cpmMKNLS" class="tg-channel-btn" target="_blank">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.155c-.178-.079-.389-.049-.548.082-1.264 1.024-2.485 2.076-3.762 3.062-.593.459-1.188.915-1.768 1.389-.221.183-.444.363-.665.546-.214.176-.459.311-.717.4-.164.057-.339.085-.512.085-.173 0-.348-.028-.512-.085-.258-.089-.503-.224-.717-.4-.221-.183-.444-.363-.665-.546-1.277-.986-2.498-2.038-3.762-3.062-.159-.131-.37-.161-.548-.082-.177.079-.297.245-.297.435v7.441c0 .19.12.356.297.435.178.079.389.049.548-.082 1.264-1.024 2.485-2.076 3.762-3.062.593-.459 1.188-.915 1.768-1.389.221-.183.444-.363.665-.546.214-.176.459-.311.717-.4.164-.057.339-.085.512-.085.173 0 .348.028.512.085.258.089.503.224.717.4.221.183.444.363.665.546 1.277.986 2.498 2.038 3.762 3.062.159.131.37.161.548.082.177-.079.297-.245.297-.435V8.59c0-.19-.12-.356-.297-.435z"/>
        </svg>
        åŠ å…¥MKNLSé¢‘é“
    </a>

    <div class="ios-nav-buttons" id="navButtons" style="display: none;">
        <button class="ios-button secondary" onclick="handleReturnHome()" id="btnHome">ğŸ  é¦–é¡µ</button>
        <button class="ios-button secondary" onclick="handleSwitchAccount()" id="btnSwitchAccount">ğŸ”„ åˆ‡æ¢è´¦å·</button>
        <button class="ios-button secondary" onclick="handleSwitchKey()" id="btnSwitchKey">ğŸ”‘ åˆ‡æ¢ç§˜é’¥</button>
    </div>

    <button id="toggleAdminModeBtn" style="display: none;" class="ios-button" onclick="toggleAdminMode()" id="btnToggleAdmin">åˆ‡æ¢ç®¡ç†å‘˜æ¨¡å¼</button>
    
    <div id="statusMessage" class="ios-status">è¯·å…ˆè¾“å…¥ç§˜é’¥éªŒè¯</div>

    <div id="adminChoice" style="display: none;">
        <div class="ios-hint" id="adminChoiceHint">è¯·é€‰æ‹©æ‚¨è¦è¿›å…¥çš„æ¨¡å¼</div>
        <button class="ios-button" onclick="enterAdminPanel()" id="btnEnterAdmin">è¿›å…¥ç®¡ç†å‘˜é¢æ¿</button>
        <button class="ios-button secondary" onclick="enterUserPanel()" id="btnEnterUser">è¿›å…¥ç”¨æˆ·åŠŸèƒ½</button>
    </div>

    <div id="keyForm">
        <div class="ios-hint" id="keyHint">ç§˜é’¥è¯· Facebookæœç´¢GH Treeè·å–</div>
        <input type="text" id="accessKey" class="ios-input" placeholder="è¾“å…¥è®¿é—®ç§˜é’¥" maxlength="15">
        <div id="bindInfo" class="ios-bind-info" style="display: none;"></div>
        <button class="ios-button" onclick="handleCheckKey()" id="btnCheckKey">
            <span id="checkKeyText">éªŒè¯ç§˜é’¥</span>
        </button>
    </div>

    <div id="loginForm" style="display: none;">
        <div id="expiryDisplay" class="ios-expiry"></div>
        <input type="email" id="email" class="ios-input" placeholder="è¾“å…¥æ‚¨çš„é‚®ç®±">
        <input type="password" id="password" class="ios-input" placeholder="è¾“å…¥æ‚¨çš„å¯†ç ">
        <button class="ios-button" onclick="handleLogin()" id="btnLogin">
            <span id="loginText">ç™»å½•</span>
        </button>
    </div>

    <div id="menuButtons" style="display: none;">
        <button class="ios-button" onclick="handleKingRank()" id="btnKingRank">ä¸€é”®ä¿®æ”¹ä¸ºå›½ç‹ç­‰çº§</button>
        <button class="ios-button secondary" id="btnChangeEmail" onclick="handleChangeEmail()">ä¿®æ”¹é‚®ç®±</button>
        <button class="ios-button secondary" id="btnChangePassword" onclick="handleChangePassword()">ä¿®æ”¹å¯†ç </button>
    </div>
    
    <div id="adminPanel" class="ios-admin-panel" style="display: none;">
        <h4 class="ios-admin-title" id="adminTitle">
            ğŸ”‘ ç§˜é’¥ç®¡ç†ä¸­å¿ƒ ğŸ”‘
            <span id="adminLevelBadge" class="admin-level-badge"></span>
        </h4>

        <div class="add-key-form">
            <div class="test-card-option" id="testCardOption">
                <input type="checkbox" id="isTestCard" onchange="toggleTestCardOptions()">
                <label for="isTestCard">
                    <div id="testCardLabel">ç”Ÿæˆæµ‹è¯•å¡</div>
                    <div class="test-card-info" id="testCardInfo">1å°æ—¶æœ‰æ•ˆæœŸï¼Œä»…é™1ä¸ªè´¦å·ï¼Œä»…æ”¯æŒè§£é”æˆå°±åŠŸèƒ½</div>
                </label>
            </div>

            <div id="normalKeyOptions">
                <input type="number" id="newKeyDuration" class="ios-input" placeholder="ç§˜é’¥æ—¶é•¿ (å°æ—¶)" value="24" min="1">
                <input type="number" id="newKeyMaxBind" class="ios-input" placeholder="æœ€å¤§ç»‘å®šæ•°é‡" value="3" min="1">
            </div>
            
            <input type="text" id="newKeyRemark" class="ios-input" placeholder="å¤‡æ³¨ (å¦‚: æœˆå¡/æµ‹è¯•å¡)">
            <button class="ios-button success" onclick="handleAddKey()" id="btnAddKey">
                <span id="addKeyText">â• ç”Ÿæˆæ–°ç§˜é’¥</span>
            </button>
        </div>

        <div class="ios-nav-buttons">
            <button class="ios-button secondary" onclick="fetchKeys()" id="btnRefresh">ğŸ”„ åˆ·æ–°åˆ—è¡¨</button>
            <button class="ios-button" onclick="handleCleanupExpiredKeys()" id="btnCleanup">ğŸ—‘ï¸ æ¸…ç†è¿‡æœŸ</button>
        </div>

        <div class="ios-table-container">
            <details class="key-category" id="tgCategory">
                <summary class="category-summary">
                    <span>ğŸ¤– TGæœºå™¨äººç”Ÿæˆçš„ç§˜é’¥</span>
                    <span class="key-count" id="tgKeyCount">(0)</span>
                </summary>
                <table class="ios-table">
                    <thead>
                        <tr>
                            <th>ç§˜é’¥</th>
                            <th>TGç”¨æˆ·</th>
                            <th>å¿«æ‰‹æš—å·</th>
                            <th>åˆ°æœŸæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="tgKeysTableBody"></tbody>
                </table>
            </details>

            <details class="key-category" id="superAdminCategory">
                <summary class="category-summary">
                    <span>ğŸ‘‘ è¶…çº§ç®¡ç†äººç”Ÿæˆçš„ç§˜é’¥</span>
                    <span class="key-count" id="superAdminKeyCount">(0)</span>
                </summary>
                <table class="ios-table">
                    <thead>
                        <tr>
                            <th>ç§˜é’¥</th>
                            <th>å¤‡æ³¨</th>
                            <th>åˆ°æœŸæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="superAdminKeysTableBody"></tbody>
                </table>
            </details>

            <div id="normalAdminCategories"></div>
        </div>
    </div>
</div>

<div class="ios-log-container">
    <div class="ios-log-title" id="logTitle">æ“ä½œæ—¥å¿—</div>
    <div id="logHistory">
        <div class="ios-log-item log-info" id="systemLoaded">ç³»ç»Ÿï¼šé¡µé¢åŠ è½½å®Œæ¯•ã€‚</div>
    </div>
</div>

<div id="accountModal" class="ios-modal">
    <div class="ios-modal-content">
        <h3 class="ios-modal-title" id="modalAccountTitle">è´¦å·è¯¦æƒ…</h3>
        <div id="accountDetails"></div>
        <button class="ios-button" onclick="closeAccountModal()" style="margin-top: 16px;" id="btnCloseModal">å…³é—­</button>
    </div>
</div>

<script>
    const API_BASE_URL = (() => {
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            return 'http://localhost:3000/api';
        }
        return '/api';
    })();

    const SUPER_ADMIN_KEY = 'cpmMKNLS';

    async function apiRequest(url, options = {}) {
        try {
            const fullUrl = url.startsWith('http') ? url : `${API_BASE_URL}${url}`;
            const response = await fetch(fullUrl, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers,
                }
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || 'è¯·æ±‚å¤±è´¥');
            }

            return await response.json();
            
        } catch (error) {
            throw error;
        }
    }

    const translations = {
        'zh-CN': {
            'pageTitle': 'MKNLSå¼ºæ”»å·¥å…·3.0',
            'keyHint': 'ç§˜é’¥Facebookæœç´¢GH Treeè·å–',
            'btnCheckKey': 'éªŒè¯ç§˜é’¥',
            'btnLogin': 'ç™»å½•',
            'btnKingRank': 'ä¸€é”®ä¿®æ”¹ä¸ºå›½ç‹ç­‰çº§',
            'btnChangeEmail': 'ä¿®æ”¹é‚®ç®±',
            'btnChangePassword': 'ä¿®æ”¹å¯†ç ',
            'btnToggleAdmin': 'åˆ‡æ¢ç®¡ç†å‘˜æ¨¡å¼',
            'btnHome': 'ğŸ  é¦–é¡µ',
            'btnSwitchAccount': 'ğŸ”„ åˆ‡æ¢è´¦å·',
            'btnSwitchKey': 'ğŸ”‘ åˆ‡æ¢ç§˜é’¥',
            'adminTitle': 'ğŸ”‘ ç§˜é’¥ç®¡ç†ä¸­å¿ƒ ğŸ”‘',
            'testCardLabel': 'ç”Ÿæˆæµ‹è¯•å¡',
            'testCardInfo': '1å°æ—¶æœ‰æ•ˆæœŸï¼Œä»…é™1ä¸ªè´¦å·ï¼Œä»…æ”¯æŒè§£é”æˆå°±åŠŸèƒ½',
            'btnAddKey': 'â• ç”Ÿæˆæ–°ç§˜é’¥',
            'btnRefresh': 'ğŸ”„ åˆ·æ–°åˆ—è¡¨',
            'btnCleanup': 'ğŸ—‘ï¸ æ¸…ç†è¿‡æœŸ',
            'thKey': 'ç§˜é’¥',
            'thRemark': 'å¤‡æ³¨',
            'thExpiry': 'åˆ°æœŸæ—¶é—´',
            'thAction': 'æ“ä½œ',
            'logTitle': 'æ“ä½œæ—¥å¿—',
            'systemLoaded': 'ç³»ç»Ÿï¼šé¡µé¢åŠ è½½å®Œæ¯•ã€‚',
            'modalAccountTitle': 'è´¦å·è¯¦æƒ…',
            'btnCloseModal': 'å…³é—­',
            'testCardBadge': 'æµ‹è¯•å¡',
            'testCardStatus': 'æµ‹è¯•å¡ç”¨æˆ·',
            'testCardEmailWarning': 'æµ‹è¯•å¡ä¸æ”¯æŒä¿®æ”¹é‚®ç®±åŠŸèƒ½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ä»˜è´¹ä½¿ç”¨å®Œæ•´åŠŸèƒ½ï¼',
            'testCardPasswordWarning': 'æµ‹è¯•å¡ä¸æ”¯æŒä¿®æ”¹å¯†ç åŠŸèƒ½ï¼Œè¯·è”ç³»ç®¡ç†å‘˜ä»˜è´¹ä½¿ç”¨å®Œæ•´åŠŸèƒ½ï¼',
            'superAdmin': 'è¶…çº§ç®¡ç†å‘˜',
            'normalAdmin': 'æ™®é€šç®¡ç†å‘˜',
            'adminChoiceHint': 'è¯·é€‰æ‹©æ‚¨è¦è¿›å…¥çš„æ¨¡å¼',
            'btnEnterAdmin': 'è¿›å…¥ç®¡ç†å‘˜é¢æ¿',
            'btnEnterUser': 'è¿›å…¥ç”¨æˆ·åŠŸèƒ½'
        },
        'zh-TW': {
            'pageTitle': 'MKNLSå¼·æ”»å·¥å…·3.0',
            'keyHint': 'ç§˜é‘°è«‹Facebookæœç´¢GH Treeç²å–',
            'btnCheckKey': 'é©—è­‰ç§˜é‘°',
            'btnLogin': 'ç™»éŒ„',
            'btnKingRank': 'ä¸€éµä¿®æ”¹ç‚ºåœ‹ç‹ç­‰ç´š',
            'btnChangeEmail': 'ä¿®æ”¹éƒµç®±',
            'btnChangePassword': 'ä¿®æ”¹å¯†ç¢¼',
            'btnToggleAdmin': 'åˆ‡æ›ç®¡ç†å“¡æ¨¡å¼',
            'btnHome': 'ğŸ  é¦–é ',
            'btnSwitchAccount': 'ğŸ”„ åˆ‡æ›è³¬è™Ÿ',
            'btnSwitchKey': 'ğŸ”‘ åˆ‡æ›ç§˜é‘°',
            'adminTitle': 'ğŸ”‘ ç§˜é‘°ç®¡ç†ä¸­å¿ƒ ğŸ”‘',
            'testCardLabel': 'ç”Ÿæˆæ¸¬è©¦å¡',
            'testCardInfo': '1å°æ™‚æœ‰æ•ˆæœŸï¼Œåƒ…é™1å€‹è³¬è™Ÿï¼Œåƒ…æ”¯æŒè§£é–æˆå°±åŠŸèƒ½',
            'btnAddKey': 'â• ç”Ÿæˆæ–°ç§˜é‘°',
            'btnRefresh': 'ğŸ”„ åˆ·æ–°åˆ—è¡¨',
            'btnCleanup': 'ğŸ—‘ï¸ æ¸…ç†éæœŸ',
            'thKey': 'ç§˜é‘°',
            'thRemark': 'å‚™è¨»',
            'thExpiry': 'åˆ°æœŸæ™‚é–“',
            'thAction': 'æ“ä½œ',
            'logTitle': 'æ“ä½œæ—¥èªŒ',
            'systemLoaded': 'ç³»çµ±ï¼šé é¢åŠ è¼‰å®Œç•¢ã€‚',
            'modalAccountTitle': 'è³¬è™Ÿè©³æƒ…',
            'btnCloseModal': 'é—œé–‰',
            'testCardBadge': 'æ¸¬è©¦å¡',
            'testCardStatus': 'æ¸¬è©¦å¡ç”¨æˆ¶',
            'testCardEmailWarning': 'æ¸¬è©¦å¡ä¸æ”¯æŒä¿®æ”¹éƒµç®±åŠŸèƒ½ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ä»˜è²»ä½¿ç”¨å®Œæ•´åŠŸèƒ½ï¼',
            'testCardPasswordWarning': 'æ¸¬è©¦å¡ä¸æ”¯æŒä¿®æ”¹å¯†ç¢¼åŠŸèƒ½ï¼Œè«‹è¯ç¹«ç®¡ç†å“¡ä»˜è²»ä½¿ç”¨å®Œæ•´åŠŸèƒ½ï¼',
            'superAdmin': 'è¶…ç´šç®¡ç†å“¡',
            'normalAdmin': 'æ™®é€šç®¡ç†å“¡',
            'adminChoiceHint': 'è«‹é¸æ“‡æ‚¨è¦é€²å…¥çš„æ¨¡å¼',
            'btnEnterAdmin': 'é€²å…¥ç®¡ç†å“¡é¢æ¿',
            'btnEnterUser': 'é€²å…¥ç”¨æˆ¶åŠŸèƒ½'
        },
        'en': {
            'pageTitle': 'MKNLS Boost Tool 4.0',
            'keyHint': 'Get key by searching cpm MKNLS on Kwai',
            'btnCheckKey': 'Verify Key',
            'btnLogin': 'Login',
            'btnKingRank': 'Set King Rank',
            'btnChangeEmail': 'Change Email',
            'btnChangePassword': 'Change Password',
            'btnToggleAdmin': 'Toggle Admin Mode',
            'btnHome': 'ğŸ  Home',
            'btnSwitchAccount': 'ğŸ”„ Switch Account',
            'btnSwitchKey': 'ğŸ”‘ Switch Key',
            'adminTitle': 'ğŸ”‘ Key Management Center ğŸ”‘',
            'testCardLabel': 'Generate Test Card',
            'testCardInfo': '1 hour validity, 1 account only, unlock achievement only',
            'btnAddKey': 'â• Generate New Key',
            'btnRefresh': 'ğŸ”„ Refresh List',
            'btnCleanup': 'ğŸ—‘ï¸ Clean Expired',
            'thKey': 'Key',
            'thRemark': 'Remark',
            'thExpiry': 'Expiry Time',
            'thAction': 'Action',
            'logTitle': 'Operation Log',
            'systemLoaded': 'System: Page loaded successfully.',
            'modalAccountTitle': 'Account Details',
            'btnCloseModal': 'Close',
            'testCardBadge': 'Test Card',
            'testCardStatus': 'Test Card User',
            'testCardEmailWarning': 'Test card does not support email change. Please contact admin for paid full features!',
            'testCardPasswordWarning': 'Test card does not support password change. Please contact admin for paid full features!',
            'superAdmin': 'Super Admin',
            'normalAdmin': 'Normal Admin',
            'adminChoiceHint': 'Please select the mode you want to enter',
            'btnEnterAdmin': 'Enter Admin Panel',
            'btnEnterUser': 'Enter User Functions'
        }
    };

    let currentLanguage = 'zh-CN';
    let currentKey = null;
    let currentToken = null;
    let currentExpiryTime = null;
    let currentUser = null;
    let isAdminMode = false;
    let isSuperAdmin = false;
    let currentBindInfo = null;
    let isTestCard = false;

    function changeLanguage(lang) {
        currentLanguage = lang;
        applyTranslations();
        logAction("è¯­è¨€åˆ‡æ¢", `åˆ‡æ¢åˆ° ${getLanguageName(lang)}`, 'info');
    }

    function getLanguageName(code) {
        const names = {
            'zh-CN': 'ä¸­æ–‡ç®€ä½“',
            'zh-TW': 'ä¸­æ–‡ç¹é«”',
            'en': 'English'
        };
        return names[code] || code;
    }

    function applyTranslations() {
        const langData = translations[currentLanguage];
        
        Object.keys(langData).forEach(key => {
            const element = document.getElementById(key);
            if (element && !(key === 'systemLoaded' && element.parentElement.id === 'logHistory')) {
                element.textContent = langData[key];
            }
        });

        document.getElementById('accessKey').placeholder = currentLanguage === 'zh-CN' ? 'è¾“å…¥è®¿é—®ç§˜é’¥' : 
                                                         currentLanguage === 'zh-TW' ? 'è¼¸å…¥è¨ªå•ç§˜é‘°' : 'Enter access key';
        
        document.getElementById('email').placeholder = currentLanguage === 'zh-CN' ? 'è¾“å…¥æ‚¨çš„é‚®ç®±' : 
                                                     currentLanguage === 'zh-TW' ? 'è¼¸å…¥æ‚¨çš„éƒµç®±' : 'Enter your email';
        
        document.getElementById('password').placeholder = currentLanguage === 'zh-CN' ? 'è¾“å…¥æ‚¨çš„å¯†ç ' : 
                                                        currentLanguage === 'zh-TW' ? 'è¼¸å…¥æ‚¨çš„å¯†ç¢¼' : 'Enter your password';
        
        document.getElementById('newKeyDuration').placeholder = currentLanguage === 'zh-CN' ? 'ç§˜é’¥æ—¶é•¿ (å°æ—¶)' : 
                                                              currentLanguage === 'zh-TW' ? 'ç§˜é‘°æ™‚é•· (å°æ™‚)' : 'Key duration (hours)';
        
        document.getElementById('newKeyMaxBind').placeholder = currentLanguage === 'zh-CN' ? 'æœ€å¤§ç»‘å®šæ•°é‡' : 
                                                             currentLanguage === 'zh-TW' ? 'æœ€å¤§ç¶å®šæ•¸é‡' : 'Max bind count';
        
        document.getElementById('newKeyRemark').placeholder = currentLanguage === 'zh-CN' ? 'å¤‡æ³¨ (å¦‚: æœˆå¡/æµ‹è¯•å¡)' : 
                                                            currentLanguage === 'zh-TW' ? 'å‚™è¨» (å¦‚: æœˆå¡/æ¸¬è©¦å¡)' : 'Remark (e.g.: Monthly/Test)';
    }

    async function handleCheckKey(key = null) {
        key = key || document.getElementById('accessKey').value.trim();
        if (!key) {
            return updateStatus(currentLanguage === 'zh-CN' ? "è¯·è¾“å…¥ç§˜é’¥ï¼" : 
                              currentLanguage === 'zh-TW' ? "è«‹è¼¸å…¥ç§˜é‘°ï¼" : "Please enter key!", true);
        }
        
        setButtonLoading('btnCheckKey', true);
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨éªŒè¯ç§˜é’¥ï¼Œè¯·ç¨å€™..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨é©—è­‰ç§˜é‘°ï¼Œè«‹ç¨å€™..." : "Verifying key, please wait...");
        
        try {
            const email = document.getElementById('email') ? document.getElementById('email').value.trim() : null;
            
            const data = await apiRequest('/check-key', {
                method: "POST",
                body: JSON.stringify({ key, email })
            });

            currentKey = key;
            currentExpiryTime = data.expiryTime;
            isAdminMode = data.isAdmin;
            isSuperAdmin = data.isSuperAdmin || false;
            isTestCard = data.isTestCard || false;
            
            if (data.isAdmin && data.needsChoice) {
                updateTestCardStatus(isTestCard);
                updateBindInfo(data.bindCount, data.maxBind, data.remainingBinds);
                updateStatus(data.message, false);
                document.getElementById('adminChoice').style.display = 'block';
                document.getElementById('keyForm').style.display = 'none';
                logAction("ç®¡ç†å‘˜éªŒè¯", "ç®¡ç†å‘˜æ¨¡å¼é€‰æ‹©ç•Œé¢", 'info');
                return;
            }
            
            updateTestCardStatus(isTestCard);
            updateBindInfo(data.bindCount, data.maxBind, data.remainingBinds);
            currentBindInfo = { 
                bindCount: data.bindCount, 
                maxBind: data.maxBind, 
                remainingBinds: data.remainingBinds,
                isEmailBound: data.isEmailBound
            };
            
            if (isAdminMode) {
                document.getElementById('toggleAdminModeBtn').style.display = 'block';
                updateStatus(data.message, false);
                switchSection('menuButtons', ['keyForm', 'loginForm']);
                logAction("ç®¡ç†å‘˜ç§˜é’¥", `${isSuperAdmin ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'}æ¨¡å¼å¯ç”¨`, 'info');
            } else {
                updateExpiryDisplay(
                    currentExpiryTime, 
                    data.durationHours || null, 
                    data.cardType || null
                );
                
                if (data.isEmailBound && email) {
                    updateStatus(currentLanguage === 'zh-CN' ? `é‚®ç®± ${email} å·²ç»‘å®šæ­¤ç§˜é’¥ï¼Œå¯ä»¥ç›´æ¥ç™»å½•ï¼` : 
                               currentLanguage === 'zh-TW' ? `éƒµç®± ${email} å·²ç¶å®šæ­¤ç§˜é‘°ï¼Œå¯ä»¥ç›´æ¥ç™»éŒ„ï¼` : 
                               `Email ${email} is bound to this key, you can login directly!`, false);
                } else if (data.remainingBinds <= 0) {
                    updateStatus(currentLanguage === 'zh-CN' ? `ç§˜é’¥ç»‘å®šå·²æ»¡ï¼ä½†å·²ç»‘å®šçš„è´¦å·ä»å¯ç™»å½•ã€‚` : 
                               currentLanguage === 'zh-TW' ? `ç§˜é‘°ç¶å®šå·²æ»¿ï¼ä½†å·²ç¶å®šçš„è³¬è™Ÿä»å¯ç™»éŒ„ã€‚` : 
                               `Key binding is full! But bound accounts can still login.`, true);
                } else {
                    updateStatus(data.message, false);
                }
                
                switchSection('loginForm', ['keyForm', 'menuButtons']);
                logAction("ç§˜é’¥éªŒè¯", data.message, 'success');
            }

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'éªŒè¯å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'é©—è­‰å¤±æ•—ï¼š' : 'Verification failed: '}${error.message}`, true);
            updateBindInfo();
            updateTestCardStatus(false);
        } finally {
            setButtonLoading('btnCheckKey', false);
        }
    }

    async function handleLogin() {
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        if (!email || !password) {
            return updateStatus(currentLanguage === 'zh-CN' ? "è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ï¼" : 
                              currentLanguage === 'zh-TW' ? "è«‹è¼¸å…¥éƒµç®±å’Œå¯†ç¢¼ï¼" : "Please enter email and password!", true);
        }
        
        setButtonLoading('btnLogin', true);
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨ç™»å½•..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨ç™»éŒ„..." : "Logging in...", false);

        try {
            const data = await apiRequest('/login', {
                method: "POST",
                body: JSON.stringify({ email, password, key: currentKey })
            });

            currentToken = data.data.idToken;
            currentUser = data.data.email;
            saveAuthToStorage(currentKey, currentToken, currentExpiryTime, currentUser);

            updateStatus(currentLanguage === 'zh-CN' ? "ç™»å½•æˆåŠŸï¼è¿›å…¥åŠŸèƒ½èœå•ã€‚" : 
                       currentLanguage === 'zh-TW' ? "ç™»éŒ„æˆåŠŸï¼é€²å…¥åŠŸèƒ½èœå–®ã€‚" : "Login successful! Entering function menu.", false);
            switchSection('menuButtons', ['keyForm', 'loginForm']);

            logAction("ç™»å½•", `ç”¨æˆ· ${currentUser} ç™»å½•æˆåŠŸ`, 'success');

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'ç™»å½•å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'ç™»éŒ„å¤±æ•—ï¼š' : 'Login failed: '}${error.message}`, true);
        } finally {
            setButtonLoading('btnLogin', false);
        }
    }

    async function handleKingRank() {
        if (!checkLogin()) return;

        logAction("ç­‰çº§è®¾ç½®", "å¼€å§‹å°è¯•è®¾ç½®å›½ç‹ç­‰çº§...", 'info');
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨å°è¯•è®¾ç½®å›½ç‹ç­‰çº§..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨å˜—è©¦è¨­ç½®åœ‹ç‹ç­‰ç´š..." : "Setting king rank...", false);

        try {
            const data = await apiRequest('/king-rank', {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${currentToken}`
                }
            });

            logAction("ç­‰çº§è®¾ç½®", data.message, 'success');
            updateStatus(data.message, false);

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'ç­‰çº§è®¾ç½®å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'ç­‰ç´šè¨­ç½®å¤±æ•—ï¼š' : 'Failed to set rank: '}${error.message}`, true);
            logAction("ç­‰çº§è®¾ç½®", `è®¾ç½®å¤±è´¥: ${error.message}`, 'error');
        }
    }

    async function handleChangeEmail() {
        if (!checkLogin()) return;

        if (isTestCard) {
            alert(translations[currentLanguage].testCardEmailWarning);
            return;
        }

        const newEmail = prompt(`${currentLanguage === 'zh-CN' ? `è¯·è¾“å…¥æ–°çš„é‚®ç®±åœ°å€ï¼ˆå½“å‰: ${currentUser}ï¼‰ï¼š` : 
                               currentLanguage === 'zh-TW' ? `è«‹è¼¸å…¥æ–°çš„éƒµç®±åœ°å€ï¼ˆç•¶å‰: ${currentUser}ï¼‰ï¼š` : 
                               `Enter new email address (current: ${currentUser}):`}`);
        if (!newEmail) return;

        logAction("ä¿®æ”¹é‚®ç®±", `æ­£åœ¨å°è¯•ä¿®æ”¹é‚®ç®±è‡³ ${newEmail}...`, 'info');
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨ä¿®æ”¹é‚®ç®±..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨ä¿®æ”¹éƒµç®±..." : "Changing email...", false);

        try {
            const data = await apiRequest('/change-email', {
                method: "POST",
                body: JSON.stringify({
                    idToken: currentToken,
                    newEmail,
                    oldEmail: currentUser,
                    key: currentKey
                }) 
            });

            currentToken = data.data.idToken;
            const oldUser = currentUser;
            currentUser = data.data.email;
            saveAuthToStorage(currentKey, currentToken, currentExpiryTime, currentUser);

            logAction("ä¿®æ”¹é‚®ç®±", `æˆåŠŸä» ${oldUser} ä¿®æ”¹ä¸º ${currentUser}`, 'success');
            updateStatus(currentLanguage === 'zh-CN' ? `é‚®ç®±ä¿®æ”¹æˆåŠŸï¼æ–°é‚®ç®±: ${currentUser}` : 
                       currentLanguage === 'zh-TW' ? `éƒµç®±ä¿®æ”¹æˆåŠŸï¼æ–°éƒµç®±: ${currentUser}` : 
                       `Email changed successfully! New email: ${currentUser}`, false);

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'ä¿®æ”¹å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'ä¿®æ”¹å¤±æ•—ï¼š' : 'Change failed: '}${error.message}`, true);
            logAction("ä¿®æ”¹é‚®ç®±", `ä¿®æ”¹å¤±è´¥: ${error.message}`, 'error');
        }
    }

    async function handleChangePassword() {
        if (!checkLogin()) return;

        if (isTestCard) {
            alert(translations[currentLanguage].testCardPasswordWarning);
            return;
        }

        const newPassword = prompt(currentLanguage === 'zh-CN' ? "è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰ï¼š" : 
                                 currentLanguage === 'zh-TW' ? "è«‹è¼¸å…¥æ–°å¯†ç¢¼ï¼ˆè‡³å°‘6ä½ï¼‰ï¼š" : 
                                 "Enter new password (at least 6 characters):");
        if (!newPassword) return;
        if (newPassword.length < 6) {
            return updateStatus(currentLanguage === 'zh-CN' ? "æ–°å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼" : 
                              currentLanguage === 'zh-TW' ? "æ–°å¯†ç¢¼é•·åº¦ä¸èƒ½å°‘æ–¼6ä½ï¼" : 
                              "New password must be at least 6 characters!", true);
        }

        logAction("ä¿®æ”¹å¯†ç ", "æ­£åœ¨å°è¯•ä¿®æ”¹å¯†ç ...", 'info');
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨ä¿®æ”¹å¯†ç ..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨ä¿®æ”¹å¯†ç¢¼..." : "Changing password...", false);

        try {
            const data = await apiRequest('/change-password', {
                method: "POST",
                body: JSON.stringify({
                    idToken: currentToken,
                    newPassword,
                    email: currentUser,
                    key: currentKey
                }) 
            });

            currentToken = data.data.idToken;
            saveAuthToStorage(currentKey, currentToken, currentExpiryTime, currentUser);

            logAction("ä¿®æ”¹å¯†ç ", "å¯†ç ä¿®æ”¹æˆåŠŸ", 'success');
            updateStatus(currentLanguage === 'zh-CN' ? "å¯†ç ä¿®æ”¹æˆåŠŸï¼" : 
                       currentLanguage === 'zh-TW' ? "å¯†ç¢¼ä¿®æ”¹æˆåŠŸï¼" : "Password changed successfully!", false);

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'ä¿®æ”¹å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'ä¿®æ”¹å¤±æ•—ï¼š' : 'Change failed: '}${error.message}`, true);
            logAction("ä¿®æ”¹å¯†ç ", `ä¿®æ”¹å¤±è´¥: ${error.message}`, 'error');
        }
    }

    function setButtonLoading(buttonId, loading) {
        const button = document.getElementById(buttonId);
        const textElement = button.querySelector('span') || button;
        
        if (loading) {
            button.disabled = true;
            const originalText = textElement.textContent;
            textElement.innerHTML = `<span class="loading-spinner"></span>åŠ è½½ä¸­...`;
            button.setAttribute('data-original-text', originalText);
        } else {
            button.disabled = false;
            const originalText = button.getAttribute('data-original-text');
            if (originalText) {
                textElement.textContent = originalText;
            }
        }
    }

    function logAction(action, message, type) {
        const logHistory = document.getElementById('logHistory');
        const now = new Date().toLocaleTimeString('zh-CN', { hour12: false });
        
        const typeClass = `log-${type}`;
        const logItem = document.createElement('div');
        logItem.className = `ios-log-item ${typeClass}`;
        
        let logContent = `${now} [${action}] `;
        if (isAdminMode) {
             logContent += `(${isSuperAdmin ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'}): `;
        } else if (currentUser) {
            logContent += `(${currentUser}): `;
        } else {
            logContent += `(æ¸¸å®¢): `;
        }
        logContent += message;

        logItem.textContent = logContent;
        
        logHistory.prepend(logItem);

        while (logHistory.children.length > 15) {
            logHistory.removeChild(logHistory.lastChild);
        }
    }

    function updateStatus(message, isError = false) {
        const statusEl = document.getElementById('statusMessage');
        statusEl.textContent = message;
        
        if (isTestCard) {
            statusEl.className = 'ios-status test-card';
        } else if (isAdminMode) {
            statusEl.className = isSuperAdmin ? 'ios-status super-admin' : 'ios-status admin';
        } else {
            statusEl.className = 'ios-status ' + (isError ? 'error' : 'success');
        }
    }

    function updateBindInfo(bindCount, maxBind, remainingBinds) {
        const bindInfoEl = document.getElementById('bindInfo');
        if (bindCount !== undefined && maxBind !== undefined && remainingBinds !== undefined) {
            const bindText = currentLanguage === 'zh-CN' ? `å½“å‰ç»‘å®š: ${bindCount}/${maxBind} | å‰©ä½™: ${remainingBinds}` :
                           currentLanguage === 'zh-TW' ? `ç•¶å‰ç¶å®š: ${bindCount}/${maxBind} | å‰©é¤˜: ${remainingBinds}` :
                           `Current: ${bindCount}/${maxBind} | Remaining: ${remainingBinds}`;
            bindInfoEl.textContent = bindText;
            bindInfoEl.style.display = 'block';
            
            if (remainingBinds <= 2) {
                bindInfoEl.style.backgroundColor = 'rgba(255, 59, 48, 0.3)';
                bindInfoEl.style.borderColor = 'rgba(255, 59, 48, 0.5)';
                bindInfoEl.style.color = '#FFB6C1';
            } else {
                bindInfoEl.style.backgroundColor = 'rgba(255, 149, 0, 0.3)';
                bindInfoEl.style.borderColor = 'rgba(255, 149, 0, 0.5)';
                bindInfoEl.style.color = 'white';
            }
        } else {
            bindInfoEl.style.display = 'none';
        }
    }

    function showNavButtons() {
        document.getElementById('navButtons').style.display = 'flex';
    }

    function hideNavButtons() {
        document.getElementById('navButtons').style.display = 'none';
    }

    function switchSection(showId, hideIds) {
        document.getElementById(showId).style.display = 'block';
        hideIds.forEach(id => {
            document.getElementById(id).style.display = 'none';
        });
        
        if (showId !== 'keyForm') {
            showNavButtons();
        } else {
            hideNavButtons();
        }
    }

    function checkLogin() {
        if (!currentToken || !currentKey) {
            updateStatus(currentLanguage === 'zh-CN' ? "è¯·å…ˆç™»å½•ï¼" : 
                        currentLanguage === 'zh-TW' ? "è«‹å…ˆç™»éŒ„ï¼" : "Please login first!", true);
            handleLogout(true); 
            return false;
        }
        return true;
    }
    
    function saveAuthToStorage(key, token, expiry, user) {
        localStorage.setItem('accessKey', key);
        localStorage.setItem('idToken', token);
        localStorage.setItem('expiryTime', expiry);
        localStorage.setItem('currentUser', user);
        localStorage.setItem('currentLanguage', currentLanguage);
    }

    function loadAuthFromStorage() {
        currentKey = localStorage.getItem('accessKey');
        currentToken = localStorage.getItem('idToken');
        currentExpiryTime = localStorage.getItem('expiryTime');
        currentUser = localStorage.getItem('currentUser');
        const savedLang = localStorage.getItem('currentLanguage');
        if (savedLang) {
            currentLanguage = savedLang;
            document.getElementById('languageSelect').value = currentLanguage;
            applyTranslations();
        }
        return currentKey && currentToken;
    }

    function updateExpiryDisplay(expiryTime, durationHours, specialTag = null, clear = false) {
        const displayEl = document.getElementById('expiryDisplay');
        if (clear || !expiryTime) {
            displayEl.textContent = '';
            displayEl.className = 'ios-expiry';
            return;
        }
        
        let vipLevel = "";
        
        if (isTestCard) {
            vipLevel = translations[currentLanguage].testCardStatus;
        } else if (specialTag === 'DIAMOND_EXCLUSIVE') {
            vipLevel = "è‡³å°ŠVIP";
        } else if (durationHours !== null) {
            const hours = durationHours;
            
            if (hours >= 365 * 24 * 5) {
                vipLevel = "é’»çŸ³VIP";
            } else if (hours >= 30 * 24) { 
                vipLevel = "é“‚é‡‘VIP";
            } else if (hours >= 7 * 24) { 
                vipLevel = "é»„é‡‘VIP";
            } else if (hours >= 24) {
                vipLevel = "ç™½é“¶VIP";
            } else {
                vipLevel = "é’é“œVIP";
            }
        } else {
            vipLevel = currentLanguage === 'zh-CN' ? "å°Šè´µçš„ç”¨æˆ·" : 
                      currentLanguage === 'zh-TW' ? "å°Šè²´çš„ç”¨æˆ¶" : "Valued User";
        }

        const welcomeText = currentLanguage === 'zh-CN' ? `æ¬¢è¿ç™»å½•ï¼Œ<strong>${vipLevel}</strong>ç”¨æˆ·ï¼` :
                          currentLanguage === 'zh-TW' ? `æ­¡è¿ç™»éŒ„ï¼Œ<strong>${vipLevel}</strong>ç”¨æˆ¶ï¼` :
                          `Welcome, <strong>${vipLevel}</strong>!`;

        let expiryHtml = welcomeText + `<br>`;
        
        if (expiryTime) {
            expiryHtml += `<div class="blinking-expiry">ç§˜é’¥å°†äº ${expiryTime} åˆ°æœŸ</div>`;
        }

        displayEl.innerHTML = expiryHtml;
    }

    function updateTestCardStatus(isTest) {
        isTestCard = isTest;
        const statusEl = document.getElementById('statusMessage');
        
        if (isTest) {
            statusEl.className = 'ios-status test-card';
            document.getElementById('btnChangeEmail').disabled = true;
            document.getElementById('btnChangePassword').disabled = true;
            document.getElementById('btnChangeEmail').title = translations[currentLanguage].testCardEmailWarning;
            document.getElementById('btnChangePassword').title = translations[currentLanguage].testCardPasswordWarning;
        } else {
            document.getElementById('btnChangeEmail').disabled = false;
            document.getElementById('btnChangePassword').disabled = false;
            document.getElementById('btnChangeEmail').title = '';
            document.getElementById('btnChangePassword').title = '';
        }
    }

    function enterAdminPanel() {
        document.getElementById('adminChoice').style.display = 'none';
        document.getElementById('menuButtons').style.display = 'block';
        document.getElementById('toggleAdminModeBtn').style.display = 'block';
        updateStatus(currentLanguage === 'zh-CN' ? "å·²è¿›å…¥ç®¡ç†å‘˜æ¨¡å¼ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åˆ‡æ¢ç®¡ç†é¢æ¿" : 
                   currentLanguage === 'zh-TW' ? "å·²é€²å…¥ç®¡ç†å“¡æ¨¡å¼ï¼Œé»æ“Šä¸Šæ–¹æŒ‰éˆ•åˆ‡æ›ç®¡ç†é¢æ¿" : "Entered admin mode, click button above to toggle admin panel", false);
    }

    function enterUserPanel() {
        document.getElementById('adminChoice').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
        updateStatus(currentLanguage === 'zh-CN' ? "è¯·ç™»å½•æ‚¨çš„æ¸¸æˆè´¦å·ä½¿ç”¨åŠŸèƒ½" : 
                   currentLanguage === 'zh-TW' ? "è«‹ç™»éŒ„æ‚¨çš„éŠæˆ²è³¬è™Ÿä½¿ç”¨åŠŸèƒ½" : "Please login with your game account to use functions", false);
    }

    function toggleAdminMode() {
        if (!isAdminMode) return;

        const isViewingAdmin = document.getElementById('adminPanel').style.display === 'block';
        
        if (isViewingAdmin) {
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('menuButtons').style.display = 'block';
            updateStatus(currentLanguage === 'zh-CN' ? "å·²é€€å‡ºç®¡ç†å‘˜é¢æ¿" : 
                       currentLanguage === 'zh-TW' ? "å·²é€€å‡ºç®¡ç†å“¡é¢æ¿" : "Exited admin panel", false);
        } else {
            document.getElementById('menuButtons').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
            updateStatus(currentLanguage === 'zh-CN' ? "ç®¡ç†å‘˜é¢æ¿å·²å¼€å¯" : 
                       currentLanguage === 'zh-TW' ? "ç®¡ç†å“¡é¢æ¿å·²é–‹å•Ÿ" : "Admin panel opened", false);
            updateAdminUI();
            fetchKeys();
        }
    }

    function updateAdminUI() {
        const adminLevelBadge = document.getElementById('adminLevelBadge');
        const testCardOption = document.getElementById('testCardOption');
        const normalKeyOptions = document.getElementById('normalKeyOptions');
        
        if (isSuperAdmin) {
            adminLevelBadge.textContent = translations[currentLanguage].superAdmin;
            testCardOption.style.display = 'flex';
            normalKeyOptions.style.display = 'block';
        } else {
            adminLevelBadge.textContent = translations[currentLanguage].normalAdmin;
            testCardOption.style.display = 'none';
            normalKeyOptions.style.display = 'none';
            document.getElementById('isTestCard').checked = true;
            toggleTestCardOptions();
        }
    }

    function toggleTestCardOptions() {
        const isTestCard = document.getElementById('isTestCard').checked;
        const normalOptions = document.getElementById('normalKeyOptions');
        
        if (isTestCard) {
            normalOptions.style.display = 'none';
            document.getElementById('newKeyDuration').value = 1;
            document.getElementById('newKeyMaxBind').value = 1;
        } else {
            normalOptions.style.display = 'block';
            document.getElementById('newKeyDuration').value = 24;
            document.getElementById('newKeyMaxBind').value = 3;
        }
    }

    async function fetchKeys() {
        if (!isAdminMode) return;
        logAction("ç§˜é’¥ç®¡ç†", "æ­£åœ¨è·å–åˆ†ç±»ç§˜é’¥åˆ—è¡¨...", 'info');
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨è·å–åˆ†ç±»ç§˜é’¥åˆ—è¡¨..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨ç²å–åˆ†é¡ç§˜é‘°åˆ—è¡¨..." : "Fetching categorized key list...", false);

        try {
            const data = await apiRequest(`/admin/keys?key=${currentKey}`, {
                method: "GET"
            });

            renderKeysTable(data.keys);
            updateStatus(currentLanguage === 'zh-CN' ? `æˆåŠŸè·å–åˆ†ç±»ç§˜é’¥ä¿¡æ¯` : 
                       currentLanguage === 'zh-TW' ? `æˆåŠŸç²å–åˆ†é¡ç§˜é‘°ä¿¡æ¯` : 
                       `Successfully got categorized key info`, false);
            logAction("ç§˜é’¥ç®¡ç†", "æˆåŠŸè·å–åˆ†ç±»ç§˜é’¥åˆ—è¡¨", 'success');

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'è·å–åˆ—è¡¨å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'ç²å–åˆ—è¡¨å¤±æ•—ï¼š' : 'Failed to get list: '}${error.message}`, true);
            logAction("ç§˜é’¥ç®¡ç†", `è·å–åˆ—è¡¨å¤±è´¥ï¼š${error.message}`, 'error');
        }
    }

    function renderKeysTable(categorizedKeys) {
        const tgTbody = document.getElementById('tgKeysTableBody');
        tgTbody.innerHTML = '';
        const tgKeys = categorizedKeys.telegram || [];
        
        tgKeys.forEach(keyData => {
            renderKeyRow(tgTbody, keyData, 'tg');
        });
        document.getElementById('tgKeyCount').textContent = `(${tgKeys.length})`;
        
        const superAdminTbody = document.getElementById('superAdminKeysTableBody');
        superAdminTbody.innerHTML = '';
        const superAdminKeys = categorizedKeys.superAdmin || [];
        
        superAdminKeys.forEach(keyData => {
            renderKeyRow(superAdminTbody, keyData, 'super');
        });
        document.getElementById('superAdminKeyCount').textContent = `(${superAdminKeys.length})`;
        
        const normalAdminContainer = document.getElementById('normalAdminCategories');
        normalAdminContainer.innerHTML = '';
        
        Object.values(categorizedKeys.normalAdmins || {}).forEach(adminData => {
            const categoryId = `admin-${adminData.adminKey.replace(/[^a-zA-Z0-9]/g, '-')}`;
            const categoryHtml = `
                <details class="key-category" id="${categoryId}">
                    <summary class="category-summary">
                        <span>ğŸ‘¤ ${adminData.adminName}</span>
                        <span class="key-count">(${adminData.keys.length})</span>
                    </summary>
                    <table class="ios-table">
                        <thead>
                            <tr>
                                <th>ç§˜é’¥</th>
                                <th>å¤‡æ³¨</th>
                                <th>åˆ°æœŸæ—¶é—´</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="${categoryId}-body"></tbody>
                    </table>
                </details>
            `;
            normalAdminContainer.innerHTML += categoryHtml;
            
            const tbody = document.getElementById(`${categoryId}-body`);
            adminData.keys.forEach(keyData => {
                renderKeyRow(tbody, keyData, 'normal');
            });
        });
    }

    function renderKeyRow(tbody, keyData, type) {
        const isActivated = keyData.isActivated;
        const expiryTimeStr = isActivated 
            ? new Date(keyData.expiryTime).toLocaleTimeString('zh-CN', { hour12: false, year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }) 
            : (currentLanguage === 'zh-CN' ? 'æœªæ¿€æ´»' : 'Not activated');
            
        const expiryClass = (isActivated && (new Date(keyData.expiryTime).getTime() - Date.now() < 24 * 3600 * 1000)) ? 'style="color: #FFB6C1; font-weight: bold;"' : '';

        const boundEmails = keyData.boundEmails || [];
        const bindCount = boundEmails.length;
        const maxBind = keyData.maxBind || 3;
        const bindInfo = ` (${bindCount}/${maxBind})`;

        const testCardBadge = keyData.isTestCard ? `<span class="test-card-badge">${translations[currentLanguage].testCardBadge}</span>` : '';
        
        let addedByInfo = '';
        if (type === 'tg' && keyData.telegramUser) {
            const tgUser = keyData.telegramUser;
            addedByInfo = `<br><small>TGç”¨æˆ·: ${tgUser.username || tgUser.firstName || 'æœªçŸ¥'}</small>`;
        } else if (keyData.addedByName) {
            addedByInfo = `<br><small>${keyData.addedByName}</small>`;
        }

        const row = tbody.insertRow();
        
        if (type === 'tg') {
            const kuaishouCode = keyData.applicationInfo ? keyData.applicationInfo.kuaishouCode : 'æœªè®°å½•';
            row.innerHTML = `
                <td>${keyData.key}${testCardBadge}${addedByInfo}</td>
                <td>${keyData.telegramUser ? (keyData.telegramUser.username || keyData.telegramUser.firstName || 'æœªçŸ¥') : 'æœªçŸ¥'}</td>
                <td>${kuaishouCode}</td>
                <td ${expiryClass}>${expiryTimeStr.replace(/\//g, '-')}</td>
                <td>
                    <div class="ios-action-group">
                        <button class="ios-action-btn copy" onclick="copyKey('${keyData.key}')">å¤åˆ¶</button>
                        <button class="ios-action-btn view" onclick="viewAccountDetails('${keyData.key}')">è¯¦æƒ…</button>
                        <button class="ios-action-btn delete" onclick="handleDeleteKey('${keyData.key}')">åˆ é™¤</button>
                    </div>
                </td>
            `;
        } else {
            row.innerHTML = `
                <td>${keyData.key}${testCardBadge}${addedByInfo}</td>
                <td>${(keyData.remark || 'æ— ') + bindInfo}</td>
                <td ${expiryClass}>${expiryTimeStr.replace(/\//g, '-')}</td>
                <td>
                    <div class="ios-action-group">
                        <button class="ios-action-btn copy" onclick="copyKey('${keyData.key}')">å¤åˆ¶</button>
                        <button class="ios-action-btn view" onclick="viewAccountDetails('${keyData.key}')">è¯¦æƒ…</button>
                        <button class="ios-action-btn delete" onclick="handleDeleteKey('${keyData.key}')">åˆ é™¤</button>
                    </div>
                </td>
            `;
        }
    }

    async function handleAddKey() {
        if (!isAdminMode) return;

        const isTestCard = document.getElementById('isTestCard').checked;
        const duration = parseInt(document.getElementById('newKeyDuration').value);
        const maxBind = parseInt(document.getElementById('newKeyMaxBind').value) || 3;
        const remark = document.getElementById('newKeyRemark').value.trim();

        if (!isTestCard && (isNaN(duration) || duration <= 0)) {
            return alert(currentLanguage === 'zh-CN' ? "è¯·è¾“å…¥æœ‰æ•ˆçš„ç§˜é’¥æ—¶é•¿ (å°æ—¶)" : 
                        currentLanguage === 'zh-TW' ? "è«‹è¼¸å…¥æœ‰æ•ˆçš„ç§˜é‘°æ™‚é•· (å°æ™‚)" : "Please enter valid key duration (hours)");
        }

        if (!isTestCard && (isNaN(maxBind) || maxBind <= 0)) {
            return alert(currentLanguage === 'zh-CN' ? "è¯·è¾“å…¥æœ‰æ•ˆçš„æœ€å¤§ç»‘å®šæ•°é‡" : 
                        currentLanguage === 'zh-TW' ? "è«‹è¼¸å…¥æœ‰æ•ˆçš„æœ€å¤§ç¶å®šæ•¸é‡" : "Please enter valid max bind count");
        }
        
        logAction("ç§˜é’¥ç®¡ç†", `æ­£åœ¨ç”Ÿæˆ${isTestCard ? 'æµ‹è¯•å¡' : 'ç§˜é’¥'}...`, 'info');
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨ç”Ÿæˆå¹¶æ–°å¢ç§˜é’¥..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨ç”Ÿæˆä¸¦æ–°å¢ç§˜é‘°..." : "Generating new key...", false);

        try {
            const data = await apiRequest(`/admin/keys?key=${currentKey}`, {
                method: "POST",
                body: JSON.stringify({ 
                    durationHours: duration, 
                    maxBind: maxBind, 
                    remark: remark,
                    isTestCard: isTestCard 
                })
            });

            const successMessage = isTestCard ? 
                (currentLanguage === 'zh-CN' ? `æµ‹è¯•å¡ç”ŸæˆæˆåŠŸï¼\nç§˜é’¥: ${data.key}\næ—¶é•¿: 1 å°æ—¶\næœ€å¤§ç»‘å®š: 1 ä¸ªè´¦å·\nå¤‡æ³¨: ${remark || 'æµ‹è¯•å¡'}` :
                 currentLanguage === 'zh-TW' ? `æ¸¬è©¦å¡ç”ŸæˆæˆåŠŸï¼\nç§˜é‘°: ${data.key}\næ™‚é•·: 1 å°æ™‚\næœ€å¤§ç¶å®š: 1 å€‹è³¬è™Ÿ\nå‚™è¨»: ${remark || 'æ¸¬è©¦å¡'}` :
                 `Test card generated successfully!\nKey: ${data.key}\nDuration: 1 hour\nMax Bind: 1 account\nRemark: ${remark || 'Test Card'}`) :
                (currentLanguage === 'zh-CN' ? `ç§˜é’¥ç”ŸæˆæˆåŠŸï¼\nç§˜é’¥: ${data.key}\næ—¶é•¿: ${duration} å°æ—¶\næœ€å¤§ç»‘å®š: ${maxBind} ä¸ªè´¦å·\nå¤‡æ³¨: ${remark || 'æ— '}` :
                 currentLanguage === 'zh-TW' ? `ç§˜é‘°ç”ŸæˆæˆåŠŸï¼\nç§˜é‘°: ${data.key}\næ™‚é•·: ${duration} å°æ™‚\næœ€å¤§ç¶å®š: ${maxBind} å€‹è³¬è™Ÿ\nå‚™è¨»: ${remark || 'ç„¡'}` :
                 `Key generated successfully!\nKey: ${data.key}\nDuration: ${duration} hours\nMax Bind: ${maxBind} accounts\nRemark: ${remark || 'None'}`);
            
            alert(successMessage);
            
            logAction("ç§˜é’¥ç®¡ç†", `æˆåŠŸç”Ÿæˆ${isTestCard ? 'æµ‹è¯•å¡' : 'ç§˜é’¥'}: ${data.key}`, 'success');
            
            fetchKeys();

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'æ–°å¢ç§˜é’¥å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'æ–°å¢ç§˜é‘°å¤±æ•—ï¼š' : 'Failed to add key: '}${error.message}`, true);
            logAction("ç§˜é’¥ç®¡ç†", `æ–°å¢ç§˜é’¥å¤±è´¥ï¼š${error.message}`, 'error');
        }
    }

    async function handleCleanupExpiredKeys() {
        if (!isAdminMode) return;
        
        const confirmMessage = currentLanguage === 'zh-CN' ? 'ç¡®å®šè¦æ¸…ç†æ‰€æœ‰è¿‡æœŸç§˜é’¥å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼' :
                             currentLanguage === 'zh-TW' ? 'ç¢ºå®šè¦æ¸…ç†æ‰€æœ‰éæœŸç§˜é‘°å—ï¼Ÿæ­¤æ“ä½œä¸å¯é€†ï¼' :
                             'Are you sure you want to clean up all expired keys? This operation is irreversible!';
        
        if (!confirm(confirmMessage)) return;

        logAction("ç§˜é’¥ç®¡ç†", "æ­£åœ¨æ¸…ç†è¿‡æœŸç§˜é’¥...", 'info');
        updateStatus(currentLanguage === 'zh-CN' ? "æ­£åœ¨æ¸…ç†è¿‡æœŸç§˜é’¥..." : 
                   currentLanguage === 'zh-TW' ? "æ­£åœ¨æ¸…ç†éæœŸç§˜é‘°..." : "Cleaning expired keys...", false);

        try {
            const data = await apiRequest(`/admin/cleanup-expired-keys?key=${currentKey}`, {
                method: "POST"
            });

            logAction("ç§˜é’¥ç®¡ç†", data.message, 'success');
            updateStatus(data.message, false);
            
            fetchKeys();

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'æ¸…ç†å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'æ¸…ç†å¤±æ•—ï¼š' : 'Cleanup failed: '}${error.message}`, true);
            logAction("ç§˜é’¥ç®¡ç†", `æ¸…ç†å¤±è´¥: ${error.message}`, 'error');
        }
    }
    
    async function handleDeleteKey(keyToDelete) {
        if (!isAdminMode) return;
        
        const confirmMessage = currentLanguage === 'zh-CN' ? `ç¡®å®šè¦æ°¸ä¹…åˆ é™¤ç§˜é’¥ï¼š${keyToDelete} å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯é€†ï¼` :
                             currentLanguage === 'zh-TW' ? `ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ç§˜é‘°ï¼š${keyToDelete} å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯é€†ï¼` :
                             `Are you sure you want to permanently delete key: ${keyToDelete}?\nThis operation is irreversible!`;
        
        if (!confirm(confirmMessage)) return;

        logAction("ç§˜é’¥ç®¡ç†", `æ­£åœ¨åˆ é™¤ç§˜é’¥: ${keyToDelete}...`, 'info');
        updateStatus(`${currentLanguage === 'zh-CN' ? 'æ­£åœ¨åˆ é™¤ç§˜é’¥: ' : 
                    currentLanguage === 'zh-TW' ? 'æ­£åœ¨åˆªé™¤ç§˜é‘°: ' : 'Deleting key: '}${keyToDelete}...`, false);

        try {
            const data = await apiRequest(`/admin/keys?key=${currentKey}&keyToDelete=${keyToDelete}`, {
                method: "DELETE"
            });

            logAction("ç§˜é’¥ç®¡ç†", `æˆåŠŸåˆ é™¤ç§˜é’¥: ${keyToDelete}`, 'success');
            updateStatus(`${currentLanguage === 'zh-CN' ? 'æˆåŠŸåˆ é™¤ç§˜é’¥: ' : 
                        currentLanguage === 'zh-TW' ? 'æˆåŠŸåˆªé™¤ç§˜é‘°: ' : 'Successfully deleted key: '}${keyToDelete}`, false);
            
            fetchKeys();

        } catch (error) {
            updateStatus(`${currentLanguage === 'zh-CN' ? 'åˆ é™¤ç§˜é’¥å¤±è´¥ï¼š' : 
                        currentLanguage === 'zh-TW' ? 'åˆªé™¤ç§˜é‘°å¤±æ•—ï¼š' : 'Failed to delete key: '}${error.message}`, true);
            logAction("ç§˜é’¥ç®¡ç†", `åˆ é™¤ç§˜é’¥å¤±è´¥ï¼š${error.message}`, 'error');
        }
    }

    function viewAccountDetails(key) {
        fetch(`${API_BASE_URL}/admin/keys?key=${currentKey}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const keyData = data.keys.find(k => k.key === key);
                    if (keyData) {
                        showAccountDetails(keyData);
                    }
                }
            })
            .catch(error => {
                alert(`${currentLanguage === 'zh-CN' ? 'è·å–è´¦å·è¯¦æƒ…å¤±è´¥: ' : 
                      currentLanguage === 'zh-TW' ? 'ç²å–è³¬è™Ÿè©³æƒ…å¤±æ•—: ' : 'Failed to get account details: '}${error.message}`);
            });
    }

    function showAccountDetails(keyData) {
        const modal = document.getElementById('accountModal');
        const detailsEl = document.getElementById('accountDetails');
        
        const activationTime = keyData.activationTime ? 
            new Date(keyData.activationTime).toLocaleString('zh-CN', { hour12: false }) : 
            (currentLanguage === 'zh-CN' ? 'æœªæ¿€æ´»' : 
             currentLanguage === 'zh-TW' ? 'æœªæ¿€æ´»' : 'Not activated');
        const expiryTime = keyData.expiryTime ? 
            new Date(keyData.expiryTime).toLocaleString('zh-CN', { hour12: false }) : 
            (currentLanguage === 'zh-CN' ? 'æœªæ¿€æ´»' : 
             currentLanguage === 'zh-TW' ? 'æœªæ¿€æ´»' : 'Not activated');
        
        const keyLabel = currentLanguage === 'zh-CN' ? 'ç§˜é’¥:' : 
                        currentLanguage === 'zh-TW' ? 'ç§˜é‘°:' : 'Key:';
        const remarkLabel = currentLanguage === 'zh-CN' ? 'å¤‡æ³¨:' : 
                           currentLanguage === 'zh-TW' ? 'å‚™è¨»:' : 'Remark:';
        const statusLabel = currentLanguage === 'zh-CN' ? 'çŠ¶æ€:' : 
                           currentLanguage === 'zh-TW' ? 'ç‹€æ…‹:' : 'Status:';
        const activateTimeLabel = currentLanguage === 'zh-CN' ? 'å¯ç”¨æ—¶é—´:' : 
                                currentLanguage === 'zh-TW' ? 'å•Ÿç”¨æ™‚é–“:' : 'Activation Time:';
        const expiryTimeLabel = currentLanguage === 'zh-CN' ? 'åˆ°æœŸæ—¶é—´:' : 
                               currentLanguage === 'zh-TW' ? 'åˆ°æœŸæ™‚é–“:' : 'Expiry Time:';
        const bindCountLabel = currentLanguage === 'zh-CN' ? 'ç»‘å®šæ•°é‡:' : 
                              currentLanguage === 'zh-TW' ? 'ç¶å®šæ•¸é‡:' : 'Bind Count:';
        const addedByLabel = currentLanguage === 'zh-CN' ? 'æ·»åŠ è€…:' : 
                           currentLanguage === 'zh-TW' ? 'æ·»åŠ è€…:' : 'Added By:';
        const activatedStatus = currentLanguage === 'zh-CN' ? 'å·²æ¿€æ´»' : 
                              currentLanguage === 'zh-TW' ? 'å·²æ¿€æ´»' : 'Activated';
        const notActivatedStatus = currentLanguage === 'zh-CN' ? 'æœªæ¿€æ´»' : 
                                 currentLanguage === 'zh-TW' ? 'æœªæ¿€æ´»' : 'Not activated';
        const boundAccountsLabel = currentLanguage === 'zh-CN' ? 'ç»‘å®šçš„è´¦å·:' : 
                                  currentLanguage === 'zh-TW' ? 'ç¶å®šçš„è³¬è™Ÿ:' : 'Bound Accounts:';
        const noAccountsLabel = currentLanguage === 'zh-CN' ? 'æš‚æ— ç»‘å®šçš„è´¦å·' : 
                               currentLanguage === 'zh-TW' ? 'æš«ç„¡ç¶å®šçš„è³¬è™Ÿ' : 'No bound accounts';
        
        let html = `<div style="margin-bottom: 16px;">
            <strong>${keyLabel}</strong> ${keyData.key}<br>
            <strong>${remarkLabel}</strong> ${keyData.remark || (currentLanguage === 'zh-CN' ? 'æ— ' : 
                                                               currentLanguage === 'zh-TW' ? 'ç„¡' : 'None')}<br>
            <strong>${statusLabel}</strong> ${keyData.isActivated ? activatedStatus : notActivatedStatus}<br>
            <strong>${activateTimeLabel}</strong> ${activationTime}<br>
            <strong>${expiryTimeLabel}</strong> ${expiryTime}<br>
            <strong>${bindCountLabel}</strong> ${(keyData.boundEmails || []).length}/${keyData.maxBind || 3}<br>
            <strong>${addedByLabel}</strong> ${keyData.addedByName || (currentLanguage === 'zh-CN' ? 'æœªçŸ¥' : 
                                                                     currentLanguage === 'zh-TW' ? 'æœªçŸ¥' : 'Unknown')}
        </div>`;

        if (keyData.telegramUser) {
            const tgUser = keyData.telegramUser;
            const tgLabel = currentLanguage === 'zh-CN' ? 'Telegramç”¨æˆ·ä¿¡æ¯:' : 
                           currentLanguage === 'zh-TW' ? 'Telegramç”¨æˆ¶ä¿¡æ¯:' : 'Telegram User:';
            const idLabel = currentLanguage === 'zh-CN' ? 'ç”¨æˆ·ID:' : 
                           currentLanguage === 'zh-TW' ? 'ç”¨æˆ¶ID:' : 'User ID:';
            const nameLabel = currentLanguage === 'zh-CN' ? 'ç”¨æˆ·å:' : 
                             currentLanguage === 'zh-TW' ? 'ç”¨æˆ¶å:' : 'Username:';
            const firstNameLabel = currentLanguage === 'zh-CN' ? 'åå­—:' : 
                                 currentLanguage === 'zh-TW' ? 'åå­—:' : 'First Name:';
            
            html += `<div style="margin: 16px 0; padding: 12px; background: rgba(0, 122, 255, 0.1); border-radius: 8px;">
                <strong>${tgLabel}</strong><br>
                <strong>${idLabel}</strong> ${tgUser.id}<br>
                <strong>${nameLabel}</strong> ${tgUser.username || 'æ— '}<br>
                <strong>${firstNameLabel}</strong> ${tgUser.firstName || 'æ— '}
            </div>`;
        }

        if (keyData.applicationInfo) {
            const appInfo = keyData.applicationInfo;
            const applyLabel = currentLanguage === 'zh-CN' ? 'ç”³è¯·ä¿¡æ¯:' : 
                              currentLanguage === 'zh-TW' ? 'ç”³è«‹ä¿¡æ¯:' : 'Application Info:';
            const applyTimeLabel = currentLanguage === 'zh-CN' ? 'ç”³è¯·æ—¶é—´:' : 
                                 currentLanguage === 'zh-TW' ? 'ç”³è«‹æ™‚é–“:' : 'Applied At:';
            const kuaishouLabel = currentLanguage === 'zh-CN' ? 'å¿«æ‰‹æš—å·:' : 
                                 currentLanguage === 'zh-TW' ? 'å¿«æ‰‹æš—è™Ÿ:' : 'Kuaishou Code:';
            
            html += `<div style="margin: 16px 0; padding: 12px; background: rgba(255, 149, 0, 0.1); border-radius: 8px;">
                <strong>${applyLabel}</strong><br>
                <strong>${applyTimeLabel}</strong> ${new Date(appInfo.appliedAt).toLocaleString()}<br>
                <strong>${kuaishouLabel}</strong> ${appInfo.kuaishouCode || 'æœªæä¾›'}<br>
                <strong>ç”³è¯·æ¸ é“:</strong> ${appInfo.appliedVia || 'æœªçŸ¥'}
            </div>`;
        }

        const boundAccounts = keyData.boundAccounts || [];
        if (boundAccounts.length > 0) {
            html += `<div><strong>${boundAccountsLabel}</strong></div>`;
            boundAccounts.forEach((account, index) => {
                const password = account.password || '';
                
                const accountLabel = currentLanguage === 'zh-CN' ? `è´¦å· ${index + 1}:` : 
                                   currentLanguage === 'zh-TW' ? `è³¬è™Ÿ ${index + 1}:` : `Account ${index + 1}:`;
                const emailLabel = currentLanguage === 'zh-CN' ? 'é‚®ç®±:' : 
                                 currentLanguage === 'zh-TW' ? 'éƒµç®±:' : 'Email:';
                const passwordLabel = currentLanguage === 'zh-CN' ? 'å¯†ç (base64):' : 
                                    currentLanguage === 'zh-TW' ? 'å¯†ç¢¼(base64):' : 'Password(base64):';
                const bindTimeLabel = currentLanguage === 'zh-CN' ? 'ç»‘å®šæ—¶é—´:' : 
                                    currentLanguage === 'zh-TW' ? 'ç¶å®šæ™‚é–“:' : 'Bind Time:';
                const lastLoginLabel = currentLanguage === 'zh-CN' ? 'æœ€åç™»å½•:' : 
                                     currentLanguage === 'zh-TW' ? 'æœ€å¾Œç™»éŒ„:' : 'Last Login:';
                
                html += `
                <div class="account-detail-item">
                    <strong>${accountLabel}</strong><br>
                    <strong>${emailLabel}</strong> ${account.email}<br>
                    <strong>${passwordLabel}</strong> ${password}<br>
                    <strong>${bindTimeLabel}</strong> ${new Date(account.bindTime).toLocaleString()}<br>
                    <strong>${lastLoginLabel}</strong> ${new Date(account.lastLogin).toLocaleString()}
                </div>`;
            });
        } else {
            html += `<div>${noAccountsLabel}</div>`;
        }

        detailsEl.innerHTML = html;
        modal.style.display = 'flex';
    }

    function closeAccountModal() {
        document.getElementById('accountModal').style.display = 'none';
    }

    function copyKey(keyToCopy) {
        navigator.clipboard.writeText(keyToCopy)
            .then(() => {
                updateStatus(`${currentLanguage === 'zh-CN' ? 'ç§˜é’¥ ' : 
                            currentLanguage === 'zh-TW' ? 'ç§˜é‘° ' : 'Key '}${keyToCopy.substring(0, 4)}... ${currentLanguage === 'zh-CN' ? 'å·²å¤åˆ¶æˆåŠŸï¼' : 
                            currentLanguage === 'zh-TW' ? 'å·²è¤‡è£½æˆåŠŸï¼' : 'copied successfully!'}`, false);
                logAction("ç§˜é’¥å¤åˆ¶", `ç§˜é’¥ ${keyToCopy} å·²å¤åˆ¶`, 'success');
            })
            .catch(err => {
                updateStatus(currentLanguage === 'zh-CN' ? 'ç§˜é’¥å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶' : 
                           currentLanguage === 'zh-TW' ? 'ç§˜é‘°è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½' : 'Key copy failed, please copy manually', true);
                logAction("ç§˜é’¥å¤åˆ¶", `ç§˜é’¥å¤åˆ¶å¤±è´¥: ${err.message}`, 'error');
            });
    }

    function handleSwitchAccount() {
        currentUser = null;
        currentToken = null;
        localStorage.removeItem('idToken');
        localStorage.removeItem('currentUser');
        
        if (isAdminMode) {
            switchSection('loginForm', ['menuButtons', 'adminPanel']);
            updateStatus(currentLanguage === 'zh-CN' ? "è¯·ç™»å½•æ–°çš„æ¸¸æˆè´¦å·" : 
                       currentLanguage === 'zh-TW' ? "è«‹ç™»éŒ„æ–°çš„éŠæˆ²è³¬è™Ÿ" : "Please login with new game account", false);
        } else {
            switchSection('loginForm', ['menuButtons']);
            updateStatus(currentLanguage === 'zh-CN' ? "è¯·ç™»å½•æ–°çš„æ¸¸æˆè´¦å·" : 
                       currentLanguage === 'zh-TW' ? "è«‹ç™»éŒ„æ–°çš„éŠæˆ²è³¬è™Ÿ" : "Please login with new game account", false);
        }
        
        logAction("åˆ‡æ¢è´¦å·", "åˆ‡æ¢åˆ°æ–°è´¦å·ç™»å½•", 'info');
    }

    function handleSwitchKey() {
        handleLogout(true);
        updateStatus(currentLanguage === 'zh-CN' ? "è¯·è¾“å…¥æ–°çš„ç§˜é’¥" : 
                   currentLanguage === 'zh-TW' ? "è«‹è¼¸å…¥æ–°çš„ç§˜é‘°" : "Please enter new key", false);
        logAction("åˆ‡æ¢ç§˜é’¥", "åˆ‡æ¢åˆ°æ–°ç§˜é’¥è¾“å…¥", 'info');
    }

    function handleReturnHome() {
        if (isAdminMode) {
            document.getElementById('adminPanel').style.display = 'none';
            switchSection('menuButtons', ['keyForm', 'loginForm']);
        } else {
            switchSection('menuButtons', ['keyForm', 'loginForm']);
        }
        updateStatus(currentLanguage === 'zh-CN' ? "å·²è¿”å›ä¸»èœå•" : 
                   currentLanguage === 'zh-TW' ? "å·²è¿”å›ä¸»èœå–®" : "Returned to main menu", false);
        logAction("å¯¼èˆª", "è¿”å›ä¸»èœå•", 'info');
    }

    function handleLogout(silent = false) {
        localStorage.removeItem('accessKey');
        localStorage.removeItem('idToken');
        localStorage.removeItem('expiryTime');
        localStorage.removeItem('currentUser');
        
        currentUser = null;
        currentToken = null;
        currentKey = null;
        isAdminMode = false;
        isSuperAdmin = false;
        isTestCard = false;

        document.getElementById('accessKey').value = '';
        document.getElementById('email').value = '';
        document.getElementById('password').value = '';
        document.getElementById('toggleAdminModeBtn').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'none';
        updateBindInfo();
        updateTestCardStatus(false);
        
        updateExpiryDisplay(null, null, null, true);
        switchSection('keyForm', ['loginForm', 'menuButtons']);

        if (!silent) {
            updateStatus(currentLanguage === 'zh-CN' ? "å·²æˆåŠŸé€€å‡ºç™»å½•ï¼Œè¯·é‡æ–°éªŒè¯ç§˜é’¥" : 
                       currentLanguage === 'zh-TW' ? "å·²æˆåŠŸé€€å‡ºç™»éŒ„ï¼Œè«‹é‡æ–°é©—è­‰ç§˜é‘°" : "Logged out successfully, please verify key again");
            logAction("é€€å‡º", "ç”¨æˆ·å·²é€€å‡ºç™»å½•", 'info');
        }
    }

    function initAuthCheck() {
        logAction("ç³»ç»Ÿåˆå§‹åŒ–", "æ£€æŸ¥æœ¬åœ°ç™»å½•çŠ¶æ€", 'info');
        const hasStored = loadAuthFromStorage();
        
        if (hasStored && currentKey) {
            updateStatus(currentLanguage === 'zh-CN' ? "å‘ç°ä¸Šæ¬¡ç™»å½•çŠ¶æ€ï¼Œæ­£åœ¨é‡æ–°éªŒè¯ç§˜é’¥..." : 
                       currentLanguage === 'zh-TW' ? "ç™¼ç¾ä¸Šæ¬¡ç™»éŒ„ç‹€æ…‹ï¼Œæ­£åœ¨é‡æ–°é©—è­‰ç§˜é‘°..." : 
                       "Found previous login status, re-verifying key...", false);
            document.getElementById('accessKey').value = currentKey; 
            
            handleCheckKey(currentKey).then(() => {
                if(isAdminMode && currentUser && currentToken) {
                    updateStatus(currentLanguage === 'zh-CN' ? `æ¬¢è¿å›æ¥ï¼Œ${isSuperAdmin ? 'è¶…çº§ç®¡ç†å‘˜' : 'ç®¡ç†å‘˜'} ${currentUser}ã€‚` : 
                               currentLanguage === 'zh-TW' ? `æ­¡è¿å›ä¾†ï¼Œ${isSuperAdmin ? 'è¶…ç´šç®¡ç†å“¡' : 'ç®¡ç†å“¡'} ${currentUser}ã€‚` : 
                               `Welcome back, ${isSuperAdmin ? 'super admin' : 'admin'} ${currentUser}.`);
                    switchSection('menuButtons', ['keyForm', 'loginForm']);
                } else if(currentUser && currentToken) {
                    updateStatus(currentLanguage === 'zh-CN' ? `æ¬¢è¿å›æ¥ï¼Œ${currentUser}ã€‚` : 
                               currentLanguage === 'zh-TW' ? `æ­¡è¿å›ä¾†ï¼Œ${currentUser}ã€‚` : 
                               `Welcome back, ${currentUser}.`);
                    switchSection('menuButtons', ['keyForm', 'loginForm']);
                }
            }); 
        } else {
            switchSection('keyForm', ['loginForm', 'menuButtons']);
            updateStatus(currentLanguage === 'zh-CN' ? "è¯·å…ˆè¾“å…¥ç§˜é’¥éªŒè¯" : 
                       currentLanguage === 'zh-TW' ? "è«‹å…ˆè¼¸å…¥ç§˜é‘°é©—è­‰" : "Please verify key first");
        }
    }

    document.addEventListener("DOMContentLoaded", () => {
        applyTranslations();
        
        initAuthCheck(); 

        document.getElementById('accessKey').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleCheckKey(); 
        });
        document.getElementById('password').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') handleLogin();
        });

        document.getElementById('accountModal').addEventListener('click', (e) => {
            if (e.target.id === 'accountModal') {
                closeAccountModal();
            }
        });
    });
</script>
</body>
</html>
