<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>9927ä¿±ä¹éƒ¨</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft YaHei', sans-serif; background: #ffffff; color: #333333; }
        .page { display: none; min-height: 100vh; }
        .page.active { display: block; }
        
        .login-container { width: 100%; max-width: 400px; margin: 100px auto; padding: 40px; background: #ffffff; border: 1px solid #e0e0e0; border-radius: 8px; }
        .login-title { text-align: center; font-size: 24px; margin-bottom: 30px; font-weight: normal; }
        .login-tabs { display: flex; margin-bottom: 30px; }
        .login-tab { flex: 1; padding: 12px; background: #f5f5f5; border: none; border-bottom: 2px solid #f5f5f5; font-size: 16px; color: #666; cursor: pointer; }
        .login-tab.active { background: #ffffff; border-bottom: 2px solid #000000; color: #000000; }
        .login-form { display: none; }
        .login-form.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        .form-input:focus { outline: none; border-color: #000000; }
        
        .btn { padding: 12px 24px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; text-align: center; display: inline-block; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn:active { opacity: 0.8; }
        .btn-black { background: #000000; color: #ffffff; }
        .btn-gray { background: #f0f0f0; color: #333; }
        .btn-red { background: #ff4444; color: white; }
        .btn-green { background: #00c853; color: white; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-purple { background: #9C27B0; color: white; }
        .btn-orange { background: #FF9800; color: white; }
        .btn-teal { background: #009688; color: white; }
        .btn-block { width: 100%; }
        
        .store-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .store-title { font-size: 20px; font-weight: normal; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        
        /* è´­ç‰©è½¦æŒ‰é’® */
        .cart-button {
            position: relative;
            padding: 8px 16px;
            background: #FF9800;
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* ğŸ”¥ ä¿®å¤ï¼šä¸€è¡Œæ˜¾ç¤ºä¸¤ä¸ªå•†å“ */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .product-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            background: white;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .product-img-container {
            width: 100%;
            height: 180px;
            overflow: hidden;
            position: relative;
            background: #f8f8f8;
            border-bottom: 1px solid #eee;
        }
        .product-img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            padding: 10px;
            transition: transform 0.3s ease;
        }
        .product-card:hover .product-img {
            transform: scale(1.05);
        }
        .product-info {
            padding: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .product-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            line-height: 1.4;
            height: 44px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .product-price {
            font-size: 18px;
            color: #000;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        /* å•†å“æ•°é‡é€‰æ‹©å™¨ */
        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border-radius: 4px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        
        /* ä¿®å¤æ”¯ä»˜äºŒç»´ç æ˜¾ç¤º */
        .payment-methods { display: flex; gap: 10px; margin-bottom: 15px; }
        .payment-option { flex: 1; border: 1px solid #ddd; border-radius: 4px; padding: 10px; cursor: pointer; text-align: center; }
        .payment-option:hover { border-color: #000; }
        .payment-option.active { border: 2px solid #000; background: #f9f9f9; }
        .payment-icon { 
            width: 100%; 
            height: 150px; 
            margin: 0 auto 5px; 
            background: #f5f5f5; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 4px; 
            overflow: hidden;
            padding: 10px;
        }
        .payment-icon img { 
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }
        .payment-name { font-size: 14px; color: #000; margin-top: 5px; font-weight: bold; }
        
        .admin-nav { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; gap: 10px; }
        .nav-btn { padding: 10px 20px; background: #f5f5f5; border: none; border-radius: 4px; cursor: pointer; }
        .nav-btn.active { background: #000; color: white; }
        .admin-content { padding: 20px; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .order-card { border: 1px solid #e0e0e0; border-radius: 4px; padding: 15px; margin-bottom: 15px; }
        .order-number { font-family: monospace; background: #f5f5f5; padding: 4px 8px; border-radius: 2px; }
        .order-status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-paid { background: #d4edda; color: #155724; }
        .status-completed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .message { position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: #000; color: white; border-radius: 4px; display: none; z-index: 1000; }
        .message.active { display: block; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 4px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 20px; }
        
        .customer-service { background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin: 20px; }
        .customer-service h3 { margin-bottom: 15px; font-size: 18px; text-align: center; color: #333; }
        .customer-service p { color: #666; margin-bottom: 15px; font-size: 14px; text-align: center; }
        .service-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 15px; }
        .service-btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 10px 20px; background: #25D366; color: white; text-decoration: none; border-radius: 4px; font-size: 14px; transition: all 0.3s ease; border: none; cursor: pointer; }
        .service-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .service-btn.whatsapp { background: #25D366; }
        .service-btn.wechat { background: #07C160; }
        .service-btn.facebook { background: #1877F2; }
        .service-btn.telegram { background: #0088cc; }
        
        /* è®¢å•å®Œæˆæç¤º */
        .order-success { 
            background: #d4edda; 
            color: #155724; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 20px 0; 
            border: 1px solid #c3e6cb;
            text-align: center;
        }
        
        /* ========== è´­ç‰©è½¦æ ·å¼ ========== */
        .cart-page {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .cart-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .cart-items {
            flex: 1;
        }
        
        .cart-summary {
            width: 300px;
            background: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }
        
        .cart-item {
            display: flex;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            align-items: center;
            gap: 15px;
        }
        
        .cart-item-img {
            width: 80px;
            height: 80px;
            object-fit: contain;
            background: #f8f8f8;
            border-radius: 4px;
            padding: 5px;
        }
        
        .cart-item-info {
            flex: 1;
        }
        
        .cart-item-price {
            font-weight: bold;
            color: #000;
            font-size: 18px;
        }
        
        .cart-item-total {
            font-weight: bold;
            color: #ff4444;
            font-size: 18px;
        }
        
        .empty-cart {
            text-align: center;
            padding: 50px;
            color: #999;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .summary-total {
            font-size: 20px;
            font-weight: bold;
            color: #000;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 2px solid #000;
        }
        
        /* æˆ‘çš„è®¢å•é¡µé¢æ ·å¼ */
        .my-orders {
            padding: 20px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .order-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 8px 16px;
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            background: #000;
            color: white;
            border-color: #000;
        }
        
        /* ========== æ–°å¢ï¼šèŠå¤©ç³»ç»Ÿæ ·å¼ ========== */
        /* èŠå¤©æŒ‰é’® - å›ºå®šåœ¨å³ä¸‹è§’ */
        .chat-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .chat-button:hover {
            background: #0b7dda;
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
        }
        .chat-button.has-unread::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            border: 2px solid white;
        }
        
        /* èŠå¤©çª—å£ */
        .chat-window {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1001;
            overflow: hidden;
        }
        .chat-window.active {
            display: flex;
        }
        .chat-header {
            padding: 15px 20px;
            background: #2196F3;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-title {
            font-weight: bold;
            font-size: 16px;
        }
        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
        }
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
        }
        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .chat-message {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            position: relative;
            word-wrap: break-word;
            line-height: 1.4;
        }
        .chat-message.user {
            align-self: flex-end;
            background: #2196F3;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .chat-message.support {
            align-self: flex-start;
            background: #e9ecef;
            color: #333;
            border-bottom-left-radius: 4px;
        }
        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }
        .chat-message.support .chat-message-time {
            text-align: left;
        }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 10px;
        }
        .chat-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
            font-size: 14px;
        }
        .chat-input:focus {
            border-color: #2196F3;
        }
        .chat-send {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* ç®¡ç†å‘˜èŠå¤©ç®¡ç†é¡µé¢ */
        .chat-sessions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .chat-session {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-session:hover {
            background: #f8f9fa;
            border-color: #2196F3;
        }
        .chat-session.active {
            background: #e3f2fd;
            border-color: #2196F3;
        }
        .session-info {
            flex: 1;
        }
        .session-user {
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .session-last-message {
            color: #666;
            font-size: 13px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px;
        }
        .session-time {
            color: #999;
            font-size: 12px;
        }
        .session-unread {
            background: #ff4444;
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            margin-left: 10px;
        }
        
        /* ç®¡ç†å‘˜èŠå¤©ç•Œé¢ */
        .admin-chat-container {
            display: flex;
            height: 600px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .admin-chat-sidebar {
            width: 300px;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }
        .admin-chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .admin-chat-header {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }
        .admin-chat-input {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
            display: flex;
            gap: 10px;
        }
        .admin-chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }
        .admin-chat-input button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #2196F3;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }
        
        /* æ¶ˆæ¯é€šçŸ¥ */
        .message-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            background: #000;
            color: white;
            border-radius: 4px;
            display: none;
            z-index: 1000;
        }
        .message-notification.active {
            display: block;
        }
        
        /* ========== å®¢æœç®¡ç†åå°æ ·å¼ ========== */
        .support-page {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .support-nav {
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            background: #f8f9fa;
        }
        
        .support-nav-btn {
            padding: 10px 20px;
            background: #e0e0e0;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .support-nav-btn.active {
            background: #009688;
            color: white;
        }
        
        .support-content {
            padding: 20px;
        }
        
        .support-tab-content {
            display: none;
        }
        
        .support-tab-content.active {
            display: block;
        }
        
        .support-order-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .support-search-box {
            flex: 1;
            max-width: 300px;
        }
        
        .support-role-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .badge-user {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .badge-admin {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .badge-support {
            background: #e8f5e8;
            color: #388e3c;
        }
        
        @media (max-width: 768px) {
            .cart-container {
                flex-direction: column;
            }
            .cart-summary {
                width: 100%;
            }
            .chat-window {
                width: calc(100% - 40px);
                right: 20px;
                bottom: 80px;
                height: 400px;
            }
            .chat-button {
                bottom: 20px;
                right: 20px;
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
                padding: 10px;
            }
            .product-img-container {
                height: 160px;
            }
            .store-header { flex-direction: column; gap: 15px; text-align: center; }
            .payment-icon { height: 120px; }
            .service-buttons { flex-direction: column; }
            .service-btn { width: 100%; }
            .admin-chat-container {
                flex-direction: column;
                height: 800px;
            }
            .admin-chat-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
            }
            .support-nav {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 480px) {
            .chat-window {
                width: calc(100% - 20px);
                right: 10px;
                height: 350px;
            }
            .products-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
                padding: 8px;
            }
            .product-img-container {
                height: 140px;
            }
            .product-name {
                font-size: 14px;
                height: 40px;
            }
            .product-price {
                font-size: 16px;
            }
        }
        
        .product-preview { width: 100%; max-height: 200px; object-fit: contain; background: #f8f8f8; border-radius: 4px; margin-top: 10px; border: 1px solid #e0e0e0; padding: 5px; }
    </style>
</head>
<body>
    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="message"></div>
    
    <!-- èŠå¤©æŒ‰é’® -->
    <button class="chat-button" onclick="toggleChatWindow()" id="chatButton">ğŸ’¬</button>
    
    <!-- ç”¨æˆ·èŠå¤©çª—å£ -->
    <div id="chatWindow" class="chat-window">
        <div class="chat-header">
            <div class="chat-title">ğŸ’ åœ¨çº¿å®¢æœ</div>
            <button class="chat-close" onclick="toggleChatWindow()">Ã—</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-messages" id="chatMessages">
                <div class="chat-message support">
                    æ‚¨å¥½ï¼æˆ‘æ˜¯å®¢æœï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ
                    <div class="chat-message-time">åˆšåˆš</div>
                </div>
            </div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleChatKeyPress(event)">
            <button class="chat-send" onclick="sendChatMessage()">ğŸ“¤</button>
        </div>
    </div>
    
    <!-- åŸæœ‰é¡µé¢ç»“æ„ -->
    <div id="loginPage" class="page active">
        <div class="login-container">
            <h2 class="login-title">9927ä¿±ä¹éƒ¨</h2>
            <div class="login-tabs">
                <button class="login-tab active" onclick="switchAuthTab('login')">ç™»å½•</button>
                <button class="login-tab" onclick="switchAuthTab('register')">æ³¨å†Œ</button>
            </div>
            <form id="loginForm" class="login-form active" onsubmit="return loginUser(event)">
                <div class="form-group">
                    <input type="text" class="form-input" id="loginUsername" placeholder="ç”¨æˆ·å" required value="">
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="loginPassword" placeholder="å¯†ç " required value="">
                </div>
                <button type="submit" class="btn btn-black btn-block">ç™»å½•</button>
                <p style="text-align: center; margin-top: 15px; color: #666; font-size: 14px;">
                   Â©2025 9927ä¿±ä¹éƒ¨ï¼Œä¿ç•™æ‰€æœ‰æƒåˆ©ï¼Œæœ¬ç½‘ç«™ç”±LLLLLç‹¬å®¶å¼€å‘æä¾›æŠ€æœ¯æ”¯æŒã€‚
                </p>
            </form>
            <form id="registerForm" class="login-form" onsubmit="return registerUser(event)">
                <div class="form-group">
                    <input type="text" class="form-input" id="registerUsername" placeholder="ç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="registerPassword" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="registerConfirmPassword" placeholder="ç¡®è®¤å¯†ç " required>
                </div>
                <button type="submit" class="btn btn-black btn-block">æ³¨å†Œ</button>
            </form>
        </div>
    </div>
    
    <!-- å•†åŸé¡µé¢ -->
    <div id="storePage" class="page">
        <div class="store-header">
            <div class="store-title" id="storeTitle">9927ä¿±ä¹éƒ¨</div>
            <div class="user-info">
                <span id="currentUser">ç”¨æˆ·</span>
                <span id="userRoleBadge" class="support-role-badge" style="display: none;"></span>
                <button class="btn btn-gray" onclick="logout()">é€€å‡º</button>
                <button class="btn btn-purple" onclick="showCartPage()" id="cartBtn">
                    ğŸ›’ è´­ç‰©è½¦ <span id="cartCount" class="cart-badge" style="display: none;">0</span>
                </button>
                <button class="btn btn-orange" onclick="showMyOrders()" id="ordersBtn">æˆ‘çš„è®¢å•</button>
                <button class="btn btn-black" onclick="showAdminPage()" id="adminBtn" style="display: none;">ç®¡ç†åå°</button>
                <button class="btn btn-teal" onclick="showSupportPage()" id="supportBtn" style="display: none;">å®¢æœåå°</button>
            </div>
        </div>
        <div id="customerService" class="customer-service" style="display: none;">
            <h3>ğŸ“è”ç³»å®¢æœ</h3>
            <p>ğŸ“¢æ‚¨è´­ä¹°äº†å•†å“å·²ä»˜æ¬¾äº†è¯·å¸¦æ‚¨çš„ä»˜æ¬¾è´¦å•å’Œæ‚¨çš„ç™»å½•çš„ç½‘ç«™è´¦å·åå­—å’Œè®¢å•å·è”ç³»å®¢æœäººå‘˜è°¢è°¢ä½ çš„åˆä½œ</p>
            <div class="service-buttons" id="serviceButtons"></div>
        </div>
        <div style="padding: 30px 20px; text-align: center;">
            <h3 style="font-size: 24px; margin-bottom: 10px;">æ¬¢è¿é€‰è´­</h3>
            <p style="color: #666;">ç‹¬åŸŸå•†åŸå¼ºåŠ›é©±åŠ¨3.0</p>
        </div>
        <div id="productsList" class="products-grid"></div>
    </div>
    
    <!-- è´­ç‰©è½¦é¡µé¢ -->
    <div id="cartPage" class="page">
        <div class="store-header">
            <div class="store-title">ğŸ›’ æˆ‘çš„è´­ç‰©è½¦</div>
            <div>
                <button class="btn btn-gray" onclick="showStorePage()">ç»§ç»­è´­ç‰©</button>
            </div>
        </div>
        <div class="cart-page">
            <div class="cart-container">
                <div class="cart-items">
                    <h3>è´­ç‰©è½¦å•†å“</h3>
                    <div id="cartItemsContainer">
                        <!-- è´­ç‰©è½¦å•†å“ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div class="cart-summary">
                    <h3>è®¢å•æ‘˜è¦</h3>
                    <div class="summary-row">
                        <span>å•†å“æ€»ä»·ï¼š</span>
                        <span id="cartSubtotal">Â¥0.00</span>
                    </div>
                    <div class="summary-row">
                        <span>å•†å“æ•°é‡ï¼š</span>
                        <span id="cartTotalQuantity">0</span>
                    </div>
                    <div class="summary-row summary-total">
                        <span>åº”ä»˜æ€»é¢ï¼š</span>
                        <span id="cartTotal">Â¥0.00</span>
                    </div>
                    <button class="btn btn-green btn-block" onclick="checkoutCart()" style="margin-top: 20px; padding: 15px; font-size: 18px;">
                        ğŸ’³ å»ç»“ç®—
                    </button>
                    <button class="btn btn-red btn-block" onclick="clearCart()" style="margin-top: 10px;">
                        æ¸…ç©ºè´­ç‰©è½¦
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æˆ‘çš„è®¢å•é¡µé¢ -->
    <div id="ordersPage" class="page">
        <div class="store-header">
            <div class="store-title">ğŸ“¦ æˆ‘çš„è®¢å•</div>
            <div>
                <button class="btn btn-gray" onclick="showStorePage()">è¿”å›å•†åŸ</button>
            </div>
        </div>
        <div class="my-orders">
            <div class="order-filter">
                <button class="filter-btn active" onclick="filterMyOrders('all')">å…¨éƒ¨è®¢å•</button>
                <button class="filter-btn" onclick="filterMyOrders('pending')">å¾…ä»˜æ¬¾</button>
                <button class="filter-btn" onclick="filterMyOrders('paid')">å·²ä»˜æ¬¾</button>
                <button class="filter-btn" onclick="filterMyOrders('completed')">å·²å®Œæˆ</button>
                <button class="filter-btn" onclick="filterMyOrders('cancelled')">å·²å–æ¶ˆ</button>
            </div>
            <div id="myOrdersList">
                <!-- ç”¨æˆ·è®¢å•ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <!-- å®¢æœåå°é¡µé¢ -->
    <div id="supportPage" class="page">
        <div class="store-header">
            <div class="store-title">ğŸ’ å®¢æœåå°</div>
            <div>
                <button class="btn btn-gray" onclick="showStorePage()">è¿”å›å•†åŸ</button>
            </div>
        </div>
        <div class="support-nav">
            <button class="support-nav-btn active" onclick="switchSupportTab('orders')">è®¢å•ç®¡ç†</button>
            <button class="support-nav-btn" onclick="switchSupportTab('chat')">èŠå¤©ç®¡ç†</button>
        </div>
        <div class="support-content">
            <!-- å®¢æœè®¢å•ç®¡ç† -->
            <div id="supportOrdersTab" class="support-tab-content active">
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3>ğŸ“¦ è®¢å•ç®¡ç†</h3>
                    <div class="support-order-filters">
                        <div class="support-search-box">
                            <input type="text" class="form-input" id="supportOrderSearch" placeholder="æœç´¢è®¢å•å·æˆ–ç”¨æˆ·å..." oninput="searchSupportOrders()">
                        </div>
                        <select class="form-input" style="width: auto;" id="supportOrderFilter" onchange="filterSupportOrders(this.value)">
                            <option value="all">å…¨éƒ¨è®¢å•</option>
                            <option value="today">ä»Šæ—¥è®¢å•</option>
                            <option value="pending">å¾…ä»˜æ¬¾</option>
                            <option value="paid">å·²ä»˜æ¬¾</option>
                            <option value="completed">å·²å®Œæˆ</option>
                            <option value="cancelled">å·²å–æ¶ˆ</option>
                        </select>
                        <button class="btn btn-blue" onclick="refreshSupportOrders()">åˆ·æ–°</button>
                    </div>
                </div>
                <div id="supportOrdersList">
                    <!-- å®¢æœè®¢å•åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- å®¢æœèŠå¤©ç®¡ç† -->
            <div id="supportChatTab" class="support-tab-content">
                <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                    <h3>ğŸ’¬ èŠå¤©ç®¡ç†</h3>
                    <div>
                        <button class="btn btn-blue" onclick="refreshSupportChatSessions()">åˆ·æ–°ä¼šè¯</button>
                    </div>
                </div>
                
                <div class="admin-chat-container">
                    <div class="admin-chat-sidebar">
                        <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
                            <h4>èŠå¤©ä¼šè¯</h4>
                            <div style="font-size: 12px; color: #666; margin-top: 5px;">å…± <span id="supportSessionCount">0</span> ä¸ªä¼šè¯</div>
                        </div>
                        <div id="supportChatSessions" class="chat-sessions" style="flex: 1; overflow-y: auto; padding: 10px;">
                            <!-- å®¢æœèŠå¤©ä¼šè¯åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div class="admin-chat-main">
                        <div class="admin-chat-header" id="supportChatHeader">
                            <div style="color: #999; text-align: center;">è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©ä¼šè¯</div>
                        </div>
                        <div class="admin-chat-messages" id="supportChatMessages">
                            <!-- å®¢æœèŠå¤©æ¶ˆæ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div class="admin-chat-input" id="supportChatInput" style="display: none;">
                            <input type="text" id="supportChatInputField" placeholder="è¾“å…¥å›å¤æ¶ˆæ¯..." onkeypress="handleSupportChatKeyPress(event)">
                            <button onclick="sendSupportChatMessage()">ğŸ“¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç®¡ç†å‘˜åå°é¡µé¢ -->
    <div id="adminPage" class="page">
        <div class="store-header">
            <div class="store-title">ç®¡ç†åå°</div>
            <div>
                <button class="btn btn-gray" onclick="showStorePage()">è¿”å›å•†åŸ</button>
            </div>
        </div>
        <div class="admin-nav">
            <button class="nav-btn active" onclick="switchTab('products')">å•†å“ç®¡ç†</button>
            <button class="nav-btn" onclick="switchTab('orders')">è®¢å•ç®¡ç†</button>
            <button class="nav-btn" onclick="switchTab('chat')">èŠå¤©ç®¡ç†</button>
            <button class="nav-btn" onclick="switchTab('services')">å®¢æœç®¡ç†</button>
            <button class="nav-btn" onclick="switchTab('supportAccounts')">å®¢æœè´¦å·</button>
            <button class="nav-btn" onclick="switchTab('settings')">è®¾ç½®</button>
        </div>
        <div id="productsTab" class="admin-content tab-content active">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3>å•†å“ç®¡ç†</h3>
                <button class="btn btn-black" onclick="showAddProductModal()">æ·»åŠ å•†å“</button>
            </div>
            <div style="margin-bottom: 30px; padding: 20px; background: #f5f5f5; border-radius: 4px;">
                <div class="form-group">
                    <input type="text" class="form-input" id="productName" placeholder="å•†å“åç§°" required>
                </div>
                <div class="form-group">
                    <input type="number" class="form-input" id="productPrice" placeholder="ä»·æ ¼" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <textarea class="form-input" id="productDesc" placeholder="å•†å“æè¿°" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" id="productImage" placeholder="å›¾ç‰‡é“¾æ¥" oninput="updateImagePreview(this.value)">
                </div>
                <div id="imagePreviewContainer" style="display: none;">
                    <div style="color: #666; margin: 10px 0 5px; font-size: 14px;">å›¾ç‰‡é¢„è§ˆï¼š</div>
                    <img id="imagePreview" class="product-preview" src="" alt="å›¾ç‰‡é¢„è§ˆ">
                    <div id="imageInfo" style="color: #999; font-size: 12px; margin-top: 5px;"></div>
                </div>
                <button class="btn btn-black" onclick="addProduct()">æ·»åŠ å•†å“</button>
            </div>
            <div id="adminProducts"></div>
        </div>
        <div id="ordersTab" class="admin-content tab-content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3>è®¢å•ç®¡ç†</h3>
                <select class="form-input" style="width: auto;" id="orderFilterSelect" onchange="filterOrders(this.value)">
                    <option value="all">å…¨éƒ¨è®¢å•</option>
                    <option value="today">ä»Šæ—¥è®¢å•</option>
                    <option value="pending">å¾…ä»˜æ¬¾</option>
                    <option value="paid">å·²ä»˜æ¬¾</option>
                    <option value="completed">å·²å®Œæˆ</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                </select>
            </div>
            <div id="ordersList"></div>
        </div>
        
        <!-- ç®¡ç†å‘˜èŠå¤©ç®¡ç† -->
        <div id="chatTab" class="admin-content tab-content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ’¬ èŠå¤©ç®¡ç†</h3>
                <div>
                    <button class="btn btn-blue" onclick="refreshChatSessions()">åˆ·æ–°ä¼šè¯</button>
                    <button class="btn btn-green" onclick="markAllAsRead()" style="margin-left: 10px;">å…¨éƒ¨æ ‡ä¸ºå·²è¯»</button>
                </div>
            </div>
            
            <div class="admin-chat-container">
                <div class="admin-chat-sidebar">
                    <div style="padding: 15px; border-bottom: 1px solid #e0e0e0;">
                        <h4>èŠå¤©ä¼šè¯</h4>
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">å…± <span id="sessionCount">0</span> ä¸ªä¼šè¯</div>
                    </div>
                    <div id="chatSessions" class="chat-sessions" style="flex: 1; overflow-y: auto; padding: 10px;">
                        <!-- èŠå¤©ä¼šè¯åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="admin-chat-main">
                    <div class="admin-chat-header" id="adminChatHeader">
                        <div style="color: #999; text-align: center;">è¯·é€‰æ‹©ä¸€ä¸ªèŠå¤©ä¼šè¯</div>
                    </div>
                    <div class="admin-chat-messages" id="adminChatMessages">
                        <!-- èŠå¤©æ¶ˆæ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                    <div class="admin-chat-input" id="adminChatInput" style="display: none;">
                        <input type="text" id="adminChatInputField" placeholder="è¾“å…¥å›å¤æ¶ˆæ¯..." onkeypress="handleAdminChatKeyPress(event)">
                        <button onclick="sendAdminChatMessage()">ğŸ“¤</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- å®¢æœæ¸ é“ç®¡ç† -->
        <div id="servicesTab" class="admin-content tab-content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3>å®¢æœæ¸ é“ç®¡ç†</h3>
                <button class="btn btn-black" onclick="showAddServiceModal()">æ·»åŠ å®¢æœæ¸ é“</button>
            </div>
            <div style="margin-bottom: 30px; padding: 20px; background: #f5f5f5; border-radius: 4px;">
                <div class="form-group">
                    <select class="form-input" id="serviceType">
                        <option value="whatsapp">WhatsApp</option>
                        <option value="wechat">å¾®ä¿¡</option>
                        <option value="telegram">Telegram</option>
                        <option value="facebook">Facebook</option>
                        <option value="phone">ç”µè¯</option>
                        <option value="other">å…¶ä»–</option>
                    </select>
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" id="serviceName" placeholder="å®¢æœæ¸ é“åç§°">
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" id="serviceLink" placeholder="å®¢æœé“¾æ¥">
                </div>
                <button class="btn btn-black" onclick="addService()">æ·»åŠ å®¢æœæ¸ é“</button>
            </div>
            <div id="servicesList"></div>
        </div>
        
        <!-- å®¢æœè´¦å·ç®¡ç†ï¼ˆæ–°å¢ï¼‰ -->
        <div id="supportAccountsTab" class="admin-content tab-content">
            <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <h3>ğŸ‘¥ å®¢æœè´¦å·ç®¡ç†</h3>
                <button class="btn btn-black" onclick="showAddSupportModal()">æ·»åŠ å®¢æœè´¦å·</button>
            </div>
            <div style="margin-bottom: 30px; padding: 20px; background: #f5f5f5; border-radius: 4px;">
                <div class="form-group">
                    <input type="text" class="form-input" id="supportUsername" placeholder="å®¢æœç”¨æˆ·å" required>
                </div>
                <div class="form-group">
                    <input type="password" class="form-input" id="supportPassword" placeholder="å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰" required minlength="6">
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" id="supportDisplayName" placeholder="æ˜¾ç¤ºåç§°ï¼ˆå¯é€‰ï¼‰">
                </div>
                <div class="form-group">
                    <label style="display: block; margin-bottom: 5px;">æƒé™è®¾ç½®ï¼š</label>
                    <div style="display: flex; gap: 20px;">
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="supportCanViewOrders" checked>
                            æŸ¥çœ‹è®¢å•
                        </label>
                        <label style="display: flex; align-items: center; gap: 5px;">
                            <input type="checkbox" id="supportCanChat" checked>
                            èŠå¤©å›å¤
                        </label>
                    </div>
                </div>
                <button class="btn btn-black" onclick="addSupportAccount()">æ·»åŠ å®¢æœè´¦å·</button>
            </div>
            <div id="supportAccountsList">
                <!-- å®¢æœè´¦å·åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
        
        <div id="settingsTab" class="admin-content tab-content">
            <h3 style="margin-bottom: 20px;">ç³»ç»Ÿè®¾ç½®</h3>
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;">å•†åŸåç§°</label>
                <input type="text" class="form-input" id="settingStoreName">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 5px;">å¿«æ‰‹é“¾æ¥</label>
                <input type="text" class="form-input" id="settingKuaishouLink">
            </div>
            <div class="form-group">
                <label style="display: block; margin-bottom: 10px;">å®¢æœåŠŸèƒ½</label>
                <div style="display: flex; align-items: center; gap: 10px;">
                    <input type="checkbox" id="settingEnableService" style="width: auto;">
                    <label for="settingEnableService">åœ¨å•†åŸé¡µé¢æ˜¾ç¤ºå®¢æœåŠŸèƒ½</label>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 30px;">
                <button class="btn btn-black" onclick="saveSettings()">ä¿å­˜è®¾ç½®</button>
                <button class="btn btn-gray" onclick="exportData()">å¤‡ä»½æ•°æ®</button>
                <button class="btn btn-gray" onclick="importData()">æ¢å¤æ•°æ®</button>
            </div>
        </div>
    </div>
    
    <!-- è´­ç‰©è½¦ç»“ç®—æ¨¡æ€æ¡† -->
    <div id="cartCheckoutModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡®è®¤è®¢å•</h3>
                <button onclick="closeModal('cartCheckoutModal')" style="background: none; border: none; font-size: 20px; cursor: pointer;">Ã—</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin: 20px 0;">
                    <div style="font-size: 14px; color: #666; margin-bottom: 5px;">è®¢å•å·</div>
                    <div id="cartOrderNumber" style="font-family: monospace; font-size: 20px; font-weight: bold; margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px;"></div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">è¯·ä¿å­˜è®¢å•å·ç”¨äºè”ç³»å®¢æœ</div>
                </div>
                <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 4px;">
                    <div id="cartOrderItems">
                        <!-- è®¢å•å•†å“åˆ—è¡¨ä¼šåœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div style="display: flex; justify-content: space-between; font-weight: bold; margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd;">
                        <span>åº”ä»˜æ€»é¢ï¼š</span>
                        <span id="cartOrderTotal">Â¥0.00</span>
                    </div>
                </div>
                <div style="margin: 20px 0;">
                    <div style="color: #666; margin-bottom: 15px;">è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼æ‰«ç ä»˜æ¬¾ï¼š</div>
                    <div class="payment-methods">
                        <div class="payment-option active" onclick="selectCartPayment('tng')">
                            <div class="payment-icon">
                                <img src="https://i.ibb.co/TBF0r3jL/image.jpg" alt="Touch'n GoäºŒç»´ç ">
                            </div>
                            <div class="payment-name">Touch 'n Go</div>
                        </div>
                        <div class="payment-option" onclick="selectCartPayment('alipay')">
                            <div class="payment-icon">
                                <img src="https://i.ibb.co/Ng4h6gT6/image.jpg" alt="æ”¯ä»˜å®äºŒç»´ç ">
                            </div>
                            <div class="payment-name">æ”¯ä»˜å®</div>
                        </div>
                    </div>
                    <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 14px;">
                        ğŸ’¡ ä»˜æ¬¾åè¯·æˆªå›¾ä¿å­˜ï¼Œè”ç³»å®¢æœæ—¶éœ€è¦æä¾›
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-black" style="flex: 1;" onclick="copyCartOrderNumber()">å¤åˆ¶è®¢å•å·</button>
                    <button class="btn btn-green" style="flex: 1;" onclick="completeCartOrder()">å®Œæˆæ”¯ä»˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å•†åŸç³»ç»Ÿæ ¸å¿ƒä»£ç  ==========
        console.log('å•†åŸç³»ç»Ÿå¯åŠ¨...');
        
        const API_BASE_URL = 'https://9927club1.up.railway.app/api';
        
        let data = {
            products: [],
            services: [],
            settings: {},
            orders: [],
            chats: [],
            chatMessages: {},
            supportAccounts: [] // æ–°å¢ï¼šå®¢æœè´¦å·åˆ—è¡¨
        };
        
        let currentUser = null;
        let currentProductId = null;
        let selectedPayment = 'tng';
        let autoRefreshInterval = null;
        let currentOrderFilter = 'all';
        
        // ========== è´­ç‰©è½¦ç³»ç»Ÿå˜é‡ ==========
        let shoppingCart = [];
        let cartSelectedPayment = 'tng';
        
        // ========== èŠå¤©ç³»ç»Ÿå˜é‡ ==========
        let currentChatSession = null;
        let chatUpdateInterval = null;
        let adminCurrentChatId = null;
        let adminChatUpdateInterval = null;
        let chatUnreadCount = 0;
        
        // ========== å®¢æœç³»ç»Ÿå˜é‡ ==========
        let supportCurrentChatId = null;
        let supportChatUpdateInterval = null;
        let supportCurrentFilter = 'all';
        let supportSearchKeyword = '';
        
        // ========== ä»åç«¯åŠ è½½æ‰€æœ‰æ•°æ® ==========
        async function loadAllData() {
            try {
                console.log('ğŸ”„ åŠ è½½æ‰€æœ‰æ•°æ®...');
                
                // åŠ è½½å•†å“
                const productsRes = await fetch(`${API_BASE_URL}/products`);
                const productsData = await productsRes.json();
                if (productsData.success) data.products = productsData.data || [];
                
                // åŠ è½½è®¾ç½®
                const settingsRes = await fetch(`${API_BASE_URL}/settings`);
                const settingsData = await settingsRes.json();
                if (settingsData.success) data.settings = settingsData.data || {};
                
                // åŠ è½½å®¢æœæ¸ é“
                const servicesRes = await fetch(`${API_BASE_URL}/services/all`);
                const servicesData = await servicesRes.json();
                if (servicesData.success) data.services = servicesData.data || [];
                
                // åŠ è½½è®¢å•
                const ordersRes = await fetch(`${API_BASE_URL}/orders`);
                const ordersData = await ordersRes.json();
                if (ordersData.success) data.orders = ordersData.data || [];
                
                // åŠ è½½å®¢æœè´¦å·ï¼ˆåªæœ‰ç®¡ç†å‘˜å¯ä»¥çœ‹åˆ°ï¼‰
                if (currentUser && currentUser.isAdmin) {
                    await loadSupportAccounts();
                }
                
                // åŠ è½½è´­ç‰©è½¦ï¼ˆå¦‚æœç”¨æˆ·å·²ç™»å½•ï¼‰
                if (currentUser) {
                    await loadUserCart();
                    await loadUserOrders();
                }
                
                // å¦‚æœæ˜¯ç®¡ç†å‘˜æˆ–å®¢æœï¼ŒåŠ è½½èŠå¤©ä¼šè¯
                if (currentUser && (currentUser.isAdmin || currentUser.isSupport)) {
                    await loadChatSessions();
                }
                
                console.log('âœ… æ‰€æœ‰æ•°æ®åŠ è½½å®Œæˆ');
                return true;
            } catch (error) {
                console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
                return false;
            }
        }
        
        // ========== åŠ è½½å®¢æœè´¦å· ==========
        async function loadSupportAccounts() {
            try {
                const response = await fetch(`${API_BASE_URL}/support/accounts`);
                const result = await response.json();
                
                if (result.success) {
                    data.supportAccounts = result.data || [];
                    
                    // å¦‚æœå½“å‰åœ¨å®¢æœè´¦å·ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                    if (document.getElementById('supportAccountsTab').classList.contains('active')) {
                        renderSupportAccounts();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½å®¢æœè´¦å·å¤±è´¥:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆå¼€å‘ç”¨ï¼‰
                if (data.supportAccounts.length === 0) {
                    data.supportAccounts = [
                        { id: 1, username: 'support1', displayName: 'å®¢æœå°å¼ ', createdAt: new Date().toISOString(), canViewOrders: true, canChat: true },
                        { id: 2, username: 'support2', displayName: 'å®¢æœå°æ', createdAt: new Date().toISOString(), canViewOrders: true, canChat: true }
                    ];
                }
            }
        }
        
        // ========== æ·»åŠ å®¢æœè´¦å· ==========
        async function addSupportAccount() {
            const username = document.getElementById('supportUsername').value;
            const password = document.getElementById('supportPassword').value;
            const displayName = document.getElementById('supportDisplayName').value;
            const canViewOrders = document.getElementById('supportCanViewOrders').checked;
            const canChat = document.getElementById('supportCanChat').checked;
            
            if (!username || !password) {
                showMessage('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ï¼', 'error');
                return;
            }
            
            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½ï¼', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/support/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username,
                        password,
                        displayName,
                        canViewOrders,
                        canChat,
                        isSupport: true
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadSupportAccounts();
                    
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('supportUsername').value = '';
                    document.getElementById('supportPassword').value = '';
                    document.getElementById('supportDisplayName').value = '';
                    
                    showMessage('å®¢æœè´¦å·æ·»åŠ æˆåŠŸï¼');
                } else {
                    showMessage(result.error || 'æ·»åŠ å®¢æœè´¦å·å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                console.error('æ·»åŠ å®¢æœè´¦å·å¤±è´¥:', error);
                showMessage('æ·»åŠ å®¢æœè´¦å·å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ========== æ¸²æŸ“å®¢æœè´¦å·åˆ—è¡¨ ==========
        function renderSupportAccounts() {
            const container = document.getElementById('supportAccountsList');
            
            if (!data.supportAccounts || data.supportAccounts.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— å®¢æœè´¦å·</div>';
                return;
            }
            
            container.innerHTML = data.supportAccounts.map(account => `
                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                ${account.displayName || account.username}
                                <span class="support-role-badge badge-support">å®¢æœ</span>
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                è´¦å·ï¼š${account.username}
                            </div>
                            <div style="color: #666; font-size: 14px; margin-top: 5px;">
                                æƒé™ï¼š${account.canViewOrders ? 'æŸ¥çœ‹è®¢å•' : ''} ${account.canChat ? 'ã€èŠå¤©å›å¤' : ''}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #999; font-size: 12px;">
                                åˆ›å»ºæ—¶é—´ï¼š${account.createdAt ? new Date(account.createdAt).toLocaleDateString('zh-CN') : 'æœªçŸ¥'}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <button class="btn btn-red" onclick="deleteSupportAccount(${account.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ========== åˆ é™¤å®¢æœè´¦å· ==========
        async function deleteSupportAccount(accountId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå®¢æœè´¦å·å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/support/delete/${accountId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadSupportAccounts();
                    showMessage('å®¢æœè´¦å·å·²åˆ é™¤');
                } else {
                    showMessage(result.error || 'åˆ é™¤å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤å®¢æœè´¦å·å¤±è´¥:', error);
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ========== åŠ è½½ç”¨æˆ·è´­ç‰©è½¦ ==========
        async function loadUserCart() {
            try {
                if (!currentUser) return;
                
                const response = await fetch(`${API_BASE_URL}/cart/${currentUser.username}`);
                const result = await response.json();
                
                if (result.success) {
                    shoppingCart = result.data || [];
                    updateCartUI();
                }
            } catch (error) {
                console.error('åŠ è½½è´­ç‰©è½¦å¤±è´¥:', error);
            }
        }
        
        // ========== åŠ è½½ç”¨æˆ·è®¢å• ==========
        async function loadUserOrders() {
            try {
                if (!currentUser) return;
                
                const response = await fetch(`${API_BASE_URL}/orders/user/${currentUser.username}`);
                const result = await response.json();
                
                if (result.success) {
                    // ä¿å­˜ç”¨æˆ·è®¢å•åˆ°æœ¬åœ°
                    localStorage.setItem(`userOrders_${currentUser.username}`, JSON.stringify(result.data || []));
                    
                    // å¦‚æœå½“å‰åœ¨æˆ‘çš„è®¢å•é¡µé¢ï¼Œåˆ·æ–°æ˜¾ç¤º
                    if (document.getElementById('ordersPage').classList.contains('active')) {
                        renderMyOrders();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·è®¢å•å¤±è´¥:', error);
            }
        }
        
        // ========== æ›´æ–°è´­ç‰©è½¦UI ==========
        function updateCartUI() {
            const cartCount = document.getElementById('cartCount');
            const totalItems = shoppingCart.reduce((total, item) => total + item.quantity, 0);
            
            if (totalItems > 0) {
                cartCount.textContent = totalItems;
                cartCount.style.display = 'flex';
            } else {
                cartCount.style.display = 'none';
            }
            
            // å¦‚æœå½“å‰åœ¨è´­ç‰©è½¦é¡µé¢ï¼Œæ›´æ–°è´­ç‰©è½¦æ˜¾ç¤º
            if (document.getElementById('cartPage').classList.contains('active')) {
                renderCartItems();
                updateCartSummary();
            }
        }
        
        // ========== æ·»åŠ å•†å“åˆ°è´­ç‰©è½¦ ==========
        async function addToCart(productId, quantity = 1) {
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ï¼', 'error');
                return;
            }
            
            const product = data.products.find(p => p.id == productId);
            if (!product) {
                showMessage('å•†å“ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/cart/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.username,
                        productId: product.id,
                        productName: product.name,
                        productPrice: product.price,
                        quantity: quantity,
                        productImage: product.image
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadUserCart();
                    showMessage('å·²æ·»åŠ åˆ°è´­ç‰©è½¦ï¼');
                } else {
                    showMessage(result.error || 'æ·»åŠ åˆ°è´­ç‰©è½¦å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ åˆ°è´­ç‰©è½¦å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ========== æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡ ==========
        async function updateCartItemQuantity(productId, quantity) {
            try {
                const response = await fetch(`${API_BASE_URL}/cart/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.username,
                        productId: productId,
                        quantity: quantity
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadUserCart();
                }
            } catch (error) {
                console.error('æ›´æ–°è´­ç‰©è½¦æ•°é‡å¤±è´¥:', error);
            }
        }
        
        // ========== ä»è´­ç‰©è½¦åˆ é™¤å•†å“ ==========
        async function removeFromCart(productId) {
            try {
                const response = await fetch(`${API_BASE_URL}/cart/remove`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: currentUser.username,
                        productId: productId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadUserCart();
                    showMessage('å·²ä»è´­ç‰©è½¦ç§»é™¤');
                }
            } catch (error) {
                console.error('åˆ é™¤è´­ç‰©è½¦å•†å“å¤±è´¥:', error);
            }
        }
        
        // ========== æ¸…ç©ºè´­ç‰©è½¦ ==========
        async function clearCart() {
            if (shoppingCart.length === 0) {
                showMessage('è´­ç‰©è½¦å·²ç»æ˜¯ç©ºçš„', 'info');
                return;
            }
            
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºè´­ç‰©è½¦å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/cart/clear/${currentUser.username}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    shoppingCart = [];
                    updateCartUI();
                    showMessage('è´­ç‰©è½¦å·²æ¸…ç©º');
                }
            } catch (error) {
                console.error('æ¸…ç©ºè´­ç‰©è½¦å¤±è´¥:', error);
            }
        }
        
        // ========== æ¸²æŸ“è´­ç‰©è½¦å•†å“ ==========
        function renderCartItems() {
            const container = document.getElementById('cartItemsContainer');
            
            if (shoppingCart.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ›’</div>
                        <h3>è´­ç‰©è½¦æ˜¯ç©ºçš„</h3>
                        <p style="color: #666; margin: 10px 0;">å¿«å»æ·»åŠ ä¸€äº›å•†å“å§ï¼</p>
                        <button class="btn btn-black" onclick="showStorePage()" style="margin-top: 20px;">å»è´­ç‰©</button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = shoppingCart.map(item => `
                <div class="cart-item">
                    <img src="${item.productImage || 'https://via.placeholder.com/80x80.png?text=å•†å“'}" 
                         alt="${item.productName}" 
                         class="cart-item-img"
                         onerror="this.src='https://via.placeholder.com/80x80.png?text=å•†å“'">
                    <div class="cart-item-info">
                        <div style="font-weight: bold; margin-bottom: 5px;">${item.productName}</div>
                        <div class="cart-item-price">å•ä»·ï¼šÂ¥${item.productPrice.toFixed(2)}</div>
                        <div class="quantity-control" style="margin-top: 10px;">
                            <button class="quantity-btn" onclick="updateCartItemQty(${item.productId}, ${item.quantity - 1})">-</button>
                            <input type="number" class="quantity-input" value="${item.quantity}" min="1" 
                                   onchange="updateCartItemQty(${item.productId}, this.value)">
                            <button class="quantity-btn" onclick="updateCartItemQty(${item.productId}, ${item.quantity + 1})">+</button>
                            <button class="btn btn-red" onclick="removeFromCart(${item.productId})" style="margin-left: 10px;">åˆ é™¤</button>
                        </div>
                    </div>
                    <div class="cart-item-total">
                        Â¥${(item.productPrice * item.quantity).toFixed(2)}
                    </div>
                </div>
            `).join('');
        }
        
        // ========== æ›´æ–°è´­ç‰©è½¦å•†å“æ•°é‡ï¼ˆå‰ç«¯ï¼‰ ==========
        function updateCartItemQty(productId, newQuantity) {
            newQuantity = parseInt(newQuantity);
            if (isNaN(newQuantity) || newQuantity < 1) {
                newQuantity = 1;
            }
            
            updateCartItemQuantity(productId, newQuantity);
        }
        
        // ========== æ›´æ–°è´­ç‰©è½¦æ‘˜è¦ ==========
        function updateCartSummary() {
            const subtotal = shoppingCart.reduce((total, item) => 
                total + (item.productPrice * item.quantity), 0);
            const totalQuantity = shoppingCart.reduce((total, item) => total + item.quantity, 0);
            
            document.getElementById('cartSubtotal').textContent = `Â¥${subtotal.toFixed(2)}`;
            document.getElementById('cartTotalQuantity').textContent = totalQuantity;
            document.getElementById('cartTotal').textContent = `Â¥${subtotal.toFixed(2)}`;
        }
        
        // ========== è´­ç‰©è½¦ç»“ç®— ==========
        function checkoutCart() {
            if (shoppingCart.length === 0) {
                showMessage('è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼Œè¯·å…ˆæ·»åŠ å•†å“', 'error');
                return;
            }
            
            // ç”Ÿæˆè®¢å•å·
            const now = new Date();
            const orderNumber = 'DD' + now.getFullYear().toString().substr(2) + 
                               (now.getMonth() + 1).toString().padStart(2, '0') + 
                               now.getDate().toString().padStart(2, '0') + 
                               Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            document.getElementById('cartOrderNumber').textContent = orderNumber;
            
            // æ¸²æŸ“è®¢å•å•†å“åˆ—è¡¨
            const cartItemsContainer = document.getElementById('cartOrderItems');
            const subtotal = shoppingCart.reduce((total, item) => 
                total + (item.productPrice * item.quantity), 0);
            
            cartItemsContainer.innerHTML = shoppingCart.map(item => `
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #eee;">
                    <div>
                        <div>${item.productName} Ã— ${item.quantity}</div>
                        <div style="font-size: 12px; color: #666;">å•ä»·ï¼šÂ¥${item.productPrice.toFixed(2)}</div>
                    </div>
                    <div>Â¥${(item.productPrice * item.quantity).toFixed(2)}</div>
                </div>
            `).join('');
            
            document.getElementById('cartOrderTotal').textContent = `Â¥${subtotal.toFixed(2)}`;
            document.getElementById('cartCheckoutModal').classList.add('active');
        }
        
        // ========== å®Œæˆè´­ç‰©è½¦è®¢å• ==========
        async function completeCartOrder() {
            if (shoppingCart.length === 0) {
                showMessage('è´­ç‰©è½¦æ˜¯ç©ºçš„ï¼', 'error');
                return;
            }
            
            const orderNumber = document.getElementById('cartOrderNumber').textContent;
            const subtotal = shoppingCart.reduce((total, item) => 
                total + (item.productPrice * item.quantity), 0);
            
            try {
                // åˆ›å»ºè®¢å•
                const response = await fetch(`${API_BASE_URL}/orders/cart`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderNumber: orderNumber,
                        userId: currentUser.username,
                        cartItems: shoppingCart,
                        totalAmount: subtotal,
                        paymentMethod: cartSelectedPayment,
                        status: 'pending'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ¸…ç©ºè´­ç‰©è½¦
                    await clearCart();
                    
                    // å…³é—­æ¨¡æ€æ¡†
                    closeModal('cartCheckoutModal');
                    
                    // é‡æ–°åŠ è½½æ•°æ®
                    await loadAllData();
                    
                    // è·³è½¬åˆ°æˆ‘çš„è®¢å•é¡µé¢
                    showMyOrders();
                    
                    showMessage(`è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·ï¼š${orderNumber}ï¼Œè¯·æˆªå›¾ä¿å­˜äºŒç»´ç å¹¶è”ç³»å®¢æœ`);
                } else {
                    showMessage(result.error || 'åˆ›å»ºè®¢å•å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('åˆ›å»ºè®¢å•å¤±è´¥', 'error');
            }
        }
        
        // ========== é€‰æ‹©è´­ç‰©è½¦æ”¯ä»˜æ–¹å¼ ==========
        function selectCartPayment(payment) {
            cartSelectedPayment = payment;
            document.querySelectorAll('#cartCheckoutModal .payment-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.payment-option').classList.add('active');
        }
        
        // ========== å¤åˆ¶è´­ç‰©è½¦è®¢å•å· ==========
        function copyCartOrderNumber() {
            const orderNumber = document.getElementById('cartOrderNumber').textContent;
            navigator.clipboard.writeText(orderNumber).then(() => {
                showMessage('è®¢å•å·å·²å¤åˆ¶ï¼');
            });
        }
        
        // ========== æ¸²æŸ“æˆ‘çš„è®¢å• ==========
        function renderMyOrders(filter = 'all') {
            const container = document.getElementById('myOrdersList');
            
            // è·å–ç”¨æˆ·è®¢å•
            const userOrders = JSON.parse(localStorage.getItem(`userOrders_${currentUser.username}`) || '[]');
            
            // ç­›é€‰è®¢å•
            let filteredOrders = userOrders;
            if (filter !== 'all') {
                filteredOrders = userOrders.filter(order => order.status === filter);
            }
            
            // æ›´æ–°ç­›é€‰æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event?.target?.classList?.add('active');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="empty-cart">
                        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ“¦</div>
                        <h3>æš‚æ— è®¢å•</h3>
                        <p style="color: #666; margin: 10px 0;">æ‚¨è¿˜æ²¡æœ‰è®¢å•è®°å½•</p>
                        <button class="btn btn-black" onclick="showStorePage()" style="margin-top: 20px;">å»è´­ç‰©</button>
                    </div>
                `;
                return;
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            filteredOrders.sort((a, b) => {
                const dateA = new Date(a.createdAt || 0);
                const dateB = new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            container.innerHTML = filteredOrders.map(order => `
                <div class="order-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                <span class="order-number">${order.orderNumber || 'æ— è®¢å•å·'}</span>
                                <span class="order-status status-${order.status}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                ${order.createdAt ? new Date(order.createdAt).toLocaleString('zh-CN') : 'æ— æ—¥æœŸ'}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                Â¥${(order.totalAmount || 0).toFixed(2)}
                            </div>
                            <div style="color: #999; font-size: 12px;">
                                ${order.paymentMethod === 'tng' ? 'Touch \'n Go' : 
                                  order.paymentMethod === 'alipay' ? 'æ”¯ä»˜å®' : 
                                  order.paymentMethod || 'æœªçŸ¥'}
                            </div>
                        </div>
                    </div>
                    
                    ${order.cartItems && order.cartItems.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: bold; margin-bottom: 10px;">å•†å“æ¸…å•ï¼š</div>
                            ${order.cartItems.map(item => `
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #f0f0f0;">
                                    <div>
                                        <div>${item.productName} Ã— ${item.quantity}</div>
                                        <div style="font-size: 12px; color: #666;">å•ä»·ï¼šÂ¥${item.productPrice.toFixed(2)}</div>
                                    </div>
                                    <div>Â¥${(item.productPrice * item.quantity).toFixed(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="color: #666; margin-bottom: 10px;">
                            <strong>å•†å“ï¼š</strong>${order.productName || 'æœªçŸ¥å•†å“'}
                        </div>
                    `}
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${order.status === 'pending' ? `
                            <button class="btn btn-green" onclick="payOrder('${order.orderNumber}')">ç«‹å³ä»˜æ¬¾</button>
                            <button class="btn btn-red" onclick="cancelOrder('${order.orderNumber}')">å–æ¶ˆè®¢å•</button>
                        ` : ''}
                        
                        ${order.status === 'paid' ? `
                            <button class="btn btn-gray" disabled style="opacity: 0.5;">ç­‰å¾…å‘è´§</button>
                        ` : ''}
                        
                        ${order.status === 'completed' ? `
                            <button class="btn btn-gray" disabled style="opacity: 0.5;">è®¢å•å·²å®Œæˆ</button>
                        ` : ''}
                        
                        ${order.status === 'cancelled' ? `
                            <button class="btn btn-red" disabled style="opacity: 0.5;">è®¢å•å·²å–æ¶ˆ</button>
                        ` : ''}
                        
                        <button class="btn btn-blue" onclick="contactSupport('${order.orderNumber}')">è”ç³»å®¢æœ</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ========== ç­›é€‰æˆ‘çš„è®¢å• ==========
        function filterMyOrders(filter) {
            renderMyOrders(filter);
        }
        
        // ========== æ”¯ä»˜è®¢å• ==========
        function payOrder(orderNumber) {
            showMessage('è¯·åœ¨è®¢å•ç®¡ç†ä¸­é€‰æ‹©æ”¯ä»˜æ–¹å¼', 'info');
            showStorePage();
        }
        
        // ========== å–æ¶ˆè®¢å• ==========
        async function cancelOrder(orderNumber) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/orders/cancel/${orderNumber}`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadUserOrders();
                    showMessage('è®¢å•å·²å–æ¶ˆ');
                } else {
                    showMessage(result.error || 'å–æ¶ˆè®¢å•å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('å–æ¶ˆè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ========== è”ç³»å®¢æœ ==========
        function contactSupport(orderNumber) {
            toggleChatWindow();
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                chatInput.value = `å…³äºè®¢å• ${orderNumber} çš„é—®é¢˜ï¼š`;
                chatInput.focus();
            }, 500);
        }
        
        // ========== åŠ è½½èŠå¤©ä¼šè¯ ==========
        async function loadChatSessions() {
            try {
                let endpoint = `${API_BASE_URL}/chats`;
                if (currentUser.isSupport) {
                    endpoint = `${API_BASE_URL}/chats/support`;
                } else if (currentUser.isAdmin) {
                    endpoint = `${API_BASE_URL}/chats/admin`;
                }
                
                const response = await fetch(endpoint);
                const result = await response.json();
                
                if (result.success) {
                    data.chats = result.data || [];
                    
                    // è®¡ç®—æœªè¯»æ¶ˆæ¯æ€»æ•°
                    chatUnreadCount = data.chats.reduce((total, chat) => {
                        return total + (chat.unreadCount || 0);
                    }, 0);
                    
                    // æ›´æ–°æœªè¯»æç¤º
                    updateUnreadNotification();
                    
                    // å¦‚æœå½“å‰åœ¨èŠå¤©ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°ä¼šè¯åˆ—è¡¨
                    if (document.getElementById('chatTab').classList.contains('active')) {
                        renderAdminChatSessions();
                    }
                    
                    // å¦‚æœå½“å‰åœ¨å®¢æœèŠå¤©é¡µé¢ï¼Œåˆ·æ–°ä¼šè¯åˆ—è¡¨
                    if (document.getElementById('supportChatTab').classList.contains('active')) {
                        renderSupportChatSessions();
                    }
                }
            } catch (error) {
                console.error('åŠ è½½èŠå¤©ä¼šè¯å¤±è´¥:', error);
            }
        }
        
        // ========== æ›´æ–°æœªè¯»æ¶ˆæ¯æç¤º ==========
        function updateUnreadNotification() {
            const chatButton = document.getElementById('chatButton');
            
            if (chatUnreadCount > 0) {
                chatButton.classList.add('has-unread');
                chatButton.title = `æœ‰${chatUnreadCount}æ¡æœªè¯»æ¶ˆæ¯`;
            } else {
                chatButton.classList.remove('has-unread');
                chatButton.title = 'åœ¨çº¿å®¢æœ';
            }
        }
        
        // ========== è‡ªåŠ¨åˆ·æ–°æ•°æ® ==========
        function startAutoRefresh() {
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);
            
            autoRefreshInterval = setInterval(async () => {
                if (document.getElementById('storePage').classList.contains('active')) {
                    await loadAllData();
                    renderProducts();
                    renderCustomerService();
                }
                
                // å¦‚æœå½“å‰åœ¨å®¢æœåå°ï¼Œåˆ·æ–°æ•°æ®
                if (document.getElementById('supportPage').classList.contains('active')) {
                    await loadAllData();
                    if (document.getElementById('supportOrdersTab').classList.contains('active')) {
                        renderSupportOrders();
                    }
                }
            }, 3000);
        }
        
        // ========== å¯åŠ¨èŠå¤©è½®è¯¢ ==========
        function startChatPolling() {
            if (chatUpdateInterval) clearInterval(chatUpdateInterval);
            
            chatUpdateInterval = setInterval(async () => {
                if (currentUser) {
                    // æ£€æŸ¥æ–°æ¶ˆæ¯
                    await checkNewMessages();
                    
                    // å¦‚æœèŠå¤©çª—å£æ‰“å¼€ï¼Œæ›´æ–°æ¶ˆæ¯
                    if (document.getElementById('chatWindow').classList.contains('active') && currentChatSession) {
                        await loadUserChatMessages(currentChatSession.id);
                    }
                }
            }, 2000);
        }
        
        // ========== æ£€æŸ¥æ–°æ¶ˆæ¯ ==========
        async function checkNewMessages() {
            try {
                if (!currentUser) return;
                
                // è·å–ç”¨æˆ·çš„èŠå¤©ä¼šè¯
                const response = await fetch(`${API_BASE_URL}/chats/user/${currentUser.username}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    const chat = result.data;
                    
                    // å¦‚æœæœ‰æœªè¯»æ¶ˆæ¯ä¸”èŠå¤©çª—å£æœªæ‰“å¼€
                    if (chat.unreadCount > 0 && !document.getElementById('chatWindow').classList.contains('active')) {
                        // æ›´æ–°æœªè¯»è®¡æ•°
                        chatUnreadCount = chat.unreadCount;
                        updateUnreadNotification();
                    }
                }
            } catch (error) {
                console.error('æ£€æŸ¥æ–°æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // ========== é¡µé¢åˆå§‹åŒ– ==========
        document.addEventListener('DOMContentLoaded', async function() {
            await loadAllData();
            checkLogin();
            startAutoRefresh();
        });
        
        // ========== ç”¨æˆ·è®¤è¯ ==========
        function checkLogin() {
            const savedUser = localStorage.getItem('mallCurrentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    showStorePage();
                    updateUserRoleDisplay();
                    startChatPolling();
                } catch (e) {
                    console.error('ç™»å½•ä¿¡æ¯è§£æå¤±è´¥');
                }
            }
        }
        
        // ========== æ›´æ–°ç”¨æˆ·è§’è‰²æ˜¾ç¤º ==========
        function updateUserRoleDisplay() {
            const userRoleBadge = document.getElementById('userRoleBadge');
            const adminBtn = document.getElementById('adminBtn');
            const supportBtn = document.getElementById('supportBtn');
            
            if (currentUser) {
                if (currentUser.isAdmin) {
                    userRoleBadge.textContent = 'ç®¡ç†å‘˜';
                    userRoleBadge.className = 'support-role-badge badge-admin';
                    userRoleBadge.style.display = 'inline-block';
                    adminBtn.style.display = 'inline-block';
                    supportBtn.style.display = 'none';
                } else if (currentUser.isSupport) {
                    userRoleBadge.textContent = 'å®¢æœ';
                    userRoleBadge.className = 'support-role-badge badge-support';
                    userRoleBadge.style.display = 'inline-block';
                    adminBtn.style.display = 'none';
                    supportBtn.style.display = 'inline-block';
                } else {
                    userRoleBadge.textContent = 'ç”¨æˆ·';
                    userRoleBadge.className = 'support-role-badge badge-user';
                    userRoleBadge.style.display = 'inline-block';
                    adminBtn.style.display = 'none';
                    supportBtn.style.display = 'none';
                }
            } else {
                userRoleBadge.style.display = 'none';
                adminBtn.style.display = 'none';
                supportBtn.style.display = 'none';
            }
        }
        
        function switchAuthTab(tab) {
            document.querySelectorAll('.login-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.remove('active');
            document.getElementById(tab + 'Form').classList.add('active');
        }
        
        async function loginUser(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.data;
                    localStorage.setItem('mallCurrentUser', JSON.stringify(currentUser));
                    
                    await loadAllData();
                    showStorePage();
                    updateUserRoleDisplay();
                    startChatPolling();
                    showMessage('ç™»å½•æˆåŠŸï¼');
                } else {
                    showMessage(result.error || 'ç™»å½•å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
            
            return false;
        }
        
        // ========== æ³¨å†Œå‡½æ•° ==========
        async function registerUser(event) {
            event.preventDefault();
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            
            if (!username || !password || !confirmPassword) {
                showMessage('è¯·å¡«å†™æ‰€æœ‰å­—æ®µï¼', 'error');
                return false;
            }
            
            if (password !== confirmPassword) {
                showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼', 'error');
                return false;
            }
            
            if (password.length < 6) {
                showMessage('å¯†ç è‡³å°‘éœ€è¦6ä½ï¼', 'error');
                return false;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        username, 
                        password,
                        isAdmin: false,
                        isSupport: false
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.data;
                    localStorage.setItem('mallCurrentUser', JSON.stringify(currentUser));
                    
                    await loadAllData();
                    showStorePage();
                    updateUserRoleDisplay();
                    startChatPolling();
                    showMessage('æ³¨å†ŒæˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•');
                } else {
                    showMessage(result.error || 'æ³¨å†Œå¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥', 'error');
            }
            
            return false;
        }
        
        // ========== é¡µé¢åˆ‡æ¢å‡½æ•° ==========
        function showCartPage() {
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ï¼', 'error');
                return;
            }
            showPage('cartPage');
            renderCartItems();
            updateCartSummary();
        }
        
        function showMyOrders() {
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ï¼', 'error');
                return;
            }
            showPage('ordersPage');
            renderMyOrders('all');
        }
        
        function showSupportPage() {
            if (!currentUser || !currentUser.isSupport) {
                showMessage('éœ€è¦å®¢æœæƒé™ï¼', 'error');
                return;
            }
            showPage('supportPage');
            switchSupportTab('orders');
        }
        
        function showAdminPage() {
            if (!currentUser || !currentUser.isAdmin) {
                showMessage('éœ€è¦ç®¡ç†å‘˜æƒé™ï¼', 'error');
                return;
            }
            showPage('adminPage');
            switchTab('products');
        }
        
        // ========== å®¢æœåå°åŠŸèƒ½ ==========
        function switchSupportTab(tab) {
            document.querySelectorAll('.support-nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.support-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById('support' + tab.charAt(0).toUpperCase() + tab.slice(1) + 'Tab').classList.add('active');
            
            if (tab === 'orders') {
                renderSupportOrders();
            } else if (tab === 'chat') {
                loadChatSessions();
            }
        }
        
        // ========== æ¸²æŸ“å®¢æœè®¢å• ==========
        function renderSupportOrders() {
            const container = document.getElementById('supportOrdersList');
            
            if (!data.orders || data.orders.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— è®¢å•è®°å½•</div>';
                return;
            }
            
            let filteredOrders = [...data.orders];
            
            // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤è®¢å•
            if (supportCurrentFilter === 'today') {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                
                filteredOrders = data.orders.filter(order => {
                    if (!order.createdAt) return false;
                    try {
                        const orderDate = new Date(order.createdAt);
                        const orderDateStr = orderDate.toISOString().split('T')[0];
                        return orderDateStr === todayStr;
                    } catch (e) {
                        return false;
                    }
                });
            } else if (supportCurrentFilter !== 'all') {
                filteredOrders = data.orders.filter(order => order.status === supportCurrentFilter);
            }
            
            // æ ¹æ®æœç´¢å…³é”®è¯è¿‡æ»¤è®¢å•
            if (supportSearchKeyword) {
                const keyword = supportSearchKeyword.toLowerCase();
                filteredOrders = filteredOrders.filter(order => 
                    (order.orderNumber && order.orderNumber.toLowerCase().includes(keyword)) ||
                    (order.userId && order.userId.toLowerCase().includes(keyword))
                );
            }
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            filteredOrders.sort((a, b) => {
                const dateA = new Date(a.createdAt || 0);
                const dateB = new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div>æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®¢å•</div>
                        ${supportSearchKeyword ? '<div style="margin-top: 10px;">è¯·å°è¯•å…¶ä»–æœç´¢å…³é”®è¯</div>' : ''}
                    </div>`;
                return;
            }
            
            const filterInfo = {
                'all': 'å…¨éƒ¨è®¢å•',
                'today': 'ä»Šæ—¥è®¢å•',
                'pending': 'å¾…ä»˜æ¬¾è®¢å•',
                'paid': 'å·²ä»˜æ¬¾è®¢å•',
                'completed': 'å·²å®Œæˆè®¢å•',
                'cancelled': 'å·²å–æ¶ˆè®¢å•'
            };
            
            container.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 14px; color: #666;">
                    å½“å‰æ˜¾ç¤ºï¼š${filterInfo[supportCurrentFilter]}ï¼Œå…± ${filteredOrders.length} æ¡
                    ${supportSearchKeyword ? `ï¼Œæœç´¢å…³é”®è¯ï¼š"${supportSearchKeyword}"` : ''}
                </div>
                ${filteredOrders.map(order => `
                <div class="order-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                <span class="order-number">${order.orderNumber || 'æ— è®¢å•å·'}</span>
                                <span class="order-status status-${order.status}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                ç”¨æˆ·ï¼š${order.userId || 'æœªçŸ¥ç”¨æˆ·'}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                Â¥${(order.totalAmount || 0).toFixed(2)}
                            </div>
                            <div style="color: #999; font-size: 12px;">
                                ${order.createdAt ? new Date(order.createdAt).toLocaleString('zh-CN') : 'æ— æ—¥æœŸ'}
                            </div>
                        </div>
                    </div>
                    ${order.cartItems && order.cartItems.length > 0 ? `
                        <div style="color: #666; margin-bottom: 15px; font-size: 14px;">
                            <strong>å•†å“æ•°é‡ï¼š</strong>${order.cartItems.length} ä»¶å•†å“
                        </div>
                    ` : `
                        <div style="color: #666; margin-bottom: 10px;">
                            <strong>å•†å“ï¼š</strong>${order.productName || 'æœªçŸ¥å•†å“'}
                        </div>
                    `}
                    <div style="color: #666; margin-bottom: 15px; font-size: 14px;">
                        <strong>æ”¯ä»˜æ–¹å¼ï¼š</strong>${order.paymentMethod === 'tng' ? 'Touch \'n Go' : 
                                                order.paymentMethod === 'alipay' ? 'æ”¯ä»˜å®' : 
                                                order.paymentMethod || 'æœªçŸ¥'}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-blue" onclick="viewOrderDetails('${order.orderNumber}')">æŸ¥çœ‹è¯¦æƒ…</button>
                        <button class="btn btn-gray" onclick="contactOrderUser('${order.orderNumber}', '${order.userId}')">è”ç³»ç”¨æˆ·</button>
                    </div>
                </div>
                `).join('')}`;
        }
        
        // ========== ç­›é€‰å®¢æœè®¢å• ==========
        function filterSupportOrders(filterType) {
            supportCurrentFilter = filterType;
            renderSupportOrders();
        }
        
        // ========== æœç´¢å®¢æœè®¢å• ==========
        function searchSupportOrders() {
            supportSearchKeyword = document.getElementById('supportOrderSearch').value.trim();
            renderSupportOrders();
        }
        
        // ========== åˆ·æ–°å®¢æœè®¢å• ==========
        function refreshSupportOrders() {
            loadAllData();
            showMessage('è®¢å•åˆ—è¡¨å·²åˆ·æ–°');
        }
        
        // ========== æŸ¥çœ‹è®¢å•è¯¦æƒ… ==========
        function viewOrderDetails(orderNumber) {
            const order = data.orders.find(o => o.orderNumber === orderNumber);
            if (!order) {
                showMessage('è®¢å•ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            let orderDetails = `
                <div style="margin-bottom: 15px;">
                    <h4>è®¢å•è¯¦æƒ…</h4>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 10px;">
                        <div style="margin-bottom: 10px;"><strong>è®¢å•å·ï¼š</strong>${order.orderNumber}</div>
                        <div style="margin-bottom: 10px;"><strong>ç”¨æˆ·ï¼š</strong>${order.userId}</div>
                        <div style="margin-bottom: 10px;"><strong>çŠ¶æ€ï¼š</strong>${getStatusText(order.status)}</div>
                        <div style="margin-bottom: 10px;"><strong>æ”¯ä»˜æ–¹å¼ï¼š</strong>${order.paymentMethod === 'tng' ? 'Touch \'n Go' : order.paymentMethod === 'alipay' ? 'æ”¯ä»˜å®' : order.paymentMethod}</div>
                        <div style="margin-bottom: 10px;"><strong>é‡‘é¢ï¼š</strong>Â¥${order.totalAmount.toFixed(2)}</div>
                        <div style="margin-bottom: 10px;"><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${new Date(order.createdAt).toLocaleString('zh-CN')}</div>
            `;
            
            if (order.cartItems && order.cartItems.length > 0) {
                orderDetails += `<div style="margin-top: 15px;"><strong>å•†å“æ¸…å•ï¼š</strong></div>`;
                order.cartItems.forEach(item => {
                    orderDetails += `
                        <div style="margin-top: 5px; padding: 5px; background: white; border-radius: 4px;">
                            ${item.productName} Ã— ${item.quantity} - Â¥${item.productPrice.toFixed(2)}/ä¸ª = Â¥${(item.productPrice * item.quantity).toFixed(2)}
                        </div>
                    `;
                });
            }
            
            orderDetails += `</div></div>`;
            
            alert(orderDetails);
        }
        
        // ========== è”ç³»è®¢å•ç”¨æˆ· ==========
        function contactOrderUser(orderNumber, userId) {
            // è¿™é‡Œå¯ä»¥è·³è½¬åˆ°èŠå¤©ç•Œé¢æˆ–è€…æ‰“å¼€èŠå¤©çª—å£
            showSupportPage();
            switchSupportTab('chat');
            
            // å¯ä»¥åœ¨è¿™é‡Œè‡ªåŠ¨åˆ›å»ºæˆ–è·³è½¬åˆ°ä¸è¯¥ç”¨æˆ·çš„èŠå¤©ä¼šè¯
            setTimeout(() => {
                showMessage(`å‡†å¤‡è”ç³»ç”¨æˆ· ${userId} å…³äºè®¢å• ${orderNumber}`);
            }, 500);
        }
        
        // ========== æ¸²æŸ“å®¢æœèŠå¤©ä¼šè¯ ==========
        function renderSupportChatSessions() {
            const container = document.getElementById('supportChatSessions');
            const sessionCount = document.getElementById('supportSessionCount');
            
            if (!data.chats || data.chats.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— èŠå¤©ä¼šè¯</div>';
                sessionCount.textContent = '0';
                return;
            }
            
            // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´å€’åºæ’åˆ—
            data.chats.sort((a, b) => {
                const timeA = new Date(a.lastMessageTime || a.createdAt);
                const timeB = new Date(b.lastMessageTime || b.createdAt);
                return timeB - timeA;
            });
            
            sessionCount.textContent = data.chats.length;
            
            container.innerHTML = data.chats.map(chat => `
                <div class="chat-session ${supportCurrentChatId === chat.id ? 'active' : ''}" onclick="selectSupportChat(${chat.id})">
                    <div class="session-info">
                        <div class="session-user">ğŸ‘¤ ${chat.userName || chat.userId}</div>
                        <div class="session-last-message">${chat.lastMessage || 'æš‚æ— æ¶ˆæ¯'}</div>
                        <div class="session-time">${formatTime(chat.lastMessageTime || chat.createdAt)}</div>
                    </div>
                    ${chat.unreadCount > 0 ? `<div class="session-unread">${chat.unreadCount}</div>` : ''}
                </div>
            `).join('');
        }
        
        // ========== é€‰æ‹©å®¢æœèŠå¤©ä¼šè¯ ==========
        async function selectSupportChat(chatId) {
            supportCurrentChatId = chatId;
            renderSupportChatSessions();
            
            // æ˜¾ç¤ºèŠå¤©ç•Œé¢
            const chat = data.chats.find(c => c.id === chatId);
            if (chat) {
                document.getElementById('supportChatHeader').innerHTML = `
                    <div>
                        <div style="font-weight: bold;">ğŸ‘¤ ${chat.userName || chat.userId}</div>
                        <div style="font-size: 12px; color: #666;">æœ€åæ´»è·ƒï¼š${formatTime(chat.lastMessageTime || chat.createdAt)}</div>
                    </div>
                    <button class="btn btn-blue btn-sm" onclick="markChatAsRead(${chatId})">æ ‡ä¸ºå·²è¯»</button>
                `;
                
                document.getElementById('supportChatInput').style.display = 'flex';
                
                // åŠ è½½æ¶ˆæ¯
                await loadSupportChatMessages(chatId);
                
                // æ ‡è®°ä¸ºå·²è¯»
                await markChatAsRead(chatId);
            }
        }
        
        // ========== åŠ è½½å®¢æœèŠå¤©æ¶ˆæ¯ ==========
        async function loadSupportChatMessages(chatId) {
            try {
                const response = await fetch(`${API_BASE_URL}/chats/${chatId}/messages`);
                const result = await response.json();
                
                if (result.success) {
                    const messages = result.data || [];
                    renderSupportChatMessages(messages);
                }
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // ========== æ¸²æŸ“å®¢æœèŠå¤©æ¶ˆæ¯ ==========
        function renderSupportChatMessages(messages) {
            const container = document.getElementById('supportChatMessages');
            
            // æŒ‰æ—¶é—´æ’åº
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            container.innerHTML = messages.map(msg => `
                <div class="chat-message ${msg.senderType === 'user' ? 'support' : 'user'}" style="margin-bottom: 10px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                        ${msg.senderType === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ’ å®¢æœ'}
                    </div>
                    ${msg.content}
                    <div class="chat-message-time">${formatTime(msg.createdAt)}</div>
                </div>
            `).join('');
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                const supportChatMessages = document.getElementById('supportChatMessages');
                supportChatMessages.scrollTop = supportChatMessages.scrollHeight;
            }, 100);
        }
        
        // ========== å‘é€å®¢æœèŠå¤©æ¶ˆæ¯ ==========
        async function sendSupportChatMessage() {
            const input = document.getElementById('supportChatInputField');
            const message = input.value.trim();
            
            if (!message || !supportCurrentChatId) {
                return;
            }
            
            try {
                // å‘é€æ¶ˆæ¯
                const response = await fetch(`${API_BASE_URL}/chats/${supportCurrentChatId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: message,
                        senderType: 'support',
                        senderId: currentUser.username
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    input.value = '';
                    
                    // é‡æ–°åŠ è½½æ¶ˆæ¯
                    await loadSupportChatMessages(supportCurrentChatId);
                    
                    // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                    await loadChatSessions();
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showMessage('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ========== å¤„ç†å®¢æœèŠå¤©è¾“å…¥æ¡†æŒ‰é”® ==========
        function handleSupportChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendSupportChatMessage();
            }
        }
        
        // ========== åˆ·æ–°å®¢æœèŠå¤©ä¼šè¯ ==========
        function refreshSupportChatSessions() {
            loadChatSessions();
            showMessage('èŠå¤©ä¼šè¯å·²åˆ·æ–°');
        }
        
        // ========== å•†å“ç®¡ç† ==========
        async function addProduct() {
            const name = document.getElementById('productName').value;
            const price = parseFloat(document.getElementById('productPrice').value);
            const description = document.getElementById('productDesc').value;
            const image = document.getElementById('productImage').value;
            
            if (!name || !price) {
                showMessage('è¯·å¡«å†™å•†å“åç§°å’Œä»·æ ¼ï¼', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/products/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, price, description, image })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    
                    document.getElementById('productName').value = '';
                    document.getElementById('productPrice').value = '';
                    document.getElementById('productDesc').value = '';
                    document.getElementById('productImage').value = '';
                    document.getElementById('imagePreviewContainer').style.display = 'none';
                    
                    renderAdminProducts();
                    renderProducts();
                    showMessage('å•†å“æ·»åŠ æˆåŠŸï¼');
                } else {
                    showMessage(result.error || 'æ·»åŠ å•†å“å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å•†å“å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function deleteProduct(productId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå•†å“å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/products/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: productId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderAdminProducts();
                    renderProducts();
                    showMessage('å•†å“å·²åˆ é™¤ï¼');
                } else {
                    showMessage(result.error || 'åˆ é™¤å•†å“å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        function renderProducts() {
            const container = document.getElementById('productsList');
            
            if (!data.products || data.products.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 50px; color: #999;">æš‚æ— å•†å“</div>';
                return;
            }
            
            container.innerHTML = data.products.map(product => `
                <div class="product-card">
                    <div class="product-img-container">
                        <img src="${product.image || 'https://via.placeholder.com/300x250.png?text=å•†å“'}" 
                             alt="${product.name}" 
                             class="product-img"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/300x250.png?text=å•†å“'">
                    </div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div class="product-price">Â¥${product.price.toFixed(2)}</div>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px; min-height: 40px; line-height: 1.4;">
                            ${product.description || ''}
                        </p>
                        <div class="quantity-control">
                            <button class="quantity-btn" onclick="updateProductQty(${product.id}, -1)">-</button>
                            <input type="number" class="quantity-input" id="qty_${product.id}" value="1" min="1">
                            <button class="quantity-btn" onclick="updateProductQty(${product.id}, 1)">+</button>
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 10px;">
                            <button class="btn btn-black" style="flex: 1;" onclick="addToCartFromProduct(${product.id})">
                                åŠ å…¥è´­ç‰©è½¦
                            </button>
                            <button class="btn btn-green" style="flex: 1;" onclick="buyNow(${product.id})">
                                ç«‹å³è´­ä¹°
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // ========== æ›´æ–°å•†å“æ•°é‡ï¼ˆå‰ç«¯ï¼‰ ==========
        function updateProductQty(productId, change) {
            const input = document.getElementById(`qty_${productId}`);
            let newValue = parseInt(input.value) + change;
            if (newValue < 1) newValue = 1;
            input.value = newValue;
        }
        
        // ========== ä»å•†å“é¡µé¢åŠ å…¥è´­ç‰©è½¦ ==========
        function addToCartFromProduct(productId) {
            const quantity = parseInt(document.getElementById(`qty_${productId}`).value) || 1;
            addToCart(productId, quantity);
        }
        
        // ========== ç«‹å³è´­ä¹° ==========
        function buyNow(productId) {
            const quantity = parseInt(document.getElementById(`qty_${productId}`).value) || 1;
            
            // å…ˆæ·»åŠ åˆ°è´­ç‰©è½¦
            addToCart(productId, quantity);
            
            // ç„¶åè·³è½¬åˆ°è´­ç‰©è½¦
            setTimeout(() => {
                showCartPage();
            }, 500);
        }
        
        function renderAdminProducts() {
            const container = document.getElementById('adminProducts');
            
            if (!data.products || data.products.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— å•†å“</div>';
                return;
            }
            
            container.innerHTML = data.products.map(product => `
                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="width: 80px; height: 80px; overflow: hidden; border-radius: 4px; flex-shrink: 0;">
                            <img src="${product.image}" 
                                 alt="${product.name}" 
                                 style="width: 100%; height: 100%; object-fit: contain; background: #f5f5f5;"
                                 onerror="this.src='https://via.placeholder.com/80x80.png?text=å•†å“'">
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 5px;">${product.name}</div>
                            <div style="color: #666; font-size: 14px; margin-bottom: 5px;">${product.description || ''}</div>
                            <div style="font-weight: bold; color: #000;">Â¥${product.price.toFixed(2)}</div>
                        </div>
                        <button class="btn btn-red" onclick="deleteProduct(${product.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        // ========== è®¢å•ç®¡ç† ==========
        function showOrderModal(productId) {
            if (!currentUser) {
                showMessage('è¯·å…ˆç™»å½•ï¼', 'error');
                return;
            }
            
            const product = data.products.find(p => p.id == productId);
            if (!product) {
                showMessage('å•†å“ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            currentProductId = productId;
            
            // ç”Ÿæˆè®¢å•å·
            const now = new Date();
            const orderNumber = 'DD' + now.getFullYear().toString().substr(2) + 
                               (now.getMonth() + 1).toString().padStart(2, '0') + 
                               now.getDate().toString().padStart(2, '0') + 
                               Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            
            document.getElementById('orderNumber').textContent = orderNumber;
            document.getElementById('orderProductName').textContent = product.name;
            document.getElementById('orderProductPrice').textContent = 'Â¥' + product.price.toFixed(2);
            document.getElementById('orderTotal').textContent = 'Â¥' + product.price.toFixed(2);
            
            document.getElementById('orderModal').classList.add('active');
        }
        
        async function completeOrder() {
            const product = data.products.find(p => p.id == currentProductId);
            if (!product) {
                showMessage('å•†å“ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            const orderNumber = document.getElementById('orderNumber').textContent;
            
            try {
                const response = await fetch(`${API_BASE_URL}/orders/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        orderNumber,
                        userId: currentUser.username,
                        productId: product.id,
                        productName: product.name,
                        productPrice: product.price,
                        totalAmount: product.price,
                        paymentMethod: selectedPayment,
                        status: 'pending'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    closeModal('orderModal');
                    
                    // å¦‚æœå½“å‰åœ¨è®¢å•ç®¡ç†é¡µé¢ï¼Œåˆ·æ–°è®¢å•åˆ—è¡¨
                    if (document.getElementById('ordersTab').classList.contains('active')) {
                        renderOrders();
                    }
                    
                    showMessage(`è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•å·ï¼š${orderNumber}ï¼Œè¯·æˆªå›¾ä¿å­˜äºŒç»´ç å¹¶è”ç³»å®¢æœ`);
                } else {
                    showMessage(result.error || 'åˆ›å»ºè®¢å•å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('åˆ›å»ºè®¢å•å¤±è´¥', 'error');
            }
        }
        
        function selectPayment(payment) {
            selectedPayment = payment;
            document.querySelectorAll('#orderModal .payment-option').forEach(option => {
                option.classList.remove('active');
            });
            event.target.closest('.payment-option').classList.add('active');
        }
        
        function copyOrderNumber() {
            const orderNumber = document.getElementById('orderNumber').textContent;
            navigator.clipboard.writeText(orderNumber).then(() => {
                showMessage('è®¢å•å·å·²å¤åˆ¶ï¼');
            });
        }
        
        // ğŸ”¥ ä¿®å¤ï¼šå®Œæ•´çš„è®¢å•ç­›é€‰å‡½æ•°
        function filterOrders(filterType) {
            currentOrderFilter = filterType;
            renderOrders();
        }
        
        // ğŸ”¥ ä¿®å¤ï¼šå®Œæ•´çš„è®¢å•æ¸²æŸ“å‡½æ•°
        function renderOrders() {
            const container = document.getElementById('ordersList');
            
            if (!data.orders || data.orders.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— è®¢å•è®°å½•</div>';
                return;
            }
            
            // è®¾ç½®ç­›é€‰ä¸‹æ‹‰æ¡†çš„å€¼
            document.getElementById('orderFilterSelect').value = currentOrderFilter;
            
            let filteredOrders = [...data.orders];
            
            // æ ¹æ®å½“å‰ç­›é€‰æ¡ä»¶è¿‡æ»¤è®¢å•
            if (currentOrderFilter === 'today') {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0]; // è·å–ä»Šå¤©çš„æ—¥æœŸ YYYY-MM-DD
                
                filteredOrders = data.orders.filter(order => {
                    // ç¡®ä¿ order.createdAt å­˜åœ¨
                    if (!order.createdAt) return false;
                    
                    try {
                        const orderDate = new Date(order.createdAt);
                        const orderDateStr = orderDate.toISOString().split('T')[0];
                        return orderDateStr === todayStr;
                    } catch (e) {
                        console.error('æ—¥æœŸè§£æé”™è¯¯:', e);
                        return false;
                    }
                });
            } else if (currentOrderFilter === 'pending') {
                filteredOrders = data.orders.filter(order => order.status === 'pending');
            } else if (currentOrderFilter === 'paid') {
                filteredOrders = data.orders.filter(order => order.status === 'paid');
            } else if (currentOrderFilter === 'completed') {
                filteredOrders = data.orders.filter(order => order.status === 'completed');
            } else if (currentOrderFilter === 'cancelled') {
                filteredOrders = data.orders.filter(order => order.status === 'cancelled');
            }
            
            // æ˜¾ç¤ºç­›é€‰ç»“æœä¿¡æ¯
            const filterInfo = {
                'all': 'å…¨éƒ¨è®¢å•',
                'today': 'ä»Šæ—¥è®¢å•',
                'pending': 'å¾…ä»˜æ¬¾è®¢å•',
                'paid': 'å·²ä»˜æ¬¾è®¢å•',
                'completed': 'å·²å®Œæˆè®¢å•',
                'cancelled': 'å·²å–æ¶ˆè®¢å•'
            };
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼ˆæœ€æ–°çš„åœ¨å‰é¢ï¼‰
            filteredOrders.sort((a, b) => {
                const dateA = new Date(a.createdAt || 0);
                const dateB = new Date(b.createdAt || 0);
                return dateB - dateA;
            });
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #999;">
                        <div>${filterInfo[currentOrderFilter]}ï¼š0 æ¡</div>
                        <div style="margin-top: 10px; color: #666;">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„è®¢å•</div>
                    </div>`;
                return;
            }
            
            container.innerHTML = `
                <div style="margin-bottom: 15px; padding: 10px; background: #f5f5f5; border-radius: 4px; font-size: 14px; color: #666;">
                    å½“å‰æ˜¾ç¤ºï¼š${filterInfo[currentOrderFilter]}ï¼Œå…± ${filteredOrders.length} æ¡
                </div>
                ${filteredOrders.map(order => `
                <div class="order-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div>
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                <span class="order-number">${order.orderNumber || 'æ— è®¢å•å·'}</span>
                                <span class="order-status status-${order.status}">
                                    ${getStatusText(order.status)}
                                </span>
                            </div>
                            <div style="color: #666; font-size: 14px;">
                                ç”¨æˆ·ï¼š${order.userId || 'æœªçŸ¥ç”¨æˆ·'}
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: bold; margin-bottom: 5px;">
                                Â¥${(order.totalAmount || 0).toFixed(2)}
                            </div>
                            <div style="color: #999; font-size: 12px;">
                                ${order.createdAt ? new Date(order.createdAt).toLocaleString('zh-CN') : 'æ— æ—¥æœŸ'}
                            </div>
                        </div>
                    </div>
                    ${order.cartItems && order.cartItems.length > 0 ? `
                        <div style="color: #666; margin-bottom: 15px; font-size: 14px;">
                            <strong>å•†å“æ•°é‡ï¼š</strong>${order.cartItems.length} ä»¶å•†å“
                        </div>
                    ` : `
                        <div style="color: #666; margin-bottom: 10px;">
                            <strong>å•†å“ï¼š</strong>${order.productName || 'æœªçŸ¥å•†å“'}
                        </div>
                    `}
                    <div style="color: #666; margin-bottom: 15px; font-size: 14px;">
                        <strong>æ”¯ä»˜æ–¹å¼ï¼š</strong>${order.paymentMethod === 'tng' ? 'Touch \'n Go' : 
                                                order.paymentMethod === 'alipay' ? 'æ”¯ä»˜å®' : 
                                                order.paymentMethod || 'æœªçŸ¥'}
                    </div>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        ${order.status === 'pending' ? `
                            <button class="btn btn-gray" onclick="updateOrderStatus('${order.orderNumber}', 'paid')">
                                æ ‡è®°å·²ä»˜æ¬¾
                            </button>
                            <button class="btn btn-green" onclick="updateOrderStatus('${order.orderNumber}', 'completed')">
                                å®Œæˆè®¢å•
                            </button>
                        ` : ''}
                        
                        ${order.status === 'paid' ? `
                            <button class="btn btn-green" onclick="updateOrderStatus('${order.orderNumber}', 'completed')">
                                å®Œæˆè®¢å•
                            </button>
                        ` : ''}
                        
                        ${order.status !== 'cancelled' && order.status !== 'completed' ? `
                            <button class="btn btn-red" onclick="adminCancelOrder('${order.orderNumber}')">å–æ¶ˆè®¢å•</button>
                        ` : ''}
                        
                        <button class="btn btn-red" onclick="deleteOrder('${order.orderNumber}')">åˆ é™¤</button>
                    </div>
                </div>
                `).join('')}`;
        }
        
        async function updateOrderStatus(orderNumber, status) {
            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderNumber}/status`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderOrders();
                    
                    // å¦‚æœç”¨æˆ·åœ¨å½“å‰é¡µé¢ï¼Œä¹Ÿåˆ·æ–°ç”¨æˆ·è®¢å•
                    if (currentUser) {
                        await loadUserOrders();
                    }
                    
                    showMessage('è®¢å•çŠ¶æ€å·²æ›´æ–°');
                } else {
                    showMessage(result.error || 'æ›´æ–°å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ç®¡ç†å‘˜å–æ¶ˆè®¢å•
        async function adminCancelOrder(orderNumber) {
            if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªè®¢å•å—ï¼Ÿ')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/orders/cancel/${orderNumber}`, {
                    method: 'PUT'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderOrders();
                    showMessage('è®¢å•å·²å–æ¶ˆ');
                } else {
                    showMessage(result.error || 'å–æ¶ˆè®¢å•å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('å–æ¶ˆè®¢å•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function deleteOrder(orderNumber) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè®¢å•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) return;
            
            try {
                const response = await fetch(`${API_BASE_URL}/orders/${orderNumber}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderOrders();
                    showMessage('è®¢å•å·²åˆ é™¤');
                } else {
                    showMessage(result.error || 'åˆ é™¤å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ========== èŠå¤©ç³»ç»ŸåŠŸèƒ½ ==========
        
        // åˆ‡æ¢èŠå¤©çª—å£æ˜¾ç¤º/éšè—
        function toggleChatWindow() {
            const chatWindow = document.getElementById('chatWindow');
            const chatButton = document.getElementById('chatButton');
            
            if (chatWindow.classList.contains('active')) {
                chatWindow.classList.remove('active');
            } else {
                // æ‰“å¼€èŠå¤©çª—å£
                if (!currentUser) {
                    showMessage('è¯·å…ˆç™»å½•æ‰èƒ½ä½¿ç”¨èŠå¤©åŠŸèƒ½ï¼', 'error');
                    return;
                }
                
                chatWindow.classList.add('active');
                
                // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ‰“å¼€ï¼Œåˆ›å»ºæˆ–åŠ è½½èŠå¤©ä¼šè¯
                if (!currentChatSession) {
                    loadOrCreateChatSession();
                } else {
                    // åŠ è½½æ¶ˆæ¯
                    loadUserChatMessages(currentChatSession.id);
                }
                
                // æ¸…é™¤æœªè¯»æç¤º
                clearUnreadNotification();
                
                // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                setTimeout(() => {
                    scrollChatToBottom();
                }, 100);
            }
        }
        
        // åŠ è½½æˆ–åˆ›å»ºèŠå¤©ä¼šè¯
        async function loadOrCreateChatSession() {
            try {
                // å°è¯•è·å–ç”¨æˆ·çš„èŠå¤©ä¼šè¯
                const response = await fetch(`${API_BASE_URL}/chats/user/${currentUser.username}`);
                const result = await response.json();
                
                if (result.success && result.data) {
                    // å·²æœ‰èŠå¤©ä¼šè¯
                    currentChatSession = result.data;
                    await loadUserChatMessages(currentChatSession.id);
                } else {
                    // åˆ›å»ºæ–°çš„èŠå¤©ä¼šè¯
                    const createResponse = await fetch(`${API_BASE_URL}/chats/create`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentUser.username,
                            userName: currentUser.username,
                            status: 'active'
                        })
                    });
                    
                    const createResult = await createResponse.json();
                    
                    if (createResult.success) {
                        currentChatSession = createResult.data;
                        // æ·»åŠ æ¬¢è¿æ¶ˆæ¯
                        addSystemMessage('æ¬¢è¿ä½¿ç”¨åœ¨çº¿å®¢æœï¼æˆ‘ä»¬çš„å®¢æœäººå‘˜ä¼šå°½å¿«å›å¤æ‚¨ã€‚');
                    }
                }
            } catch (error) {
                console.error('åŠ è½½èŠå¤©ä¼šè¯å¤±è´¥:', error);
                showMessage('æ— æ³•è¿æ¥åˆ°èŠå¤©æœåŠ¡å™¨', 'error');
            }
        }
        
        // åŠ è½½ç”¨æˆ·èŠå¤©æ¶ˆæ¯
        async function loadUserChatMessages(chatId) {
            try {
                const response = await fetch(`${API_BASE_URL}/chats/${chatId}/messages`);
                const result = await response.json();
                
                if (result.success) {
                    const messages = result.data || [];
                    renderUserChatMessages(messages);
                    
                    // æ ‡è®°ä¸ºå·²è¯»
                    if (messages.length > 0) {
                        markChatAsRead(chatId);
                    }
                }
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“ç”¨æˆ·èŠå¤©æ¶ˆæ¯
        function renderUserChatMessages(messages) {
            const container = document.getElementById('chatMessages');
            
            // æŒ‰æ—¶é—´æ’åº
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            container.innerHTML = messages.map(msg => `
                <div class="chat-message ${msg.senderType === 'user' ? 'user' : 'support'}">
                    ${msg.content}
                    <div class="chat-message-time">${formatTime(msg.createdAt)}</div>
                </div>
            `).join('');
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                scrollChatToBottom();
            }, 100);
        }
        
        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) {
                return;
            }
            
            if (!currentChatSession) {
                await loadOrCreateChatSession();
            }
            
            try {
                // å‘é€æ¶ˆæ¯
                const response = await fetch(`${API_BASE_URL}/chats/${currentChatSession.id}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: message,
                        senderType: 'user',
                        senderId: currentUser.username
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    input.value = '';
                    
                    // é‡æ–°åŠ è½½æ¶ˆæ¯
                    await loadUserChatMessages(currentChatSession.id);
                    
                    // å¦‚æœæ˜¯ç®¡ç†å‘˜æˆ–å®¢æœï¼Œåˆ·æ–°ä¼šè¯åˆ—è¡¨
                    if (currentUser.isAdmin || currentUser.isSupport) {
                        await loadChatSessions();
                    }
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showMessage('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // å¤„ç†èŠå¤©è¾“å…¥æ¡†æŒ‰é”®
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
        
        // æ»šåŠ¨èŠå¤©åˆ°åº•éƒ¨
        function scrollChatToBottom() {
            const chatBody = document.getElementById('chatBody');
            chatBody.scrollTop = chatBody.scrollHeight;
        }
        
        // æ¸…é™¤æœªè¯»é€šçŸ¥
        function clearUnreadNotification() {
            chatUnreadCount = 0;
            updateUnreadNotification();
        }
        
        // æ ‡è®°èŠå¤©ä¸ºå·²è¯»
        async function markChatAsRead(chatId) {
            try {
                await fetch(`${API_BASE_URL}/chats/${chatId}/read`, {
                    method: 'POST'
                });
            } catch (error) {
                console.error('æ ‡è®°å·²è¯»å¤±è´¥:', error);
            }
        }
        
        // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
        function addSystemMessage(text) {
            const container = document.getElementById('chatMessages');
            container.innerHTML += `
                <div class="chat-message support">
                    ${text}
                    <div class="chat-message-time">åˆšåˆš</div>
                </div>
            `;
            scrollChatToBottom();
        }
        
        // ========== ç®¡ç†å‘˜èŠå¤©ç®¡ç†åŠŸèƒ½ ==========
        
        // æ¸²æŸ“ç®¡ç†å‘˜èŠå¤©ä¼šè¯åˆ—è¡¨
        function renderAdminChatSessions() {
            const container = document.getElementById('chatSessions');
            const sessionCount = document.getElementById('sessionCount');
            
            if (!data.chats || data.chats.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">æš‚æ— èŠå¤©ä¼šè¯</div>';
                sessionCount.textContent = '0';
                return;
            }
            
            // æŒ‰æœ€åæ¶ˆæ¯æ—¶é—´å€’åºæ’åˆ—
            data.chats.sort((a, b) => {
                const timeA = new Date(a.lastMessageTime || a.createdAt);
                const timeB = new Date(b.lastMessageTime || b.createdAt);
                return timeB - timeA;
            });
            
            sessionCount.textContent = data.chats.length;
            
            container.innerHTML = data.chats.map(chat => `
                <div class="chat-session ${adminCurrentChatId === chat.id ? 'active' : ''}" onclick="selectAdminChat(${chat.id})">
                    <div class="session-info">
                        <div class="session-user">ğŸ‘¤ ${chat.userName || chat.userId}</div>
                        <div class="session-last-message">${chat.lastMessage || 'æš‚æ— æ¶ˆæ¯'}</div>
                        <div class="session-time">${formatTime(chat.lastMessageTime || chat.createdAt)}</div>
                    </div>
                    ${chat.unreadCount > 0 ? `<div class="session-unread">${chat.unreadCount}</div>` : ''}
                </div>
            `).join('');
        }
        
        // é€‰æ‹©èŠå¤©ä¼šè¯
        async function selectAdminChat(chatId) {
            adminCurrentChatId = chatId;
            renderAdminChatSessions();
            
            // æ˜¾ç¤ºèŠå¤©ç•Œé¢
            const chat = data.chats.find(c => c.id === chatId);
            if (chat) {
                document.getElementById('adminChatHeader').innerHTML = `
                    <div>
                        <div style="font-weight: bold;">ğŸ‘¤ ${chat.userName || chat.userId}</div>
                        <div style="font-size: 12px; color: #666;">æœ€åæ´»è·ƒï¼š${formatTime(chat.lastMessageTime || chat.createdAt)}</div>
                    </div>
                    <button class="btn btn-blue btn-sm" onclick="markChatAsRead(${chatId})">æ ‡ä¸ºå·²è¯»</button>
                `;
                
                document.getElementById('adminChatInput').style.display = 'flex';
                
                // åŠ è½½æ¶ˆæ¯
                await loadAdminChatMessages(chatId);
                
                // æ ‡è®°ä¸ºå·²è¯»
                await markChatAsRead(chatId);
            }
        }
        
        // åŠ è½½ç®¡ç†å‘˜èŠå¤©æ¶ˆæ¯
        async function loadAdminChatMessages(chatId) {
            try {
                const response = await fetch(`${API_BASE_URL}/chats/${chatId}/messages`);
                const result = await response.json();
                
                if (result.success) {
                    const messages = result.data || [];
                    renderAdminChatMessages(messages);
                }
            } catch (error) {
                console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
            }
        }
        
        // æ¸²æŸ“ç®¡ç†å‘˜èŠå¤©æ¶ˆæ¯
        function renderAdminChatMessages(messages) {
            const container = document.getElementById('adminChatMessages');
            
            // æŒ‰æ—¶é—´æ’åº
            messages.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
            
            container.innerHTML = messages.map(msg => `
                <div class="chat-message ${msg.senderType === 'user' ? 'support' : 'user'}" style="margin-bottom: 10px;">
                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
                        ${msg.senderType === 'user' ? 'ğŸ‘¤ ç”¨æˆ·' : 'ğŸ’ å®¢æœ'}
                    </div>
                    ${msg.content}
                    <div class="chat-message-time">${formatTime(msg.createdAt)}</div>
                </div>
            `).join('');
            
            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            setTimeout(() => {
                const adminChatMessages = document.getElementById('adminChatMessages');
                adminChatMessages.scrollTop = adminChatMessages.scrollHeight;
            }, 100);
        }
        
        // å‘é€ç®¡ç†å‘˜èŠå¤©æ¶ˆæ¯
        async function sendAdminChatMessage() {
            const input = document.getElementById('adminChatInputField');
            const message = input.value.trim();
            
            if (!message || !adminCurrentChatId) {
                return;
            }
            
            try {
                // å‘é€æ¶ˆæ¯
                const response = await fetch(`${API_BASE_URL}/chats/${adminCurrentChatId}/message`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        content: message,
                        senderType: 'support',
                        senderId: 'admin'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // æ¸…ç©ºè¾“å…¥æ¡†
                    input.value = '';
                    
                    // é‡æ–°åŠ è½½æ¶ˆæ¯
                    await loadAdminChatMessages(adminCurrentChatId);
                    
                    // åˆ·æ–°ä¼šè¯åˆ—è¡¨
                    await loadChatSessions();
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                showMessage('å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // å¤„ç†ç®¡ç†å‘˜èŠå¤©è¾“å…¥æ¡†æŒ‰é”®
        function handleAdminChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendAdminChatMessage();
            }
        }
        
        // åˆ·æ–°èŠå¤©ä¼šè¯
        function refreshChatSessions() {
            loadChatSessions();
            showMessage('èŠå¤©ä¼šè¯å·²åˆ·æ–°');
        }
        
        // æ ‡è®°æ‰€æœ‰æ¶ˆæ¯ä¸ºå·²è¯»
        async function markAllAsRead() {
            try {
                const response = await fetch(`${API_BASE_URL}/chats/mark-all-read`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadChatSessions();
                    showMessage('æ‰€æœ‰æ¶ˆæ¯å·²æ ‡è®°ä¸ºå·²è¯»');
                }
            } catch (error) {
                console.error('æ ‡è®°æ‰€æœ‰å·²è¯»å¤±è´¥:', error);
                showMessage('æ“ä½œå¤±è´¥', 'error');
            }
        }
        
        // ========== å®¢æœæ¸ é“ç®¡ç†åŠŸèƒ½ ==========
        async function addService() {
            const type = document.getElementById('serviceType').value;
            const name = document.getElementById('serviceName').value.trim();
            const link = document.getElementById('serviceLink').value.trim();
            
            if (!name || !link) {
                showMessage('è¯·å¡«å†™å®¢æœåç§°å’Œé“¾æ¥ï¼', 'error');
                return;
            }
            
            if (!link.startsWith('http://') && !link.startsWith('https://')) {
                showMessage('é“¾æ¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥http://æˆ–https://å¼€å¤´', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/services/add`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        type, 
                        name, 
                        link,
                        enabled: true 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    
                    document.getElementById('serviceName').value = '';
                    document.getElementById('serviceLink').value = '';
                    
                    renderServices();
                    renderCustomerService();
                    showMessage('å®¢æœæ¸ é“æ·»åŠ æˆåŠŸï¼');
                } else {
                    showMessage(result.error || 'æ·»åŠ å®¢æœæ¸ é“å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('æ·»åŠ å®¢æœæ¸ é“å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        function renderServices() {
            const container = document.getElementById('servicesList');
            
            if (!data.services || data.services.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">æš‚æ— å®¢æœæ¸ é“</div>';
                return;
            }
            
            container.innerHTML = data.services.map(service => `
                <div style="border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 18px;">
                                ${getServiceIcon(service.type)}
                            </div>
                            <div>
                                <div style="font-weight: bold;">${service.name}</div>
                                <div style="color: #666; font-size: 14px;">${getServiceTypeText(service.type)}</div>
                            </div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <label style="font-size: 14px; display: flex; align-items: center; gap: 5px;">
                                <input type="checkbox" ${service.enabled ? 'checked' : ''} 
                                       onchange="toggleService(${service.id}, this.checked)">
                                å¯ç”¨
                            </label>
                        </div>
                    </div>
                    <div style="color: #666; font-size: 14px; margin-bottom: 10px; word-break: break-all;">
                        é“¾æ¥ï¼š<a href="${service.link}" target="_blank" style="color: #007bff;">${service.link}</a>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-gray" onclick="editService(${service.id})">ç¼–è¾‘</button>
                        <button class="btn btn-red" onclick="deleteService(${service.id})">åˆ é™¤</button>
                    </div>
                </div>
            `).join('');
        }
        
        async function toggleService(serviceId, enabled) {
            try {
                const service = data.services.find(s => s.id === serviceId);
                if (!service) {
                    showMessage('å®¢æœæ¸ é“ä¸å­˜åœ¨ï¼', 'error');
                    return;
                }
                
                const response = await fetch(`${API_BASE_URL}/services/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id: serviceId,
                        enabled: enabled 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderServices();
                    renderCustomerService();
                    showMessage(`å®¢æœæ¸ é“å·²${enabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                } else {
                    showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                showMessage('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function editService(serviceId) {
            const service = data.services.find(s => s.id === serviceId);
            if (!service) {
                showMessage('å®¢æœæ¸ é“ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            const newName = prompt('è¯·è¾“å…¥æ–°çš„å®¢æœæ¸ é“åç§°ï¼š', service.name);
            if (newName === null) return;
            
            const newLink = prompt('è¯·è¾“å…¥æ–°çš„å®¢æœé“¾æ¥ï¼š', service.link);
            if (newLink === null) return;
            
            if (!newLink.startsWith('http://') && !newLink.startsWith('https://')) {
                showMessage('é“¾æ¥æ ¼å¼ä¸æ­£ç¡®ï¼Œè¯·ä»¥http://æˆ–https://å¼€å¤´', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/services/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        id: serviceId,
                        name: newName.trim(),
                        link: newLink.trim()
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderServices();
                    renderCustomerService();
                    showMessage('å®¢æœæ¸ é“ä¿¡æ¯å·²æ›´æ–°');
                } else {
                    showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                showMessage('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        async function deleteService(serviceId) {
            const service = data.services.find(s => s.id === serviceId);
            if (!service) {
                showMessage('å®¢æœæ¸ é“ä¸å­˜åœ¨ï¼', 'error');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦åˆ é™¤å®¢æœæ¸ é“ "${service.name}" å—ï¼Ÿ`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/services/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: serviceId })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderServices();
                    renderCustomerService();
                    showMessage('å®¢æœæ¸ é“å·²åˆ é™¤');
                } else {
                    showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
                }
            } catch (error) {
                showMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        function renderCustomerService() {
            const serviceContainer = document.getElementById('customerService');
            const serviceButtons = document.getElementById('serviceButtons');
            
            const enabledServices = data.services.filter(service => service.enabled !== false);
            
            if (!data.settings.enableService || enabledServices.length === 0) {
                serviceContainer.style.display = 'none';
                return;
            }
            
            serviceContainer.style.display = 'block';
            serviceButtons.innerHTML = enabledServices.map(service => `
                <a href="${service.link}" target="_blank" class="service-btn ${service.type}">
                    ${getServiceIcon(service.type)} ${service.name}
                </a>
            `).join('');
        }
        
        function getServiceIcon(type) {
            const icons = {
                whatsapp: 'ğŸ“±',
                wechat: 'ğŸ’¬',
                facebook: 'ğŸ“˜',
                telegram: 'âœˆï¸',
                phone: 'ğŸ“',
                other: 'ğŸ’'
            };
            return icons[type] || 'ğŸ’';
        }
        
        function getServiceTypeText(type) {
            const texts = {
                whatsapp: 'WhatsApp',
                wechat: 'å¾®ä¿¡',
                facebook: 'Facebook',
                telegram: 'Telegram',
                phone: 'ç”µè¯',
                other: 'å…¶ä»–'
            };
            return texts[type] || 'å…¶ä»–';
        }
        
        // ========== ç³»ç»Ÿè®¾ç½® ==========
        function loadSettings() {
            if (data.settings) {
                document.getElementById('settingStoreName').value = data.settings.storeName || '';
                document.getElementById('settingKuaishouLink').value = data.settings.kuaishouLink || '';
                document.getElementById('settingEnableService').checked = data.settings.enableService !== false;
                
                if (data.settings.storeName) {
                    document.getElementById('storeTitle').textContent = data.settings.storeName;
                }
            }
        }
        
        async function saveSettings() {
            const storeName = document.getElementById('settingStoreName').value;
            const kuaishouLink = document.getElementById('settingKuaishouLink').value;
            const enableService = document.getElementById('settingEnableService').checked;
            
            try {
                const response = await fetch(`${API_BASE_URL}/settings/update`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        storeName, 
                        kuaishouLink, 
                        enableService 
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await loadAllData();
                    renderCustomerService();
                    showMessage('è®¾ç½®ä¿å­˜æˆåŠŸ');
                } else {
                    showMessage(result.error || 'ä¿å­˜è®¾ç½®å¤±è´¥ï¼', 'error');
                }
            } catch (error) {
                showMessage('ä¿å­˜è®¾ç½®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
            }
        }
        
        // ========== è¾…åŠ©å‡½æ•° ==========
        function getStatusText(status) {
            const statusMap = {
                pending: 'å¾…ä»˜æ¬¾',
                paid: 'å·²ä»˜æ¬¾',
                completed: 'å·²å®Œæˆ',
                cancelled: 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        function formatTime(timestamp) {
            if (!timestamp) return 'æœªçŸ¥æ—¶é—´';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / (1000 * 60));
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            
            if (diffMins < 1) {
                return 'åˆšåˆš';
            } else if (diffMins < 60) {
                return `${diffMins}åˆ†é’Ÿå‰`;
            } else if (diffHours < 24) {
                return `${diffHours}å°æ—¶å‰`;
            } else if (diffDays < 7) {
                return `${diffDays}å¤©å‰`;
            } else {
                return date.toLocaleDateString('zh-CN');
            }
        }
        
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message active`;
            messageEl.style.background = type === 'error' ? '#ff4444' : 
                                      type === 'warning' ? '#ff9800' : 
                                      type === 'info' ? '#2196F3' : '#000000';
            
            setTimeout(() => {
                messageEl.classList.remove('active');
            }, 3000);
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        function showStorePage() {
            showPage('storePage');
            document.getElementById('currentUser').textContent = currentUser ? currentUser.username : 'ç”¨æˆ·';
            updateUserRoleDisplay();
            renderProducts();
            renderCustomerService();
        }
        
        function showAdminPage() {
            if (!currentUser || !currentUser.isAdmin) {
                showMessage('éœ€è¦ç®¡ç†å‘˜æƒé™ï¼', 'error');
                return;
            }
            showPage('adminPage');
            switchTab('products');
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab + 'Tab').classList.add('active');
            
            if (tab === 'products') {
                renderAdminProducts();
            } else if (tab === 'orders') {
                currentOrderFilter = 'all';
                renderOrders();
            } else if (tab === 'chat') {
                loadChatSessions();
            } else if (tab === 'services') {
                renderServices();
            } else if (tab === 'supportAccounts') {
                loadSupportAccounts();
            } else if (tab === 'settings') {
                loadSettings();
            }
        }
        
        function logout() {
            currentUser = null;
            shoppingCart = [];
            localStorage.removeItem('mallCurrentUser');
            showPage('loginPage');
            showMessage('å·²é€€å‡ºç™»å½•');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // åˆå§‹åŒ–
        renderProducts();
        renderCustomerService();
    </script>
</body>
</html>
