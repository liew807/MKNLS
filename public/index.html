<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MKNLS工具平台V3.0</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    :root {
        --primary-blue: #0066ff;
        --cyber-blue: #00f3ff;
        --cyber-pink: #ff00ff;
        --cyber-purple: #9d00ff;
        --cyber-green: #00ff9d;
        --cyber-red: #ff0055;
        --cyber-yellow: #ffff00;
        --dark-bg: #0a0a14;
        --card-bg: rgba(20, 20, 40, 0.9);
        --glass-border: rgba(0, 243, 255, 0.2);
        --glow-blue: 0 0 15px rgba(0, 243, 255, 0.5);
        --glow-pink: 0 0 15px rgba(255, 0, 255, 0.5);
    }

    body {
        background: linear-gradient(135deg, #0a0a14 0%, #12122a 50%, #0a0a14 100%);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px 16px;
        color: #ffffff;
        position: relative;
        overflow-x: hidden;
    }

    /* 动态背景效果 */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: 
            radial-gradient(circle at 20% 20%, rgba(0, 243, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 80% 80%, rgba(255, 0, 255, 0.1) 0%, transparent 50%),
            radial-gradient(circle at 40% 60%, rgba(157, 0, 255, 0.1) 0%, transparent 50%);
        z-index: 0;
        pointer-events: none;
    }

    /* 网格背景 */
    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
        background-size: 40px 40px;
        z-index: 0;
        pointer-events: none;
    }

    .cyber-container {
        width: 100%;
        max-width: 500px;
        position: relative;
        z-index: 10;
        margin: 0 auto;
    }

    /* 标题区域 */
    .cyber-header {
        text-align: center;
        margin-bottom: 30px;
        padding: 30px 20px;
        background: rgba(20, 20, 40, 0.8);
        border-radius: 20px;
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .cyber-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 200%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(0, 243, 255, 0.1),
            rgba(255, 0, 255, 0.1),
            transparent
        );
        animation: scan 4s linear infinite;
    }

    @keyframes scan {
        0% { transform: translateX(-50%); }
        100% { transform: translateX(50%); }
    }

    .main-title {
        font-size: 3rem;
        font-weight: 900;
        margin-bottom: 15px;
        background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-pink), var(--cyber-purple));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        background-size: 200% 200%;
        animation: titleGlow 3s ease infinite;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .sub-title {
        font-size: 1.2rem;
        color: rgba(255, 255, 255, 0.7);
        letter-spacing: 4px;
        text-transform: uppercase;
        position: relative;
        display: inline-block;
        padding: 0 15px;
    }

    .sub-title::before,
    .sub-title::after {
        content: '✦';
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        color: var(--cyber-blue);
        animation: sparkle 2s ease-in-out infinite;
    }

    .sub-title::before { left: 0; }
    .sub-title::after { right: 0; }

    @keyframes sparkle {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.3; }
    }

    /* 功能卡片 */
    .cyber-card {
        background: rgba(20, 20, 40, 0.9);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        border: 1px solid var(--glass-border);
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        overflow: hidden;
    }

    .cyber-card::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, 
            var(--cyber-blue), 
            var(--cyber-pink), 
            var(--cyber-purple));
        animation: borderGlow 2s linear infinite;
    }

    @keyframes borderGlow {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    /* 快手入口按钮 */
    .kuaishou-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 100%;
        padding: 18px;
        border: none;
        border-radius: 15px;
        background: linear-gradient(135deg, 
            rgba(255, 0, 92, 0.9), 
            rgba(255, 122, 0, 0.9),
            rgba(255, 215, 0, 0.9));
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        margin-bottom: 15px;
        position: relative;
        overflow: hidden;
    }

    .kuaishou-btn::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, 
            transparent 30%, 
            rgba(255, 255, 255, 0.1) 50%, 
            transparent 70%);
        transform: rotate(45deg);
        animation: shine 3s linear infinite;
    }

    @keyframes shine {
        0% { transform: translateX(-100%) rotate(45deg); }
        100% { transform: translateX(100%) rotate(45deg); }
    }

    .kuaishou-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(255, 0, 92, 0.4);
    }

    /* Telegram按钮 */
    .tg-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        width: 100%;
        padding: 18px;
        border: none;
        border-radius: 15px;
        background: linear-gradient(135deg, 
            rgba(0, 136, 204, 0.9), 
            rgba(52, 170, 223, 0.9));
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        margin-bottom: 15px;
    }

    .tg-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 30px rgba(0, 136, 204, 0.4);
    }

    /* 状态信息 */
    .cyber-status {
        text-align: center;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 15px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        background: rgba(0, 243, 255, 0.1);
        border: 1px solid rgba(0, 243, 255, 0.3);
        color: var(--cyber-blue);
        position: relative;
        overflow: hidden;
    }

    .cyber-status::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, 
            transparent, 
            rgba(0, 243, 255, 0.2), 
            transparent);
        animation: statusScan 2s infinite;
    }

    @keyframes statusScan {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    .cyber-status.error {
        background: rgba(255, 0, 85, 0.1);
        border: 1px solid rgba(255, 0, 85, 0.3);
        color: var(--cyber-red);
    }

    .cyber-status.success {
        background: rgba(0, 255, 157, 0.1);
        border: 1px solid rgba(0, 255, 157, 0.3);
        color: var(--cyber-green);
    }

    .cyber-status.admin {
        background: rgba(157, 0, 255, 0.1);
        border: 1px solid rgba(157, 0, 255, 0.3);
        color: var(--cyber-purple);
    }

    /* 输入框样式 */
    .cyber-input {
        width: 100%;
        padding: 18px;
        margin-bottom: 15px;
        border: 2px solid rgba(0, 243, 255, 0.3);
        border-radius: 12px;
        background: rgba(10, 10, 20, 0.8);
        font-size: 16px;
        transition: all 0.3s ease;
        outline: none;
        color: white;
        font-family: 'Inter', monospace;
    }

    .cyber-input:focus {
        border-color: var(--cyber-blue);
        background: rgba(10, 10, 20, 0.9);
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
    }

    .cyber-input::placeholder {
        color: rgba(255, 255, 255, 0.5);
    }

    /* 按钮样式 */
    .cyber-button {
        width: 100%;
        padding: 18px;
        border: none;
        border-radius: 12px;
        background: linear-gradient(135deg, 
            rgba(0, 243, 255, 0.9), 
            rgba(157, 0, 255, 0.9));
        color: white;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-bottom: 10px;
        position: relative;
        overflow: hidden;
        letter-spacing: 1px;
        text-transform: uppercase;
    }

    .cyber-button:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0, 243, 255, 0.3);
    }

    .cyber-button:active {
        transform: translateY(-1px);
    }

    .cyber-button.secondary {
        background: linear-gradient(135deg, 
            rgba(255, 0, 255, 0.9), 
            rgba(255, 0, 85, 0.9));
    }

    .cyber-button.success {
        background: linear-gradient(135deg, 
            rgba(0, 255, 157, 0.9), 
            rgba(0, 200, 255, 0.9));
    }

    .cyber-button:disabled {
        background: rgba(100, 100, 100, 0.3);
        color: rgba(255, 255, 255, 0.5);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* 语言选择器 */
    .language-selector {
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 1000;
    }

    .language-dropdown {
        background: rgba(20, 20, 40, 0.9);
        border: 1px solid var(--glass-border);
        border-radius: 8px;
        padding: 8px 12px;
        color: var(--cyber-blue);
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        backdrop-filter: blur(10px);
        min-width: 120px;
    }

    .language-dropdown option {
        background: var(--dark-bg);
        color: white;
    }

    /* 过期时间显示 */
    .expiry-display {
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background: rgba(0, 243, 255, 0.1);
        border-radius: 12px;
        border: 1px solid rgba(0, 243, 255, 0.3);
        color: var(--cyber-blue);
        font-size: 14px;
        line-height: 1.4;
    }

    .blinking-expiry {
        animation: blink 2s infinite;
        font-weight: bold;
        color: var(--cyber-red);
        margin-top: 10px;
    }

    @keyframes blink {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    /* 绑定信息 */
    .bind-info {
        text-align: center;
        margin: 15px 0;
        padding: 12px;
        background: rgba(255, 149, 0, 0.1);
        border-radius: 10px;
        border: 1px solid rgba(255, 149, 0, 0.3);
        color: #FF9500;
        font-size: 14px;
        font-weight: 500;
    }

    /* 导航按钮 */
    .nav-buttons {
        display: flex;
        gap: 10px;
        margin: 20px 0;
    }

    .nav-buttons button {
        flex: 1;
        padding: 14px;
        font-size: 14px;
    }

    /* 管理面板 */
    .admin-panel {
        border-top: 1px solid rgba(0, 243, 255, 0.3);
        padding-top: 25px;
        margin-top: 25px;
    }

    .admin-title {
        text-align: center;
        font-size: 22px;
        font-weight: 700;
        margin-bottom: 20px;
        background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-pink));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-transform: uppercase;
    }

    .admin-level-badge {
        background: linear-gradient(45deg, var(--cyber-pink), var(--cyber-purple));
        color: white;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        margin-left: 10px;
    }

    /* 日志容器 */
    .log-container {
        width: 100%;
        max-width: 500px;
        background: rgba(20, 20, 40, 0.8);
        backdrop-filter: blur(20px);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid var(--glass-border);
        max-height: 250px;
        overflow-y: auto;
        margin-top: 20px;
    }

    .log-title {
        color: var(--cyber-green);
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        text-align: center;
        text-transform: uppercase;
        letter-spacing: 2px;
    }

    .log-item {
        font-size: 13px;
        padding: 6px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        line-height: 1.4;
        color: rgba(255, 255, 255, 0.8);
    }

    .log-item:last-child {
        border-bottom: none;
    }

    /* 响应式设计 */
    @media (max-width: 480px) {
        body {
            padding: 15px 12px;
        }
        
        .main-title {
            font-size: 2.2rem;
        }
        
        .sub-title {
            font-size: 1rem;
            letter-spacing: 2px;
        }
        
        .cyber-card {
            padding: 20px;
            border-radius: 15px;
        }
        
        .cyber-input {
            padding: 15px;
            font-size: 15px;
        }
        
        .cyber-button {
            padding: 15px;
            font-size: 15px;
        }
        
        .language-selector {
            position: relative;
            top: 0;
            right: 0;
            margin: 0 auto 15px;
            display: flex;
            justify-content: center;
        }
        
        .language-dropdown {
            width: 140px;
        }
    }

    /* 滚动条样式 */
    ::-webkit-scrollbar {
        width: 8px;
    }

    ::-webkit-scrollbar-track {
        background: rgba(20, 20, 40, 0.5);
        border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
        background: linear-gradient(45deg, var(--cyber-blue), var(--cyber-purple));
        border-radius: 4px;
    }

    /* 加载动画 */
    .cyber-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 243, 255, 0.3);
        border-radius: 50%;
        border-top-color: var(--cyber-blue);
        animation: spin 1s linear infinite;
        margin-right: 8px;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 版本徽章 */
    .version-badge {
        display: inline-block;
        padding: 6px 15px;
        background: rgba(0, 243, 255, 0.2);
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        color: var(--cyber-blue);
        margin-top: 10px;
        border: 1px solid rgba(0, 243, 255, 0.3);
    }
</style>
</head>
<body>
    <!-- 语言选择器 -->
    <div class="language-selector">
        <select id="languageSelect" class="language-dropdown" onchange="changeLanguage(this.value)">
            <option value="zh-CN">中文简体</option>
            <option value="zh-TW">中文繁體</option>
            <option value="en">English</option>
        </select>
    </div>

    <div class="cyber-container">
        <!-- 标题区域 -->
        <div class="cyber-header">
            <h1 class="main-title">MKNLS工具平台V3.0</h1>
            <div class="sub-title">SSM认证工具平台</div>
            <div class="version-badge">
                <i class="fas fa-code"></i>cpm专业平台v3.0 <i class="fas fa-bolt"></i>
            </div>
        </div>

        <!-- 快捷入口 -->
        <div style="margin-bottom: 20px;">
            <a href="https://v.kuaishou.com/n5k2Q5FF" target="_blank" class="kuaishou-btn">
                <i class="fas fa-play-circle"></i>
                快手联系Jack
                <i class="fas fa-external-link-alt"></i>
            </a>
            
            <a href="https://t.me/cpmMKNLS" target="_blank" class="tg-btn">
                <i class="fab fa-telegram"></i>
                加入MKNLS Telegram频道
            </a>
        </div>

        <!-- 主功能卡片 -->
        <div class="cyber-card">
            <!-- 状态信息 -->
            <div id="statusMessage" class="cyber-status">
                <i class="fas fa-microchip"></i> 系统就绪，请输入秘钥验证
            </div>

            <!-- 导航按钮 -->
            <div id="navButtons" style="display: none;">
                <div class="nav-buttons">
                    <button class="cyber-button secondary" onclick="handleReturnHome()" id="btnHome">
                        <i class="fas fa-home"></i> 首页
                    </button>
                    <button class="cyber-button secondary" onclick="handleSwitchAccount()" id="btnSwitchAccount">
                        <i class="fas fa-sync-alt"></i> 切换账号
                    </button>
                    <button class="cyber-button secondary" onclick="handleSwitchKey()" id="btnSwitchKey">
                        <i class="fas fa-key"></i> 切换秘钥
                    </button>
                </div>
            </div>

            <!-- 管理员模式切换 -->
            <button id="toggleAdminModeBtn" style="display: none;" class="cyber-button secondary" onclick="toggleAdminMode()" id="btnToggleAdmin">
                <i class="fas fa-user-shield"></i> 切换管理员模式
            </button>
            
            <!-- 管理员选择 -->
            <div id="adminChoice" style="display: none;">
                <div class="cyber-status" style="margin-bottom: 20px;">
                    <i class="fas fa-terminal"></i> 请选择您要进入的模式
                </div>
                <button class="cyber-button" onclick="enterAdminPanel()" id="btnEnterAdmin">
                    <i class="fas fa-tools"></i> 进入管理员面板
                </button>
                <button class="cyber-button secondary" onclick="enterUserPanel()" id="btnEnterUser">
                    <i class="fas fa-user"></i> 进入用户功能
                </button>
            </div>

            <!-- 秘钥验证表单 -->
            <div id="keyForm">
                <div style="text-align: center; margin-bottom: 15px; color: rgba(255,255,255,0.7); font-size: 14px;">
                    <i class="fas fa-info-circle"></i> 秘钥请 Facebook搜索GH Tree获取
                </div>
                <input type="text" id="accessKey" class="cyber-input" placeholder="输入访问秘钥" maxlength="15">
                <div id="bindInfo" class="bind-info" style="display: none;"></div>
                <button class="cyber-button" onclick="handleCheckKey()" id="btnCheckKey">
                    <span id="checkKeyText"><i class="fas fa-shield-alt"></i> 验证秘钥</span>
                </button>
            </div>

            <!-- 登录表单 -->
            <div id="loginForm" style="display: none;">
                <div id="expiryDisplay" class="expiry-display">
                    <!-- 过期时间显示 -->
                </div>
                <input type="email" id="email" class="cyber-input" placeholder="输入您的邮箱">
                <input type="password" id="password" class="cyber-input" placeholder="输入您的密码">
                <button class="cyber-button success" onclick="handleLogin()" id="btnLogin">
                    <span id="loginText"><i class="fas fa-sign-in-alt"></i> 登录</span>
                </button>
            </div>

            <!-- 功能菜单 -->
            <div id="menuButtons" style="display: none;">
                <button class="cyber-button" onclick="handleKingRank()" id="btnKingRank">
                    <i class="fas fa-crown"></i> 一键修改为国王等级
                </button>
                <button class="cyber-button secondary" id="btnChangeEmail" onclick="handleChangeEmail()">
                    <i class="fas fa-envelope"></i> 修改邮箱
                </button>
                <button class="cyber-button secondary" id="btnChangePassword" onclick="handleChangePassword()">
                    <i class="fas fa-lock"></i> 修改密码
                </button>
            </div>
            
            <!-- 管理员面板 -->
            <div id="adminPanel" class="admin-panel" style="display: none;">
                <h4 class="admin-title" id="adminTitle">
                    <i class="fas fa-key"></i> 秘钥管理中心
                    <span id="adminLevelBadge" class="admin-level-badge"></span>
                </h4>

                <div class="add-key-form">
                    <!-- 测试卡选项 -->
                    <div style="background: rgba(255,0,85,0.1); padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 1px solid rgba(255,0,85,0.3);">
                        <label style="color: var(--cyber-red); display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="isTestCard" onchange="toggleTestCardOptions()" style="transform: scale(1.3);">
                            <span style="font-weight: 600;"><i class="fas fa-vial"></i> 生成测试卡</span>
                        </label>
                        <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-top: 5px; margin-left: 30px;">
                            1小时有效期，仅限1个账号，仅支持解锁成就功能
                        </div>
                    </div>

                    <!-- 普通秘钥选项 -->
                    <div id="normalKeyOptions">
                        <input type="number" id="newKeyDuration" class="cyber-input" placeholder="秘钥时长 (小时)" value="24" min="1">
                        <input type="number" id="newKeyMaxBind" class="cyber-input" placeholder="最大绑定数量" value="3" min="1">
                    </div>
                    
                    <input type="text" id="newKeyRemark" class="cyber-input" placeholder="备注 (如: 月卡/测试卡)">
                    <button class="cyber-button success" onclick="handleAddKey()" id="btnAddKey">
                        <i class="fas fa-plus"></i> <span id="addKeyText">生成新秘钥</span>
                    </button>
                </div>

                <!-- 管理按钮 -->
                <div class="nav-buttons" style="margin: 20px 0;">
                    <button class="cyber-button secondary" onclick="fetchKeys()" id="btnRefresh">
                        <i class="fas fa-sync-alt"></i> 刷新列表
                    </button>
                    <button class="cyber-button" style="background: linear-gradient(135deg, rgba(255,0,85,0.9), rgba(255,77,0,0.9));" onclick="handleCleanupExpiredKeys()" id="btnCleanup">
                        <i class="fas fa-trash"></i> 清理过期
                    </button>
                </div>

                <!-- 秘钥列表 -->
                <div style="background: rgba(10,10,20,0.8); border-radius: 12px; padding: 15px; border: 1px solid rgba(0,243,255,0.2);">
                    <div id="keyTables"></div>
                </div>
            </div>
        </div>

        <!-- 日志容器 -->
        <div class="log-container">
            <div class="log-title">
                <i class="fas fa-terminal"></i> 系统日志
            </div>
            <div id="logHistory">
                <div class="log-item" style="color: var(--cyber-green);">
                    <i class="fas fa-check-circle"></i> 系统启动完成
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript代码 -->
    <script>
        // ==================== 配置部分 ====================
        const API_BASE_URL = (() => {
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                return 'http://localhost:3000/api';
            }
            return '/api';
        })();

        const SUPER_ADMIN_KEY = 'cpmMKNLS';

        // ==================== 多语言支持 ====================
        const translations = {
            'zh-CN': {
                'statusReady': '系统就绪，请输入秘钥验证',
                'statusVerifying': '正在验证秘钥，请稍候...',
                'statusLoggingIn': '正在登录...',
                'statusSettingRank': '正在尝试设置国王等级...',
                'statusChangingEmail': '正在修改邮箱...',
                'statusChangingPassword': '正在修改密码...',
                'keyHint': '秘钥请 Facebook搜索GH Tree获取',
                'btnCheckKey': '验证秘钥',
                'btnLogin': '登录',
                'btnKingRank': '一键修改为国王等级',
                'btnChangeEmail': '修改邮箱',
                'btnChangePassword': '修改密码',
                'btnToggleAdmin': '切换管理员模式',
                'btnHome': '首页',
                'btnSwitchAccount': '切换账号',
                'btnSwitchKey': '切换秘钥',
                'btnEnterAdmin': '进入管理员面板',
                'btnEnterUser': '进入用户功能',
                'btnAddKey': '生成新秘钥',
                'btnRefresh': '刷新列表',
                'btnCleanup': '清理过期',
                'adminTitle': '秘钥管理中心',
                'testCardLabel': '生成测试卡',
                'testCardInfo': '1小时有效期，仅限1个账号，仅支持解锁成就功能',
                'superAdmin': '超级管理员',
                'normalAdmin': '普通管理员',
                'testCardBadge': '测试卡',
                'testCardStatus': '测试卡用户',
                'testCardEmailWarning': '测试卡不支持修改邮箱功能，请联系管理员付费使用完整功能！',
                'testCardPasswordWarning': '测试卡不支持修改密码功能，请联系管理员付费使用完整功能！'
            },
            'zh-TW': {
                'statusReady': '系統就緒，請輸入秘鑰驗證',
                'statusVerifying': '正在驗證秘鑰，請稍候...',
                'statusLoggingIn': '正在登錄...',
                'statusSettingRank': '正在嘗試設置國王等級...',
                'statusChangingEmail': '正在修改郵箱...',
                'statusChangingPassword': '正在修改密碼...',
                'keyHint': '秘鑰請Facebook搜索GH Tree獲取',
                'btnCheckKey': '驗證秘鑰',
                'btnLogin': '登錄',
                'btnKingRank': '一鍵修改為國王等級',
                'btnChangeEmail': '修改郵箱',
                'btnChangePassword': '修改密碼',
                'btnToggleAdmin': '切換管理員模式',
                'btnHome': '首頁',
                'btnSwitchAccount': '切換賬號',
                'btnSwitchKey': '切換秘鑰',
                'btnEnterAdmin': '進入管理員面板',
                'btnEnterUser': '進入用戶功能',
                'btnAddKey': '生成新秘鑰',
                'btnRefresh': '刷新列表',
                'btnCleanup': '清理過期',
                'adminTitle': '秘鑰管理中心',
                'testCardLabel': '生成測試卡',
                'testCardInfo': '1小時有效期，僅限1個賬號，僅支持解鎖成就功能',
                'superAdmin': '超級管理員',
                'normalAdmin': '普通管理員',
                'testCardBadge': '測試卡',
                'testCardStatus': '測試卡用戶',
                'testCardEmailWarning': '測試卡不支持修改郵箱功能，請聯繫管理員付費使用完整功能！',
                'testCardPasswordWarning': '測試卡不支持修改密碼功能，請聯繫管理員付費使用完整功能！'
            },
            'en': {
                'statusReady': 'System ready, please enter key to verify',
                'statusVerifying': 'Verifying key, please wait...',
                'statusLoggingIn': 'Logging in...',
                'statusSettingRank': 'Setting king rank...',
                'statusChangingEmail': 'Changing email...',
                'statusChangingPassword': 'Changing password...',
                'keyHint': 'Get key by searching GH Tree on Facebook',
                'btnCheckKey': 'Verify Key',
                'btnLogin': 'Login',
                'btnKingRank': 'Set King Rank',
                'btnChangeEmail': 'Change Email',
                'btnChangePassword': 'Change Password',
                'btnToggleAdmin': 'Toggle Admin Mode',
                'btnHome': 'Home',
                'btnSwitchAccount': 'Switch Account',
                'btnSwitchKey': 'Switch Key',
                'btnEnterAdmin': 'Enter Admin Panel',
                'btnEnterUser': 'Enter User Functions',
                'btnAddKey': 'Generate New Key',
                'btnRefresh': 'Refresh List',
                'btnCleanup': 'Clean Expired',
                'adminTitle': 'Key Management Center',
                'testCardLabel': 'Generate Test Card',
                'testCardInfo': '1 hour validity, 1 account only, unlock achievement only',
                'superAdmin': 'Super Admin',
                'normalAdmin': 'Normal Admin',
                'testCardBadge': 'Test Card',
                'testCardStatus': 'Test Card User',
                'testCardEmailWarning': 'Test card does not support email change. Please contact admin for paid full features!',
                'testCardPasswordWarning': 'Test card does not support password change. Please contact admin for paid full features!'
            }
        };

        // ==================== 全局变量 ====================
        let currentLanguage = 'zh-CN';
        let currentKey = null;
        let currentToken = null;
        let currentExpiryTime = null;
        let currentUser = null;
        let isAdminMode = false;
        let isSuperAdmin = false;
        let currentBindInfo = null;
        let isTestCard = false;

        // ==================== 工具函数 ====================
        function updateStatus(message, isError = false) {
            const statusEl = document.getElementById('statusMessage');
            const icon = isError ? 'fa-exclamation-circle' : 'fa-check-circle';
            statusEl.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
            
            if (isTestCard) {
                statusEl.className = 'cyber-status error';
            } else if (isAdminMode) {
                statusEl.className = 'cyber-status admin';
            } else {
                statusEl.className = 'cyber-status ' + (isError ? 'error' : 'success');
            }
        }

        function setButtonLoading(buttonId, loading) {
            const button = document.getElementById(buttonId);
            if (loading) {
                button.disabled = true;
                const originalText = button.querySelector('span').innerHTML;
                button.innerHTML = `<span><span class="cyber-spinner"></span>加载中...</span>`;
                button.setAttribute('data-original-text', originalText);
            } else {
                button.disabled = false;
                const originalText = button.getAttribute('data-original-text');
                if (originalText) {
                    button.innerHTML = originalText;
                }
            }
        }

        function logAction(action, message, type = 'info') {
            const logHistory = document.getElementById('logHistory');
            const now = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            
            let icon = 'fa-info-circle';
            let color = 'var(--cyber-blue)';
            
            switch(type) {
                case 'success': 
                    icon = 'fa-check-circle'; 
                    color = 'var(--cyber-green)';
                    break;
                case 'error': 
                    icon = 'fa-times-circle'; 
                    color = 'var(--cyber-red)';
                    break;
                case 'warning': 
                    icon = 'fa-exclamation-triangle'; 
                    color = 'var(--cyber-yellow)';
                    break;
            }
            
            const logItem = document.createElement('div');
            logItem.className = 'log-item';
            logItem.innerHTML = `<i class="fas ${icon}" style="color: ${color}; margin-right: 8px;"></i> ${now} [${action}] ${message}`;
            
            logHistory.prepend(logItem);
            
            // 保持日志数量在15条以内
            while (logHistory.children.length > 15) {
                logHistory.removeChild(logHistory.lastChild);
            }
        }

        // ==================== 核心功能函数 ====================
        async function handleCheckKey(key = null) {
            key = key || document.getElementById('accessKey').value.trim();
            if (!key) {
                updateStatus('请输入秘钥！', true);
                return;
            }
            
            setButtonLoading('btnCheckKey', true);
            updateStatus('正在验证秘钥，请稍候...', false);
            
            try {
                const email = document.getElementById('email') ? document.getElementById('email').value.trim() : null;
                
                const response = await fetch(`${API_BASE_URL}/check-key`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ key, email })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "验证失败");
                }
                
                // 保存当前秘钥信息
                currentKey = key;
                currentExpiryTime = data.expiryTime;
                isAdminMode = data.isAdmin;
                isSuperAdmin = data.isSuperAdmin || false;
                isTestCard = data.isTestCard || false;
                
                // 更新绑定信息显示
                updateBindInfo(data.bindCount, data.maxBind, data.remainingBinds);
                
                if (data.isAdmin) {
                    // 管理员模式
                    if (data.needsChoice) {
                        // 需要选择进入用户还是管理面板
                        document.getElementById('adminChoice').style.display = 'block';
                        document.getElementById('keyForm').style.display = 'none';
                        updateStatus(data.message, false);
                        logAction("管理员验证", "管理员模式选择", 'success');
                        return;
                    }
                    
                    // 直接进入管理员模式
                    document.getElementById('toggleAdminModeBtn').style.display = 'block';
                    updateStatus(data.message, false);
                    switchSection('menuButtons', ['keyForm', 'loginForm']);
                    logAction("管理员登录", `${isSuperAdmin ? '超级' : ''}管理员模式启用`, 'success');
                    
                } else {
                    // 普通用户模式
                    updateExpiryDisplay(data.expiryTime, data.durationHours, data.cardType);
                    
                    if (data.isEmailBound && email) {
                        updateStatus(`邮箱 ${email} 已绑定此秘钥，可以直接登录！`, false);
                    } else if (data.remainingBinds <= 0) {
                        updateStatus("秘钥绑定已满！但已绑定的账号仍可登录。", true);
                    } else {
                        updateStatus(data.message, false);
                    }
                    
                    switchSection('loginForm', ['keyForm', 'menuButtons']);
                    logAction("秘钥验证", "秘钥验证成功", 'success');
                }
                
            } catch (error) {
                updateStatus(`验证失败：${error.message}`, true);
                logAction("秘钥验证", `验证失败：${error.message}`, 'error');
            } finally {
                setButtonLoading('btnCheckKey', false);
            }
        }

        // ==================== 修复的登录函数 ====================
        async function handleLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;

            if (!email || !password) {
                updateStatus("请输入邮箱和密码！", true);
                return;
            }
            
            setButtonLoading('btnLogin', true);
            updateStatus("正在登录...", false);

            try {
                // 准备请求数据 - 确保传递 currentKey
                const requestData = {
                    email: email,
                    password: password,
                    key: currentKey  // 确保传递当前秘钥
                };

                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "登录失败");
                }

                currentToken = data.data.idToken;
                currentUser = data.data.email;
                
                // 保存到本地存储
                saveAuthToStorage(currentKey, currentToken, currentExpiryTime, currentUser);

                updateStatus("登录成功！进入功能菜单。", false);
                switchSection('menuButtons', ['keyForm', 'loginForm']);

                logAction("用户登录", `用户 ${currentUser} 登录成功`, 'success');

            } catch (error) {
                updateStatus(`登录失败：${error.message}`, true);
                logAction("用户登录", `登录失败：${error.message}`, 'error');
            } finally {
                setButtonLoading('btnLogin', false);
            }
        }

        // ==================== 其他功能函数 ====================
        async function handleKingRank() {
            if (!currentToken || !currentKey) {
                updateStatus("请先登录！", true);
                handleLogout(true);
                return;
            }

            logAction("等级设置", "开始尝试设置国王等级...", 'info');
            updateStatus("正在尝试设置国王等级...", false);

            try {
                const response = await fetch(`${API_BASE_URL}/king-rank`, {
                    method: "POST",
                    headers: { 
                        "Authorization": `Bearer ${currentToken}`
                    }
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "设置失败");
                }

                logAction("等级设置", "国王等级设置成功", 'success');
                updateStatus(data.message, false);

            } catch (error) {
                updateStatus(`等级设置失败：${error.message}`, true);
                logAction("等级设置", `设置失败: ${error.message}`, 'error');
            }
        }

        async function handleChangeEmail() {
            if (!currentToken || !currentKey) {
                updateStatus("请先登录！", true);
                handleLogout(true);
                return;
            }

            if (isTestCard) {
                alert("测试卡不支持修改邮箱功能，请联系管理员付费使用完整功能！");
                return;
            }

            const newEmail = prompt(`请输入新的邮箱地址（当前: ${currentUser}）：`);
            if (!newEmail) return;

            logAction("修改邮箱", `正在尝试修改邮箱至 ${newEmail}...`, 'info');
            updateStatus("正在修改邮箱...", false);

            try {
                const response = await fetch(`${API_BASE_URL}/change-email`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        idToken: currentToken,
                        newEmail: newEmail,
                        oldEmail: currentUser,
                        key: currentKey
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "修改失败");
                }

                currentToken = data.data.idToken;
                const oldUser = currentUser;
                currentUser = data.data.email;
                saveAuthToStorage(currentKey, currentToken, currentExpiryTime, currentUser);

                logAction("修改邮箱", `成功从 ${oldUser} 修改为 ${currentUser}`, 'success');
                updateStatus(`邮箱修改成功！新邮箱: ${currentUser}`, false);

            } catch (error) {
                updateStatus(`修改失败：${error.message}`, true);
                logAction("修改邮箱", `修改失败: ${error.message}`, 'error');
            }
        }

        async function handleChangePassword() {
            if (!currentToken || !currentKey) {
                updateStatus("请先登录！", true);
                handleLogout(true);
                return;
            }

            if (isTestCard) {
                alert("测试卡不支持修改密码功能，请联系管理员付费使用完整功能！");
                return;
            }

            const newPassword = prompt("请输入新密码（至少6位）：");
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                updateStatus("新密码长度不能少于6位！", true);
                return;
            }

            logAction("修改密码", "正在尝试修改密码...", 'info');
            updateStatus("正在修改密码...", false);

            try {
                const response = await fetch(`${API_BASE_URL}/change-password`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        idToken: currentToken,
                        newPassword: newPassword,
                        email: currentUser,
                        key: currentKey
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "修改失败");
                }

                currentToken = data.data.idToken;
                saveAuthToStorage(currentKey, currentToken, currentExpiryTime, currentUser);

                logAction("修改密码", "密码修改成功", 'success');
                updateStatus("密码修改成功！", false);

            } catch (error) {
                updateStatus(`修改失败：${error.message}`, true);
                logAction("修改密码", `修改失败: ${error.message}`, 'error');
            }
        }

        // ==================== 辅助函数 ====================
        function switchSection(showId, hideIds) {
            document.getElementById(showId).style.display = 'block';
            hideIds.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            if (showId !== 'keyForm') {
                document.getElementById('navButtons').style.display = 'block';
            } else {
                document.getElementById('navButtons').style.display = 'none';
            }
        }

        function updateBindInfo(bindCount, maxBind, remainingBinds) {
            const bindInfoEl = document.getElementById('bindInfo');
            if (bindCount !== undefined && maxBind !== undefined && remainingBinds !== undefined) {
                const bindText = `当前绑定: ${bindCount}/${maxBind} | 剩余: ${remainingBinds}`;
                bindInfoEl.textContent = bindText;
                bindInfoEl.style.display = 'block';
                
                if (remainingBinds <= 2) {
                    bindInfoEl.style.background = 'rgba(255, 0, 85, 0.1)';
                    bindInfoEl.style.borderColor = 'rgba(255, 0, 85, 0.3)';
                    bindInfoEl.style.color = '#ff6680';
                }
            } else {
                bindInfoEl.style.display = 'none';
            }
        }

        function updateExpiryDisplay(expiryTime, durationHours, cardType) {
            const displayEl = document.getElementById('expiryDisplay');
            if (!expiryTime) {
                displayEl.innerHTML = '';
                return;
            }
            
            let vipLevel = "";
            if (isTestCard) {
                vipLevel = "测试卡用户";
            } else if (cardType === 'DIAMOND_EXCLUSIVE') {
                vipLevel = "钻石VIP";
            } else if (durationHours >= 30 * 24) {
                vipLevel = "铂金VIP";
            } else if (durationHours >= 7 * 24) {
                vipLevel = "黄金VIP";
            } else if (durationHours >= 24) {
                vipLevel = "白银VIP";
            } else {
                vipLevel = "青铜VIP";
            }
            
            displayEl.innerHTML = `
                <div style="color: var(--cyber-green); margin-bottom: 10px;">
                    欢迎登录，<strong>${vipLevel}</strong>！
                </div>
                <div class="blinking-expiry">
                    <i class="fas fa-clock"></i> 秘钥将于 ${expiryTime} 到期
                </div>
            `;
        }

        function saveAuthToStorage(key, token, expiry, user) {
            localStorage.setItem('accessKey', key);
            localStorage.setItem('idToken', token);
            localStorage.setItem('expiryTime', expiry);
            localStorage.setItem('currentUser', user);
            localStorage.setItem('currentLanguage', currentLanguage);
        }

        function loadAuthFromStorage() {
            currentKey = localStorage.getItem('accessKey');
            currentToken = localStorage.getItem('idToken');
            currentExpiryTime = localStorage.getItem('expiryTime');
            currentUser = localStorage.getItem('currentUser');
            const savedLang = localStorage.getItem('currentLanguage');
            if (savedLang) {
                currentLanguage = savedLang;
                document.getElementById('languageSelect').value = currentLanguage;
            }
            return currentKey && currentToken;
        }

        // ==================== 管理员功能 ====================
        function enterAdminPanel() {
            document.getElementById('adminChoice').style.display = 'none';
            document.getElementById('menuButtons').style.display = 'block';
            document.getElementById('toggleAdminModeBtn').style.display = 'block';
            updateStatus("已进入管理员模式，点击上方按钮切换管理面板", false);
        }

        function enterUserPanel() {
            document.getElementById('adminChoice').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            updateStatus("请登录您的游戏账号使用功能", false);
        }

        function toggleAdminMode() {
            if (!isAdminMode) return;

            const isViewingAdmin = document.getElementById('adminPanel').style.display === 'block';
            
            if (isViewingAdmin) {
                document.getElementById('adminPanel').style.display = 'none';
                document.getElementById('menuButtons').style.display = 'block';
                updateStatus("已退出管理员面板", false);
            } else {
                document.getElementById('menuButtons').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'block';
                updateStatus("管理员面板已开启", false);
                fetchKeys();
            }
        }

        function toggleTestCardOptions() {
            const isTestCard = document.getElementById('isTestCard').checked;
            const normalOptions = document.getElementById('normalKeyOptions');
            
            if (isTestCard) {
                normalOptions.style.display = 'none';
                document.getElementById('newKeyDuration').value = 1;
                document.getElementById('newKeyMaxBind').value = 1;
            } else {
                normalOptions.style.display = 'block';
                document.getElementById('newKeyDuration').value = 24;
                document.getElementById('newKeyMaxBind').value = 3;
            }
        }

        // ==================== 事件监听 ====================
        document.addEventListener("DOMContentLoaded", () => {
            // 初始化
            const hasStored = loadAuthFromStorage();
            
            if (hasStored && currentKey) {
                updateStatus("发现上次登录状态，正在重新验证...", false);
                document.getElementById('accessKey').value = currentKey;
                handleCheckKey(currentKey);
            } else {
                switchSection('keyForm', ['loginForm', 'menuButtons']);
                updateStatus("系统就绪，请输入秘钥验证", false);
            }

            // 键盘事件
            document.getElementById('accessKey').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleCheckKey();
            });
            
            document.getElementById('password').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
        });

        // 语言切换
        function changeLanguage(lang) {
            currentLanguage = lang;
            localStorage.setItem('currentLanguage', lang);
            
            // 更新界面文字
            document.getElementById('statusMessage').innerHTML = `<i class="fas fa-microchip"></i> ${translations[lang].statusReady}`;
            document.getElementById('checkKeyText').innerHTML = `<i class="fas fa-shield-alt"></i> ${translations[lang].btnCheckKey}`;
            document.getElementById('loginText').innerHTML = `<i class="fas fa-sign-in-alt"></i> ${translations[lang].btnLogin}`;
            
            logAction("语言切换", `切换到 ${lang === 'zh-CN' ? '中文简体' : lang === 'zh-TW' ? '中文繁體' : 'English'}`, 'info');
        }

        // 导航功能
        function handleSwitchAccount() {
            currentUser = null;
            currentToken = null;
            localStorage.removeItem('idToken');
            localStorage.removeItem('currentUser');
            
            if (isAdminMode) {
                switchSection('loginForm', ['menuButtons', 'adminPanel']);
                updateStatus("请登录新的游戏账号", false);
            } else {
                switchSection('loginForm', ['menuButtons']);
                updateStatus("请登录新的游戏账号", false);
            }
            
            logAction("切换账号", "切换到新账号登录", 'info');
        }

        function handleSwitchKey() {
            handleLogout(true);
            updateStatus("请输入新的秘钥", false);
            logAction("切换秘钥", "切换到新秘钥输入", 'info');
        }

        function handleReturnHome() {
            if (isAdminMode) {
                document.getElementById('adminPanel').style.display = 'none';
                switchSection('menuButtons', ['keyForm', 'loginForm']);
            } else {
                switchSection('menuButtons', ['keyForm', 'loginForm']);
            }
            updateStatus("已返回主菜单", false);
            logAction("导航", "返回主菜单", 'info');
        }

        function handleLogout(silent = false) {
            localStorage.removeItem('accessKey');
            localStorage.removeItem('idToken');
            localStorage.removeItem('expiryTime');
            localStorage.removeItem('currentUser');
            
            currentUser = null;
            currentToken = null;
            currentKey = null;
            isAdminMode = false;
            isSuperAdmin = false;
            isTestCard = false;

            document.getElementById('accessKey').value = '';
            document.getElementById('email').value = '';
            document.getElementById('password').value = '';
            document.getElementById('toggleAdminModeBtn').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'none';
            updateBindInfo();
            
            switchSection('keyForm', ['loginForm', 'menuButtons']);

            if (!silent) {
                updateStatus("已成功退出登录，请重新验证秘钥", false);
                logAction("退出", "用户已退出登录", 'info');
            }
        }

        // 管理功能
        async function fetchKeys() {
            if (!isAdminMode) return;
            
            updateStatus("正在获取秘钥列表...", false);
            logAction("秘钥管理", "获取秘钥列表", 'info');

            try {
                const response = await fetch(`${API_BASE_URL}/admin/keys?key=${currentKey}`);
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "获取失败");
                }

                renderKeysTable(data.keys);
                updateStatus("成功获取秘钥信息", false);
                logAction("秘钥管理", "获取列表成功", 'success');

            } catch (error) {
                updateStatus(`获取列表失败：${error.message}`, true);
                logAction("秘钥管理", `获取列表失败：${error.message}`, 'error');
            }
        }

        function renderKeysTable(keysData) {
            // 这里需要根据您的后端返回的数据结构来渲染
            // 由于代码长度限制，这里只显示基本结构
            document.getElementById('keyTables').innerHTML = `
                <div style="color: rgba(255,255,255,0.7); text-align: center; padding: 20px;">
                    秘钥列表功能需要后端支持
                </div>
            `;
        }

        async function handleAddKey() {
            if (!isAdminMode) return;

            const isTestCard = document.getElementById('isTestCard').checked;
            const duration = parseInt(document.getElementById('newKeyDuration').value);
            const maxBind = parseInt(document.getElementById('newKeyMaxBind').value) || 3;
            const remark = document.getElementById('newKeyRemark').value.trim();

            if (!isTestCard && (isNaN(duration) || duration <= 0)) {
                alert("请输入有效的秘钥时长 (小时)");
                return;
            }

            logAction("秘钥管理", `正在生成${isTestCard ? '测试卡' : '秘钥'}...`, 'info');
            updateStatus("正在生成并新增秘钥...", false);

            try {
                const response = await fetch(`${API_BASE_URL}/admin/keys?key=${currentKey}`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ 
                        durationHours: duration, 
                        maxBind: maxBind, 
                        remark: remark,
                        isTestCard: isTestCard 
                    })
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "生成失败");
                }

                const successMessage = isTestCard ? 
                    `测试卡生成成功！\n秘钥: ${data.key}\n时长: 1 小时\n最大绑定: 1 个账号\n备注: ${remark || '测试卡'}` :
                    `秘钥生成成功！\n秘钥: ${data.key}\n时长: ${duration} 小时\n最大绑定: ${maxBind} 个账号\n备注: ${remark || '无'}`;
                
                alert(successMessage);
                
                logAction("秘钥管理", `成功生成${isTestCard ? '测试卡' : '秘钥'}: ${data.key}`, 'success');
                
                fetchKeys();

            } catch (error) {
                updateStatus(`新增秘钥失败：${error.message}`, true);
                logAction("秘钥管理", `新增秘钥失败：${error.message}`, 'error');
            }
        }

        async function handleCleanupExpiredKeys() {
            if (!isAdminMode) return;
            
            if (!confirm('确定要清理所有过期秘钥吗？此操作不可逆！')) return;

            logAction("秘钥管理", "正在清理过期秘钥...", 'info');
            updateStatus("正在清理过期秘钥...", false);

            try {
                const response = await fetch(`${API_BASE_URL}/admin/cleanup-expired-keys?key=${currentKey}`, {
                    method: "POST"
                });
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || "清理失败");
                }

                logAction("秘钥管理", data.message, 'success');
                updateStatus(data.message, false);
                
                fetchKeys();

            } catch (error) {
                updateStatus(`清理失败：${error.message}`, true);
                logAction("秘钥管理", `清理失败: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
